<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LHC Worship Prep ‚Äî Song Finder, Roster & Orders</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <base target="_top" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Lato:wght@300;400;600;700&family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    /* ==================== CSS VARIABLES ==================== */
    :root {
      --brand: #4a6da7;
      --brand-2: #6b9ac4;
      --ink: #1f2933;
      --paper: #f4f5fb;
      --accent: #f2e4c7;
      --border-subtle: rgba(0, 0, 0, 0.06);
      --card-radius: 18px;
      --shadow-soft: 0 20px 45px rgba(15, 35, 70, 0.18);
      --roster-teal: #14b8a6;
      --roster-teal-dark: #0d9488;
      --roster-teal-light: #2dd4bf;
    }

    /* ==================== BASE STYLES ==================== */
    html, body { height: 100%; margin: 0; }
    body {
      font-family: "Lato", system-ui, -apple-system, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at top left, rgba(106,154,196,0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(242,228,199,0.55), transparent 60%),
        var(--paper);
    }

    .font-cinzel { font-family: "Cinzel", serif; }
    .font-playfair { font-family: "Playfair Display", serif; }
    .font-poppins { font-family: "Poppins", sans-serif; }

    /* ==================== LAYOUT ==================== */
    .lhc-root {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 1.5rem;
      padding: 1.5rem;
    }
    @media (max-width: 1024px) {
      .lhc-root { grid-template-columns: 1fr; }
      #playlistSidebar { order: 2; }
      #main-content-container { order: 1; }
    }

    /* ==================== CARD STYLES ==================== */
    .lhc-card {
      border-radius: var(--card-radius);
      background: #ffffff;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(15,23,42,0.04);
    }

    .lhc-section-title {
      font-family: "Cinzel", serif;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* ==================== SIDEBAR ==================== */
    #playlistSidebar {
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.18), transparent 60%),
        linear-gradient(160deg, var(--brand) 0%, var(--brand-2) 45%, #354266 100%);
      color: #e5edf9;
    }

    /* ==================== BUTTON STYLES ==================== */
    .lhc-pill-button {
      border-radius: 999px;
      padding: 0.45rem 1rem;
      font-size: 0.78rem;
      font-weight: 600;
      border: 1px solid rgba(148,163,184,0.55);
      background: #ffffff;
      color: #374151;
      transition: all 170ms ease-out;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    .lhc-pill-button:hover {
      background: #f9fafb;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
    }
    .lhc-pill-button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }
    .lhc-pill-button-active {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border-color: rgba(255,255,255,0.7);
      color: #ffffff;
      box-shadow: 0 12px 30px rgba(46, 92, 155, 0.34);
    }

    /* ==================== SCROLLBARS ==================== */
    .lhc-scroll-y {
      scrollbar-width: thin;
      scrollbar-color: rgba(148,163,184,0.8) transparent;
    }
    .lhc-scroll-y::-webkit-scrollbar { width: 7px; }
    .lhc-scroll-y::-webkit-scrollbar-thumb {
      background-color: rgba(148,163,184,0.75);
      border-radius: 999px;
    }

    /* ==================== LOADER ==================== */
    #loadingIndicator {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #loadingIndicator.show { display: flex; }

    /* ==================== TOAST STYLES ==================== */
    .toast-notification {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      color: white;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 13px;
      font-family: "Poppins", sans-serif;
      z-index: 2000;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    .toast-notification.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast-notification.success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
    .toast-notification.error { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    .toast-notification.warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); }

    /* ==================== FORM STYLES ==================== */
    .form-input {
      width: 100%;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      padding: 12px 16px;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
      transition: all 0.2s ease;
      background: white;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.1);
    }
    .form-input::placeholder { color: #94a3b8; }
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    .form-textarea { min-height: 120px; resize: vertical; }
    
    /* Link count badge for multiple attachments */
    .link-count-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: white;
      font-size: 9px;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* ==================== SONG LIST VIEW ==================== */
    .song-list-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f1f5f9;
    }
    .song-list-item:hover {
      border-left-color: var(--brand);
      background: #f8fafc;
    }
    .song-list-item:last-child { border-bottom: none; }

    .meta-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    /* ==================== SEARCH SUGGESTIONS ==================== */
    #searchSuggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    #searchSuggestions.show { display: block; }
    .suggestion-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.15s;
    }
    .suggestion-item:hover { background: #f1f5f9; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item.active { background: #e0f2fe; }

    /* ==================== STAT TAB BUTTONS (NEW) ==================== */
    .stat-tab-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .stat-tab-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .stat-tab-btn.active {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.4);
      color: white;
      font-weight: 600;
    }
    .stat-song-item { font-size: 0.75rem; }
    .stat-song-item:hover { transform: translateX(2px); }

    /* ==================== CLICKABLE SONG TITLE (NEW) ==================== */
    .song-title-link {
      cursor: pointer;
      transition: color 0.15s ease;
    }
    .song-title-link:hover {
      color: #4a6da7;
      text-decoration: underline;
    }

    /* ==================== ROSTER HEADER CARD ==================== */
    .roster-header-card {
      background: rgba(255, 255, 255, 0.97);
      border-radius: 24px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    .roster-header-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 5px;
      background: linear-gradient(90deg, #0d9488, #14b8a6, #2dd4bf, #5eead4);
      background-size: 300% 100%;
      animation: rosterGradientShift 4s ease-in-out infinite;
    }
    @keyframes rosterGradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* ==================== ROSTER NAV BUTTONS ==================== */
    .roster-nav-btn {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(31, 41, 55, 0.4);
      color: white;
      font-size: 24px;
      font-weight: 700;
    }
    .roster-nav-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 20px rgba(31, 41, 55, 0.5);
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
    }

    /* ==================== ROSTER ACTION BUTTONS ==================== */
    .roster-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: "Poppins", sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .roster-action-btn.primary {
      background: linear-gradient(135deg, var(--roster-teal-dark) 0%, var(--roster-teal) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
    }
    .roster-action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(20, 184, 166, 0.4);
    }
    .roster-action-btn.secondary {
      background: linear-gradient(135deg, #5b6abf 0%, #7c5bb5 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(91, 106, 191, 0.3);
    }
    .roster-action-btn.secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(91, 106, 191, 0.4);
    }
    .roster-action-btn.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .roster-action-btn.danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    /* ==================== ROSTER TABLE CONTAINER ==================== */
    .roster-container {
      background: rgba(255, 255, 255, 0.97);
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.12);
    }
    .roster-table-wrapper { overflow-x: auto; }
    .roster-table-wrapper::-webkit-scrollbar { height: 10px; }
    .roster-table-wrapper::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
    .roster-table-wrapper::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--roster-teal), var(--roster-teal-dark));
      border-radius: 5px;
    }

    /* ==================== ROSTER TABLE ==================== */
    .roster-table {
      width: 100%;
      min-width: 900px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      font-family: "Poppins", sans-serif;
    }
    .roster-table th,
    .roster-table td {
      padding: 14px 12px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: middle;
    }
    .roster-table thead tr {
      background: linear-gradient(135deg, var(--roster-teal-dark) 0%, var(--roster-teal) 50%, var(--roster-teal-light) 100%);
    }
    .roster-table th {
      color: white;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .roster-table th:first-child {
      text-align: left;
      padding-left: 20px;
      min-width: 220px;
    }
    .roster-date-header { padding: 12px 8px 14px 8px !important; }
    .roster-date-chip {
      background: rgba(255, 255, 255, 0.25);
      border-radius: 20px;
      padding: 8px 16px;
      margin-bottom: 8px;
      font-weight: 800;
      font-size: 12px;
      display: inline-block;
    }
    .roster-share-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 5px 12px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s ease;
      font-family: "Poppins", sans-serif;
    }
    .roster-share-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    .roster-table td:first-child {
      text-align: left;
      font-weight: 700;
      background: linear-gradient(135deg, #0f766e 0%, var(--roster-teal) 100%);
      color: white;
      padding-left: 20px;
      font-size: 12px;
    }
    .roster-table td {
      background: white;
      color: #4a5568;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      position: relative;
    }
    .roster-table tbody tr:hover td:not(:first-child):not(.roster-section-cell) {
      background: #f0fdfa;
    }

    /* ==================== SECTION HEADERS ==================== */
    .roster-section-header td {
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%) !important;
      color: white !important;
      font-family: 'Playfair Display', serif;
      font-size: 14px;
      font-weight: 700;
      text-align: center !important;
      padding: 16px !important;
      cursor: default !important;
    }
    .roster-section-header.scripture-section td { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%) !important; }
    .roster-section-header.music-section td { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%) !important; }
    .roster-section-header.tech-section td { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%) !important; }
    .roster-section-header.communion-section td { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%) !important; }

    /* ==================== SPECIAL ROW STYLES ==================== */
    .roster-liturgical-row td:not(:first-child) {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
      color: #065f46 !important;
      font-weight: 700;
    }
    .roster-scripture-row td:not(:first-child) {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
      color: #1e40af !important;
    }
    .altar-color-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      vertical-align: middle;
      transition: transform 0.2s;
    }
    .altar-color-dot:hover { transform: scale(1.15); }

    /* ==================== CELL EDITING ==================== */
    .roster-cell-edited { position: relative; }
    .roster-cell-edited::after {
      content: '‚úì';
      position: absolute;
      top: 4px;
      right: 4px;
      color: #059669;
      font-size: 10px;
      background: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .roster-inline-editor {
      width: 100%;
      border: 2px solid var(--roster-teal);
      background: white;
      font-family: 'Poppins', sans-serif;
      font-size: 13px;
      font-weight: 500;
      padding: 8px 10px;
      border-radius: 8px;
      outline: none;
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.2);
      text-align: center;
    }
    .roster-inline-select {
      width: 100%;
      border: 2px solid var(--roster-teal);
      background: white;
      font-family: 'Poppins', sans-serif;
      font-size: 13px;
      font-weight: 500;
      padding: 6px 8px;
      border-radius: 8px;
      outline: none;
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.2);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2314b8a6' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }
    .roster-inline-select:focus {
      border-color: var(--roster-teal-dark);
      box-shadow: 0 4px 16px rgba(20, 184, 166, 0.3);
    }
    .roster-inline-select option {
      padding: 8px;
      font-family: 'Poppins', sans-serif;
    }
    .roster-inline-select option[value="__ADD_NEW__"] {
      font-style: italic;
      color: var(--roster-teal-dark);
      background: #f0fdfa;
    }
    .roster-dropdown-container {
      position: relative;
      width: 100%;
    }
    .roster-dropdown-container input {
      font-family: 'Poppins', sans-serif;
    }
    .roster-dropdown-container button:hover {
      opacity: 0.85;
    }

    /* ==================== ROSTER LEGEND ==================== */
    .roster-legend {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .roster-legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #4a5568;
      margin-right: 16px;
    }
    .roster-legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* ==================== MODAL STYLES ==================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
      animation: modalFadeIn 0.2s ease-out;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ==================== UTILITY CLASSES ==================== */
    .text-gradient {
      background: linear-gradient(135deg, var(--roster-teal-dark), var(--roster-teal-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<!-- ======================= END PART 1/6 ======================= -->
<!-- ======================= LHC Worship Prep ‚Äî index.html (PART 2/6) ======================= -->
<!-- Part 2: Body Shell, Loader, Toast, Sidebar with SONG STATISTICS, Main Header (NOT STICKY) -->

<body class="antialiased">

  <!-- ==================== LOADING INDICATOR ==================== -->
  <div id="loadingIndicator">
    <div class="lhc-card" style="padding: 24px 32px; display: flex; flex-direction: column; align-items: center; gap: 12px;">
      <div style="font-size: 32px;" class="animate-bounce">üéµ</div>
      <div style="font-family: 'Poppins', sans-serif; font-weight: 600; color: #475569;">Loading worship data‚Ä¶</div>
    </div>
  </div>

  <!-- ==================== TOAST NOTIFICATION ==================== -->
  <div id="toastNotification" class="toast-notification"></div>

  <!-- ==================== ROOT LAYOUT ==================== -->
  <div class="lhc-root">

    <!-- =============== SIDEBAR =============== -->
    <aside id="playlistSidebar" class="lhc-card relative flex flex-col overflow-hidden shadow-2xl">
      <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-white/10 via-transparent to-black/30"></div>

      <!-- Logo / Title -->
      <div class="relative px-4 pt-4 pb-3 border-b border-white/20 flex items-center gap-3">
        <div class="h-11 w-11 rounded-2xl bg-white/20 border border-white/40 flex items-center justify-center shadow-md">
          <span class="text-2xl">‚õ™</span>
        </div>
        <div class="leading-snug">
          <h1 class="font-cinzel font-semibold tracking-[0.15em] text-[0.85rem] uppercase text-slate-100">
            LHC Worship Prep
          </h1>
          <p class="text-[0.7rem] text-slate-100/80 mt-0.5">
            Song Finder ‚Ä¢ Roster ‚Ä¢ Orders
          </p>
        </div>
      </div>

      <!-- Overview -->
      <div class="relative px-4 pt-3 text-xs text-slate-100/90 space-y-2">
        <p class="lhc-section-title text-slate-100/70 mb-1">Overview</p>
        <p class="leading-relaxed">
          Browse songs in <span class="font-semibold">Song Finder</span>, manage the
          <span class="font-semibold">Worship Roster</span>, and build services in
          <span class="font-semibold">Worship Orders</span>.
        </p>
        <p id="backendStatus" class="text-[0.7rem] text-slate-200/70 mt-2">Backend: checking‚Ä¶</p>
      </div>

      <!-- Navigation Buttons -->
      <div class="relative px-4 pt-4">
        <div class="flex gap-2 flex-wrap">
          <button class="lhc-pill-button lhc-pill-button-active" id="navSongFinderBtn">
            <i class="fa-solid fa-magnifying-glass mr-1"></i> Songs
          </button>
          <button class="lhc-pill-button" id="navRosterBtn">
            <i class="fa-solid fa-table mr-1"></i> Roster
          </button>
          <button class="lhc-pill-button" id="navOrdersBtn">
            <i class="fa-solid fa-calendar-days mr-1"></i> Orders
          </button>
        </div>
      </div>

      <hr class="relative mx-4 my-4 border-none border-t border-white/20" style="border-top: 1px solid rgba(255,255,255,0.18);">

      <!-- =============== SONG STATISTICS (shown when on Songs view) =============== -->
      <div id="songStatsSection" class="relative px-4 flex-1 overflow-hidden flex flex-col">
        <p class="lhc-section-title text-slate-100/70 mb-3">
          <i class="fa-solid fa-chart-simple mr-1"></i> Song Statistics
        </p>
        
        <!-- Stats Tabs -->
        <div class="flex gap-1 mb-3 flex-wrap">
          <button class="stat-tab-btn active text-[0.65rem] px-2 py-1 rounded-lg" data-stat="frequent">
            üî• Most Used
          </button>
          <button class="stat-tab-btn text-[0.65rem] px-2 py-1 rounded-lg" data-stat="recent">
            üïê Recent
          </button>
          <button class="stat-tab-btn text-[0.65rem] px-2 py-1 rounded-lg" data-stat="newest">
            ‚ú® New
          </button>
        </div>

        <!-- Stats List Container -->
        <div id="songStatsContainer" class="lhc-scroll-y flex-1 overflow-y-auto space-y-1.5 pr-1" style="max-height: 320px;">
          <div class="text-xs text-white/60 text-center py-4">Loading stats...</div>
        </div>
      </div>

      <!-- =============== ROSTER UPDATES (shown when on Roster view) =============== -->
      <div id="rosterUpdatesSection" class="relative px-4 flex-1 overflow-hidden flex flex-col" style="display: none;">
        <p class="lhc-section-title text-slate-100/70 mb-3">
          <i class="fa-solid fa-clock-rotate-left mr-1"></i> Roster Updates
        </p>
        
        <!-- Updates List Container -->
        <div id="rosterUpdatesContainer" class="lhc-scroll-y flex-1 overflow-y-auto space-y-1.5 pr-1" style="max-height: 900px;">
          <div class="text-xs text-white/60 text-center py-4">Loading updates...</div>
        </div>
      </div>

      <hr class="relative mx-4 my-3 border-none" style="border-top: 1px solid rgba(255,255,255,0.18);">

      <!-- Tips -->
      <div class="relative px-4 pb-4 text-xs text-slate-200/70">
        <p><i class="fa-solid fa-lightbulb mr-1 text-yellow-300/80"></i> <b>Tip:</b> Click any song title to edit its details.</p>
      </div>
    </aside>

    <!-- =============== MAIN CONTENT CONTAINER =============== -->
    <main id="main-content-container" class="flex flex-col gap-4 min-w-0">

      <!-- ====== HEADER (NOT STICKY - removed position: sticky) ====== -->
      <header class="lhc-card" style="padding: 14px 18px;">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div>
            <p class="lhc-section-title">Luther House Chapel</p>
            <h2 class="font-cinzel text-xl font-bold text-slate-800 tracking-wide">Worship Planning Console</h2>
          </div>
          <div class="flex gap-2 flex-wrap items-center">
            <button class="lhc-pill-button" id="refreshDataBtn">
              <i class="fa-solid fa-rotate-right mr-1"></i> Refresh
            </button>
            <button class="lhc-pill-button" id="openShareModalBtn">
              <i class="fa-solid fa-share-nodes mr-1"></i> Share
            </button>
            <button class="lhc-pill-button" id="openHelpBtn">
              <i class="fa-solid fa-circle-question mr-1"></i> Help
            </button>
          </div>
        </div>
      </header>

<!-- ======================= END PART 2/6 ======================= -->
<!-- ======================= LHC Worship Prep ‚Äî index.html (PART 3/6) ======================= -->
<!-- Part 3: Song Finder View, Worship Roster View, Worship Orders View -->

      <!-- ==================== VIEW: SONG FINDER ==================== -->
      <section id="songFinderView">

        <!-- Search & Filters Card -->
        <div class="lhc-card" style="padding: 16px 18px; margin-bottom: 16px;">
          <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
            <div>
              <p class="lhc-section-title">Library</p>
              <h3 class="font-cinzel text-lg font-bold text-slate-800">Find Worship Songs</h3>
            </div>
            <button class="lhc-pill-button" id="openAddSongBtn" style="background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: white; border-color: transparent;">
              <i class="fa-solid fa-plus mr-1"></i> Add Song
            </button>
          </div>

          <!-- Search Input with Suggestions -->
          <div class="relative mb-4">
            <label class="form-label" for="searchInput">Search</label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
              <input 
                id="searchInput" 
                type="search" 
                class="form-input pl-11 pr-10" 
                placeholder="Type to search songs starting with..."
                autocomplete="off"
              >
              <button id="clearSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden" title="Clear search">
                <i class="fa-solid fa-xmark"></i>
              </button>
              <!-- Search Suggestions Dropdown -->
              <div id="searchSuggestions"></div>
            </div>
          </div>

          <!-- Filters Grid -->
          <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
            <div>
              <label class="form-label" for="filterTheme">Theme</label>
              <select id="filterTheme" class="form-input form-select text-sm py-2">
                <option value="">All Themes</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="filterKey">Key</label>
              <select id="filterKey" class="form-input form-select text-sm py-2">
                <option value="">All Keys</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="filterStyle">Style</label>
              <select id="filterStyle" class="form-input form-select text-sm py-2">
                <option value="">All Styles</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="filterTempo">Feel/Tempo</label>
              <select id="filterTempo" class="form-input form-select text-sm py-2">
                <option value="">All</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="filterSeason">Season</label>
              <select id="filterSeason" class="form-input form-select text-sm py-2">
                <option value="">All Seasons</option>
              </select>
            </div>
            <div>
              <label class="form-label" for="sortBy">Sort By</label>
              <select id="sortBy" class="form-input form-select text-sm py-2">
                <option value="title-asc">Title A‚ÜíZ</option>
                <option value="title-desc">Title Z‚ÜíA</option>
                <option value="artist-asc">Artist A‚ÜíZ</option>
                <option value="artist-desc">Artist Z‚ÜíA</option>
              </select>
            </div>
          </div>

          <!-- Results Info -->
          <div class="flex items-center justify-between text-xs text-slate-500">
            <div id="activeFiltersDisplay" class="flex flex-wrap gap-1"></div>
            <div>
              <span id="resultCount">0</span> results ‚Ä¢ <span id="totalCount">0</span> in library
            </div>
          </div>
        </div>

        <!-- Song List Container (List View, not Grid) -->
        <div class="lhc-card" style="padding: 0; overflow: hidden;">
          <div id="songListContainer"></div>
          
          <!-- Empty State / Placeholder -->
          <div id="songEmptyState" class="text-center py-12 px-6">
            <div class="text-4xl mb-3">üîç</div>
            <h4 class="font-semibold text-slate-700 mb-1">Start typing to search songs</h4>
            <p class="text-sm text-slate-500">Songs starting with your search text will appear here.</p>
          </div>
        </div>

      </section>

      <!-- ==================== VIEW: WORSHIP ROSTER ==================== -->
      <section id="worshipRosterView" style="display: none;">

        <!-- Roster Header Card -->
        <div class="roster-header-card" style="margin-bottom: 16px;">
          <div class="flex items-center justify-center gap-6 flex-wrap">
            <!-- Previous Month Button -->
            <button class="roster-nav-btn" id="rosterPrevMonthBtn" title="Previous Month">
              <i class="fa-solid fa-chevron-left"></i>
            </button>

            <!-- Month Title -->
            <div class="text-center" style="min-width: 220px;">
              <h2 class="font-playfair text-gradient text-2xl md:text-3xl font-bold">Worship Duty Roster</h2>
              <div id="rosterMonthTitle" class="font-poppins text-lg font-semibold text-slate-600 mt-2">
                January 2025
              </div>
              <div id="rosterSeasonTitle" class="text-sm text-slate-500 italic">
                Epiphany Season
              </div>
            </div>

            <!-- Next Month Button -->
            <button class="roster-nav-btn" id="rosterNextMonthBtn" title="Next Month">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          </div>

          <!-- Filter Buttons -->
          <div id="rosterFilterContainer" class="flex gap-2 justify-center flex-wrap mt-4 mb-2"></div>

          <!-- Instructions -->
          <p class="text-xs text-slate-500 mt-2">
            <i class="fa-solid fa-info-circle mr-1"></i>
            Double-click to edit ‚Ä¢ Right-click for options ‚Ä¢ Click color dot to cycle
          </p>

          <!-- Action Buttons -->
          <div class="flex gap-3 justify-center flex-wrap mt-6">
            <button class="roster-action-btn primary" id="rosterSaveBtn">
              <i class="fa-solid fa-floppy-disk"></i> Save Changes
            </button>
            <button class="roster-action-btn secondary" id="rosterDownloadCSVBtn">
              <i class="fa-solid fa-file-csv"></i> Download CSV
            </button>
            <button class="roster-action-btn secondary" id="rosterDownloadPDFBtn">
              <i class="fa-solid fa-file-pdf"></i> Print / PDF
            </button>
          </div>

          <!-- Sync Status -->
          <div class="mt-4 text-xs text-slate-500">
            <span id="rosterSyncStatus">Last synced: ‚Äî</span>
            <span id="rosterUnsavedIndicator" class="ml-3 text-amber-600 font-semibold hidden">
              <i class="fa-solid fa-triangle-exclamation"></i> Unsaved changes
            </span>
          </div>
        </div>

        <!-- Roster Table Container -->
        <div class="roster-container">
          <div class="roster-table-wrapper">
            <table class="roster-table" id="rosterTable">
              <thead>
                <tr id="rosterThead"></tr>
              </thead>
              <tbody id="rosterTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Altar Colors Legend -->
        <div class="roster-legend mt-4">
          <p class="text-xs font-semibold text-slate-600 mb-2">
            <i class="fa-solid fa-palette mr-1"></i> ALTAR COLORS:
          </p>
          <div class="flex flex-wrap gap-1">
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #22c55e;"></span> Green
            </span>
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #a855f7;"></span> Purple
            </span>
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #f8fafc; border: 1px solid #cbd5e1;"></span> White
            </span>
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #ef4444;"></span> Red
            </span>
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #eab308;"></span> Gold
            </span>
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #3b82f6;"></span> Blue
            </span>
            <span class="roster-legend-item">
              <span class="roster-legend-color" style="background: #f472b6;"></span> Rose
            </span>
          </div>
          <p class="text-xs text-slate-400 mt-2">
            <i class="fa-solid fa-lightbulb mr-1"></i> Row colors: 
            <span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-800 text-xs mx-1">Liturgical</span>
            <span class="inline-block px-2 py-0.5 rounded bg-blue-100 text-blue-800 text-xs mx-1">Scripture</span>
            <span class="inline-block px-2 py-0.5 rounded bg-white border text-slate-600 text-xs mx-1">Normal</span>
          </p>
        </div>

      </section>

      <!-- ==================== VIEW: WORSHIP ORDERS ==================== -->
      <section id="worshipOrderView" style="display: none;">
        <div class="lhc-card" style="padding: 18px;">
          <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
            <div>
              <p class="lhc-section-title">Service Planning</p>
              <h3 id="orderViewTitle" class="font-cinzel text-lg font-bold text-slate-800">Worship Orders</h3>
              <p id="orderViewDate" class="text-sm text-slate-500 mt-1">Select or create an order from the sidebar</p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button class="lhc-pill-button" id="newOrderFromViewBtn">
                <i class="fa-solid fa-plus mr-1"></i> New Order
              </button>
              <button class="lhc-pill-button" id="saveOrderBtn" style="background: linear-gradient(135deg, #059669, #10b981); color: white; border-color: transparent;">
                <i class="fa-solid fa-floppy-disk mr-1"></i> Save
              </button>
              <button class="lhc-pill-button" id="presentLiveBtn" style="background: linear-gradient(135deg, #dc2626, #ef4444); color: white; border-color: transparent;">
                <i class="fa-solid fa-tv mr-1"></i> Go LIVE
              </button>
            </div>
          </div>

          <!-- Order Sections Container -->
          <div id="orderSectionsContainer" class="space-y-3"></div>

          <!-- Empty State for Orders -->
          <div id="orderEmptyState" class="text-center py-12">
            <div class="text-4xl mb-3">üìã</div>
            <h4 class="font-semibold text-slate-700 mb-1">No order loaded</h4>
            <p class="text-sm text-slate-500">Select an order from the sidebar or create a new one.</p>
          </div>
        </div>
      </section>

    </main>
  </div>
  <!-- End of .lhc-root -->

<!-- ======================= END PART 3/6 ======================= -->
<!-- ======================= LHC Worship Prep ‚Äî index.html (PART 4/6) ======================= -->
<!-- Part 4: All Modals - v2.0 with Lyrics Editor, Multiple YouTube, File Names -->

<style>
  .dropdown-with-add { position: relative; }
  .dropdown-with-add select { padding-right: 80px; }
  .dropdown-add-btn { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); padding: 4px 8px; font-size: 11px; background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 6px; color: #0369a1; cursor: pointer; }
  .dropdown-add-btn:hover { background: #bae6fd; }
  
  /* Attachment and YouTube Lists */
  .link-list { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
  .link-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 12px; }
  .link-item i.file-icon { font-size: 18px; color: #6366f1; width: 24px; text-align: center; }
  .link-item i.fa-file-pdf { color: #ef4444; }
  .link-item i.fa-file-word { color: #2563eb; }
  .link-item i.fa-file-image { color: #10b981; }
  .link-item i.fa-google-drive { color: #4285f4; }
  .link-item i.fa-youtube { color: #ff0000; }
  .link-item .link-info { flex: 1; min-width: 0; }
  .link-item .link-name { font-weight: 600; color: #334155; truncate; }
  .link-item .link-ext { font-size: 10px; color: #64748b; text-transform: uppercase; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
  .link-item .link-actions { display: flex; gap: 6px; }
  .link-item .link-btn { padding: 4px 8px; font-size: 11px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; cursor: pointer; color: #475569; }
  .link-item .link-btn:hover { background: #f1f5f9; }
  .link-item .link-btn.preview { background: #dbeafe; border-color: #93c5fd; color: #1d4ed8; }
  .link-item .link-btn.remove { color: #ef4444; }
  .link-item .link-btn.remove:hover { background: #fee2e2; }
  
  /* Preview Section */
  .preview-section { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 16px; }
  .preview-section h4 { font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
  .preview-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
  .preview-btn { padding: 10px 16px; font-size: 12px; font-weight: 600; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #475569; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
  .preview-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
  .preview-btn.active { background: #6366f1; color: white; border-color: #6366f1; }
  .preview-content { margin-top: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 150px; max-height: 350px; overflow-y: auto; }
  .preview-lyrics { padding: 16px; white-space: pre-wrap; font-size: 14px; line-height: 1.8; color: #374151; font-family: 'Poppins', sans-serif; }
  .preview-lyrics .section-header { font-weight: 700; color: #6366f1; margin: 20px 0 10px 0; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
  .preview-lyrics .section-header:first-child { margin-top: 0; }
  .preview-lyrics .chord-line { color: #dc2626; font-weight: 600; font-family: 'Courier New', monospace; font-size: 13px; margin-bottom: -2px; white-space: pre; }
  .preview-lyrics .lyric-line { color: #1f2937; }
  
  /* Lyrics Preview Modal Specific */
  #lyricsPreviewContent { padding: 20px; }
  #lyricsPreviewContent .section-header { font-weight: 700; color: #6366f1; margin: 24px 0 12px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
  #lyricsPreviewContent .section-header:first-child { margin-top: 0; }
  #lyricsPreviewContent .chord-line { color: #dc2626; font-weight: 600; font-family: 'Courier New', monospace; font-size: 14px; margin-bottom: -4px; white-space: pre; }
  #lyricsPreviewContent .lyric-line { color: #1f2937; font-size: 16px; line-height: 1.7; }
  
  /* Lyrics Editor Button */
  .lyrics-edit-trigger { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
  .lyrics-edit-trigger:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
  .lyrics-edit-trigger i { font-size: 18px; }
  .lyrics-summary { margin-top: 10px; padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; font-size: 12px; color: #166534; }
  .lyrics-summary i { margin-right: 6px; }
  
  /* Lyrics Editor Modal */
  .lyrics-editor-modal { position: fixed; inset: 0; z-index: 20000; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; padding: 20px; }
  .lyrics-editor-modal.show { display: flex; }
  .lyrics-editor-content { background: white; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
  .lyrics-editor-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
  .lyrics-editor-header h3 { font-size: 18px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 10px; }
  .lyrics-editor-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; gap: 20px; }
  .lyrics-editor-left { flex: 1; display: flex; flex-direction: column; gap: 12px; }
  .lyrics-editor-right { width: 300px; background: #f8fafc; border-radius: 12px; padding: 16px; }
  
  /* Section Buttons */
  .section-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .section-btn { padding: 6px 12px; font-size: 11px; font-weight: 600; border-radius: 6px; border: 1px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.15s; }
  .section-btn:hover { background: #f1f5f9; }
  .section-btn.verse { border-color: #93c5fd; color: #1d4ed8; }
  .section-btn.verse:hover { background: #dbeafe; }
  .section-btn.chorus { border-color: #fca5a5; color: #dc2626; }
  .section-btn.chorus:hover { background: #fee2e2; }
  .section-btn.bridge { border-color: #a5b4fc; color: #4338ca; }
  .section-btn.bridge:hover { background: #e0e7ff; }
  .section-btn.prechorus { border-color: #fdba74; color: #c2410c; }
  .section-btn.prechorus:hover { background: #ffedd5; }
  .section-btn.ending { border-color: #86efac; color: #166534; }
  .section-btn.ending:hover { background: #dcfce7; }
  
  /* Lyrics Textarea */
  .lyrics-textarea { flex: 1; width: 100%; min-height: 300px; padding: 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; resize: none; }
  .lyrics-textarea:focus { outline: none; border-color: #6366f1; }
  
  /* Help Panel */
  .lyrics-help { font-size: 12px; color: #64748b; }
  .lyrics-help h4 { font-size: 13px; font-weight: 700; color: #334155; margin-bottom: 10px; }
  .lyrics-help p { margin-bottom: 8px; line-height: 1.5; }
  .lyrics-help code { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
  .lyrics-help .example { background: #f1f5f9; padding: 10px; border-radius: 8px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 11px; white-space: pre-wrap; }
  
  .lyrics-editor-footer { padding: 16px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; }
  
  /* Roster Update Items */
  .roster-update-item { font-family: 'Poppins', sans-serif; }
  .roster-nav-btn { 
    width: 16px; height: 16px; 
    background: rgba(255,255,255,0.2); 
    border: none; border-radius: 3px; 
    color: white; cursor: pointer; 
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  .roster-nav-btn:hover { background: rgba(255,255,255,0.4); }
  
  /* Lyrics Format Toolbar */
  .lyrics-format-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 10px;
    align-items: center;
  }
  .format-group {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .format-select {
    padding: 4px 8px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 12px;
    background: white;
    cursor: pointer;
  }
  .format-btn {
    width: 28px;
    height: 28px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #475569;
    transition: all 0.15s;
  }
  .format-btn:hover {
    background: #f1f5f9;
    border-color: #94a3b8;
  }
  .format-btn.active {
    background: #e0e7ff;
    border-color: #6366f1;
    color: #4f46e5;
  }
  .scan-btn {
    width: auto !important;
    padding: 8px 16px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    gap: 6px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    border: none !important;
    color: white !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    transition: all 0.2s !important;
  }
  .scan-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
    transform: translateY(-1px);
  }
  .scan-btn i {
    font-size: 14px;
  }
  
  /* Scan Modal - must be on top */
  #lyricsScanModal {
    z-index: 100000 !important;
  }
  #lyricsScanModal .modal-content {
    z-index: 100001 !important;
  }
  
  /* Theme Multi-Select Dropdown */
  .theme-multiselect { position: relative; }
  .theme-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 100; max-height: 280px; overflow-y: auto; margin-top: 4px; }
  .theme-dropdown.hidden { display: none; }
  .theme-option { padding: 8px 14px; }
  .theme-option:hover { background: #f8fafc; }
  .theme-option label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #374151; }
  .theme-option input[type="checkbox"] { width: 16px; height: 16px; accent-color: #6366f1; }
  .theme-add-new { padding: 10px 14px; border-top: 1px solid #e2e8f0; display: flex; gap: 8px; }
  .theme-add-new input { flex: 1; padding: 6px 10px; }
</style>

  <!-- ==================== MODAL: ADD SONG ==================== -->
  <div id="addSongModal" class="modal-overlay">
    <div class="modal-content" style="width: min(900px, 95%); max-height: 90vh; overflow-y: auto; padding: 20px;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h3 class="font-cinzel text-xl font-bold text-slate-800">
          <i class="fa-solid fa-music mr-2 text-indigo-500"></i> Add New Song
        </h3>
        <button id="closeAddSongBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="form-label" for="newSongTitle">Title *</label>
          <input id="newSongTitle" class="form-input" placeholder="Song title (required)">
        </div>
        <div>
          <label class="form-label" for="newSongArtist">Artist</label>
          <input id="newSongArtist" class="form-input" placeholder="Artist / Composer">
        </div>
        <div>
          <label class="form-label" for="newSongCategory">Category / Style</label>
          <select id="newSongCategory" class="form-input">
            <option value="">Select category...</option>
            <option value="Traditional Hymn">Traditional Hymn</option>
            <option value="Contemporary Hymn">Contemporary Hymn</option>
            <option value="Contemporary">Contemporary</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="newSongKey">Key</label>
          <select id="newSongKey" class="form-input">
            <option value="">Select key...</option>
            <option value="C">C Major</option>
            <option value="C#">C# / Db Major</option>
            <option value="D">D Major</option>
            <option value="D#">D# / Eb Major</option>
            <option value="E">E Major</option>
            <option value="F">F Major</option>
            <option value="F#">F# / Gb Major</option>
            <option value="G">G Major</option>
            <option value="G#">G# / Ab Major</option>
            <option value="A">A Major</option>
            <option value="A#">A# / Bb Major</option>
            <option value="B">B Major</option>
            <option value="Am">A minor</option>
            <option value="Bm">B minor</option>
            <option value="Cm">C minor</option>
            <option value="Dm">D minor</option>
            <option value="Em">E minor</option>
            <option value="Fm">F minor</option>
            <option value="Gm">G minor</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="newSongTempo">Tempo / Feel</label>
          <select id="newSongTempo" class="form-input">
            <option value="">Select tempo...</option>
            <option value="Slow">Slow</option>
            <option value="Moderate">Moderate</option>
            <option value="Fast">Fast</option>
            <option value="Ballad">Ballad</option>
            <option value="Upbeat">Upbeat</option>
            <option value="Meditative">Meditative</option>
            <option value="Celebratory">Celebratory</option>
          </select>
        </div>
        <div class="dropdown-with-add">
          <label class="form-label" for="newSongTheme">Theme(s)</label>
          <div class="theme-multiselect" id="newSongThemeContainer">
            <button type="button" class="form-input text-left flex items-center justify-between" onclick="toggleThemeDropdown('new')" id="newSongThemeBtn">
              <span id="newSongThemeDisplay">Select themes...</span>
              <i class="fa-solid fa-chevron-down text-slate-400"></i>
            </button>
            <div id="newSongThemeDropdown" class="theme-dropdown hidden">
              <div class="theme-option"><label><input type="checkbox" value="Praise" onchange="updateThemeSelection('new')"> Praise</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Worship" onchange="updateThemeSelection('new')"> Worship</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Grace" onchange="updateThemeSelection('new')"> Grace</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Hope" onchange="updateThemeSelection('new')"> Hope</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Love" onchange="updateThemeSelection('new')"> Love</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Faith" onchange="updateThemeSelection('new')"> Faith</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Peace" onchange="updateThemeSelection('new')"> Peace</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Joy" onchange="updateThemeSelection('new')"> Joy</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Thanksgiving" onchange="updateThemeSelection('new')"> Thanksgiving</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Repentance" onchange="updateThemeSelection('new')"> Repentance</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Healing" onchange="updateThemeSelection('new')"> Healing</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Comfort" onchange="updateThemeSelection('new')"> Comfort</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Commitment" onchange="updateThemeSelection('new')"> Commitment</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Salvation" onchange="updateThemeSelection('new')"> Salvation</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Servanthood" onchange="updateThemeSelection('new')"> Servanthood</label></div>
              <div class="theme-add-new">
                <input type="text" id="newThemeInput" placeholder="Add new theme..." class="form-input text-sm">
                <button type="button" onclick="addCustomTheme('new')" class="lhc-pill-button text-xs">Add</button>
              </div>
            </div>
          </div>
          <input type="hidden" id="newSongTheme" value="">
        </div>
        <div class="md:col-span-3">
          <label class="form-label" for="newSongSeason">Liturgical Season</label>
          <select id="newSongSeason" class="form-input">
            <option value="">Select season...</option>
            <option value="Advent">Advent</option>
            <option value="Christmas">Christmas</option>
            <option value="Epiphany">Epiphany</option>
            <option value="Lent">Lent</option>
            <option value="Holy Week">Holy Week</option>
            <option value="Easter">Easter</option>
            <option value="Pentecost">Pentecost</option>
            <option value="Ordinary Time">Ordinary Time</option>
            <option value="All Seasons">All Seasons</option>
          </select>
        </div>
        
        <!-- YouTube URLs Section -->
        <div class="md:col-span-3">
          <label class="form-label">YouTube Links</label>
          <div class="flex gap-2">
            <input id="newSongYoutubeInput" class="form-input flex-1" placeholder="Paste YouTube URL...">
            <button type="button" class="lhc-pill-button" onclick="addYoutubeLink('new')" style="background:#fee2e2;border-color:#fca5a5;color:#dc2626;">
              <i class="fa-brands fa-youtube"></i> Add
            </button>
          </div>
          <div id="newSongYoutubeList" class="link-list"></div>
        </div>
        
        <!-- Attachments Section -->
        <div class="md:col-span-3">
          <label class="form-label">Attachments (Lead Sheets, Docs, Images)</label>
          <div class="flex gap-2">
            <input id="newSongDocUrl" class="form-input flex-1" placeholder="Paste Google Drive / URL link...">
            <button type="button" class="lhc-pill-button" onclick="addAttachment('new')" style="background:#e0f2fe;border-color:#7dd3fc;color:#0369a1;">
              <i class="fa-solid fa-plus"></i> Add Link
            </button>
          </div>
          <div id="newSongAttachments" class="link-list"></div>
        </div>
        
        <!-- Lyrics Section - Button to Open Editor -->
        <div class="md:col-span-3">
          <label class="form-label">Lyrics / Chords</label>
          <button type="button" class="lyrics-edit-trigger" onclick="openLyricsEditor('new')">
            <i class="fa-solid fa-pen-to-square"></i>
            <span>Open Lyrics Editor</span>
          </button>
          <div id="newSongLyricsSummary" class="lyrics-summary hidden">
            <i class="fa-solid fa-check-circle"></i>
            <span id="newSongLyricsInfo">Lyrics saved</span>
          </div>
          <!-- Hidden field to store lyrics data -->
          <input type="hidden" id="newSongLyricsData" value="">
        </div>
        
        <!-- Preview Section -->
        <div class="md:col-span-3 preview-section">
          <h4><i class="fa-solid fa-eye mr-2"></i> Preview</h4>
          <div class="preview-buttons">
            <button type="button" class="preview-btn" onclick="showSongPreview('new', 'lyrics')">
              <i class="fa-solid fa-file-lines"></i> Lyrics Only
            </button>
            <button type="button" class="preview-btn" onclick="showSongPreview('new', 'chords')">
              <i class="fa-solid fa-guitar"></i> Lyrics + Chords
            </button>
            <button type="button" class="preview-btn" onclick="showSongPreview('new', 'docs')">
              <i class="fa-solid fa-paperclip"></i> Attachments
            </button>
          </div>
          <div id="newSongPreviewContent" class="preview-content hidden"></div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-5 pt-4 border-t border-slate-200">
        <button id="cancelAddSongBtn" class="lhc-pill-button">
          <i class="fa-solid fa-xmark mr-1"></i> Cancel
        </button>
        <button id="saveNewSongBtn" class="roster-action-btn primary">
          <i class="fa-solid fa-floppy-disk mr-1"></i> Save Song
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: EDIT SONG ==================== -->
  <div id="editSongModal" class="modal-overlay">
    <div class="modal-content" style="width: min(900px, 95%); max-height: 90vh; overflow-y: auto; padding: 20px;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h3 class="font-cinzel text-xl font-bold text-slate-800">
          <i class="fa-solid fa-pen-to-square mr-2 text-amber-500"></i> Edit Song
        </h3>
        <button id="closeEditSongBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <input type="hidden" id="editSongId">

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="form-label" for="editSongTitle">Title *</label>
          <input id="editSongTitle" class="form-input" placeholder="Song title (required)">
        </div>
        <div>
          <label class="form-label" for="editSongArtist">Artist</label>
          <input id="editSongArtist" class="form-input" placeholder="Artist / Composer">
        </div>
        <div>
          <label class="form-label" for="editSongCategory">Category / Style</label>
          <select id="editSongCategory" class="form-input">
            <option value="">Select category...</option>
            <option value="Traditional Hymn">Traditional Hymn</option>
            <option value="Contemporary Hymn">Contemporary Hymn</option>
            <option value="Contemporary">Contemporary</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="editSongKey">Key</label>
          <select id="editSongKey" class="form-input">
            <option value="">Select key...</option>
            <option value="C">C Major</option>
            <option value="C#">C# / Db Major</option>
            <option value="D">D Major</option>
            <option value="D#">D# / Eb Major</option>
            <option value="E">E Major</option>
            <option value="F">F Major</option>
            <option value="F#">F# / Gb Major</option>
            <option value="G">G Major</option>
            <option value="G#">G# / Ab Major</option>
            <option value="A">A Major</option>
            <option value="A#">A# / Bb Major</option>
            <option value="B">B Major</option>
            <option value="Am">A minor</option>
            <option value="Bm">B minor</option>
            <option value="Cm">C minor</option>
            <option value="Dm">D minor</option>
            <option value="Em">E minor</option>
            <option value="Fm">F minor</option>
            <option value="Gm">G minor</option>
          </select>
        </div>
        <div>
          <label class="form-label" for="editSongTempo">Tempo / Feel</label>
          <select id="editSongTempo" class="form-input">
            <option value="">Select tempo...</option>
            <option value="Slow">Slow</option>
            <option value="Moderate">Moderate</option>
            <option value="Fast">Fast</option>
            <option value="Ballad">Ballad</option>
            <option value="Upbeat">Upbeat</option>
            <option value="Meditative">Meditative</option>
            <option value="Celebratory">Celebratory</option>
          </select>
        </div>
        <div class="dropdown-with-add">
          <label class="form-label" for="editSongTheme">Theme(s)</label>
          <div class="theme-multiselect" id="editSongThemeContainer">
            <button type="button" class="form-input text-left flex items-center justify-between" onclick="toggleThemeDropdown('edit')" id="editSongThemeBtn">
              <span id="editSongThemeDisplay">Select themes...</span>
              <i class="fa-solid fa-chevron-down text-slate-400"></i>
            </button>
            <div id="editSongThemeDropdown" class="theme-dropdown hidden">
              <div class="theme-option"><label><input type="checkbox" value="Praise" onchange="updateThemeSelection('edit')"> Praise</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Worship" onchange="updateThemeSelection('edit')"> Worship</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Grace" onchange="updateThemeSelection('edit')"> Grace</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Hope" onchange="updateThemeSelection('edit')"> Hope</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Love" onchange="updateThemeSelection('edit')"> Love</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Faith" onchange="updateThemeSelection('edit')"> Faith</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Peace" onchange="updateThemeSelection('edit')"> Peace</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Joy" onchange="updateThemeSelection('edit')"> Joy</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Thanksgiving" onchange="updateThemeSelection('edit')"> Thanksgiving</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Repentance" onchange="updateThemeSelection('edit')"> Repentance</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Healing" onchange="updateThemeSelection('edit')"> Healing</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Comfort" onchange="updateThemeSelection('edit')"> Comfort</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Commitment" onchange="updateThemeSelection('edit')"> Commitment</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Salvation" onchange="updateThemeSelection('edit')"> Salvation</label></div>
              <div class="theme-option"><label><input type="checkbox" value="Servanthood" onchange="updateThemeSelection('edit')"> Servanthood</label></div>
              <div class="theme-add-new">
                <input type="text" id="editThemeInput" placeholder="Add new theme..." class="form-input text-sm">
                <button type="button" onclick="addCustomTheme('edit')" class="lhc-pill-button text-xs">Add</button>
              </div>
            </div>
          </div>
          <input type="hidden" id="editSongTheme" value="">
        </div>
        <div class="md:col-span-3">
          <label class="form-label" for="editSongSeason">Liturgical Season</label>
          <select id="editSongSeason" class="form-input">
            <option value="">Select season...</option>
            <option value="Advent">Advent</option>
            <option value="Christmas">Christmas</option>
            <option value="Epiphany">Epiphany</option>
            <option value="Lent">Lent</option>
            <option value="Holy Week">Holy Week</option>
            <option value="Easter">Easter</option>
            <option value="Pentecost">Pentecost</option>
            <option value="Ordinary Time">Ordinary Time</option>
            <option value="All Seasons">All Seasons</option>
          </select>
        </div>
        
        <!-- YouTube URLs Section -->
        <div class="md:col-span-3">
          <label class="form-label">YouTube Links</label>
          <div class="flex gap-2">
            <input id="editSongYoutubeInput" class="form-input flex-1" placeholder="Paste YouTube URL...">
            <button type="button" class="lhc-pill-button" onclick="addYoutubeLink('edit')" style="background:#fee2e2;border-color:#fca5a5;color:#dc2626;">
              <i class="fa-brands fa-youtube"></i> Add
            </button>
          </div>
          <div id="editSongYoutubeList" class="link-list"></div>
        </div>
        
        <!-- Attachments Section -->
        <div class="md:col-span-3">
          <label class="form-label">Attachments (Lead Sheets, Docs, Images)</label>
          <div class="flex gap-2">
            <input id="editSongDocUrl" class="form-input flex-1" placeholder="Paste Google Drive / URL link...">
            <button type="button" class="lhc-pill-button" onclick="addAttachment('edit')" style="background:#e0f2fe;border-color:#7dd3fc;color:#0369a1;">
              <i class="fa-solid fa-plus"></i> Add Link
            </button>
          </div>
          <div id="editSongAttachments" class="link-list"></div>
        </div>
        
        <!-- Lyrics Section -->
        <div class="md:col-span-3">
          <label class="form-label">Lyrics / Chords</label>
          <button type="button" class="lyrics-edit-trigger" onclick="openLyricsEditor('edit')">
            <i class="fa-solid fa-pen-to-square"></i>
            <span>Open Lyrics Editor</span>
          </button>
          <div id="editSongLyricsSummary" class="lyrics-summary hidden">
            <i class="fa-solid fa-check-circle"></i>
            <span id="editSongLyricsInfo">Lyrics saved</span>
          </div>
          <input type="hidden" id="editSongLyricsData" value="">
        </div>
        
        <!-- Preview Section -->
        <div class="md:col-span-3 preview-section">
          <h4><i class="fa-solid fa-eye mr-2"></i> Preview</h4>
          <div class="preview-buttons">
            <button type="button" class="preview-btn" onclick="showSongPreview('edit', 'lyrics')">
              <i class="fa-solid fa-file-lines"></i> Lyrics Only
            </button>
            <button type="button" class="preview-btn" onclick="showSongPreview('edit', 'chords')">
              <i class="fa-solid fa-guitar"></i> Lyrics + Chords
            </button>
            <button type="button" class="preview-btn" onclick="showSongPreview('edit', 'docs')">
              <i class="fa-solid fa-paperclip"></i> Attachments
            </button>
          </div>
          <div id="editSongPreviewContent" class="preview-content hidden"></div>
        </div>
      </div>

      <div class="flex justify-between gap-3 mt-5 pt-4 border-t border-slate-200">
        <button id="deleteSongBtn" class="roster-action-btn danger">
          <i class="fa-solid fa-trash mr-1"></i> Delete Song
        </button>
        <div class="flex gap-3">
          <button id="cancelEditSongBtn" class="lhc-pill-button">
            <i class="fa-solid fa-xmark mr-1"></i> Cancel
          </button>
          <button id="saveEditSongBtn" class="roster-action-btn primary">
            <i class="fa-solid fa-floppy-disk mr-1"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== LYRICS EDITOR MODAL ==================== -->
  <div id="lyricsEditorModal" class="lyrics-editor-modal">
    <div class="lyrics-editor-content">
      <div class="lyrics-editor-header">
        <h3><i class="fa-solid fa-music text-indigo-500"></i> Lyrics & Chords Editor</h3>
        <button type="button" class="lhc-pill-button" onclick="closeLyricsEditor()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="lyrics-editor-body">
        <div class="lyrics-editor-left">
          <div class="section-buttons">
            <span class="text-xs text-slate-500 mr-2">Insert Section:</span>
            <button type="button" class="section-btn verse" onclick="insertSection('Verse')">+ Verse</button>
            <button type="button" class="section-btn chorus" onclick="insertSection('Chorus')">+ Chorus</button>
            <button type="button" class="section-btn prechorus" onclick="insertSection('Pre-Chorus')">+ Pre-Chorus</button>
            <button type="button" class="section-btn bridge" onclick="insertSection('Bridge')">+ Bridge</button>
            <button type="button" class="section-btn ending" onclick="insertSection('Ending')">+ Ending</button>
            <button type="button" class="section-btn" onclick="insertSection('Last Line')">+ Last Line</button>
          </div>
          
          <!-- Formatting Toolbar -->
          <div class="lyrics-format-toolbar">
            <div class="format-group">
              <select id="lyricsFontFamily" class="format-select" onchange="applyLyricsFormat('fontFamily', this.value)" title="Font Style">
                <option value="Courier New, monospace">Monospace</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="Times New Roman, serif">Times</option>
              </select>
              <select id="lyricsFontSize" class="format-select" onchange="applyLyricsFormat('fontSize', this.value)" title="Font Size">
                <option value="12px">12px</option>
                <option value="14px" selected>14px</option>
                <option value="16px">16px</option>
                <option value="18px">18px</option>
                <option value="20px">20px</option>
              </select>
            </div>
            <div class="format-group">
              <button type="button" class="format-btn" onclick="applyLyricsFormat('bold')" title="Bold"><i class="fa-solid fa-bold"></i></button>
              <button type="button" class="format-btn" onclick="applyLyricsFormat('italic')" title="Italic"><i class="fa-solid fa-italic"></i></button>
              <button type="button" class="format-btn" onclick="applyLyricsFormat('underline')" title="Underline"><i class="fa-solid fa-underline"></i></button>
            </div>
            <div class="format-group">
              <button type="button" class="format-btn" onclick="lyricsUndo()" title="Undo"><i class="fa-solid fa-rotate-left"></i></button>
              <button type="button" class="format-btn" onclick="lyricsRedo()" title="Redo"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="format-group">
              <button type="button" class="format-btn scan-btn" onclick="scanAttachmentsForLyrics()" title="Scan from Attached Docs">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Scan Docs
              </button>
            </div>
          </div>
          <textarea id="lyricsEditorTextarea" class="lyrics-textarea" placeholder="Type or paste lyrics here...

Example format:
[Verse 1]
   G        C       D
Amazing grace how sweet the sound
   G           C    G
That saved a wretch like me

[Chorus]
   C       G      D
I once was lost but now am found
   G       C    G
Was blind but now I see"></textarea>
        </div>
        <div class="lyrics-editor-right">
          <div class="lyrics-help">
            <h4><i class="fa-solid fa-circle-info mr-1"></i> How to Format</h4>
            <p><strong>Sections:</strong> Use buttons above or type <code>[Section Name]</code></p>
            <p><strong>Chords:</strong> Type chord names on the line ABOVE the lyrics, positioned where they should appear.</p>
            <div class="example">[Verse 1]
   G        C       D
Amazing grace how sweet
   G           C    G
That saved a wretch</div>
            <p><strong>Section Types:</strong></p>
            <p>‚Ä¢ <code>[Verse]</code> or <code>[Verse 1]</code></p>
            <p>‚Ä¢ <code>[Chorus]</code></p>
            <p>‚Ä¢ <code>[Pre-Chorus]</code></p>
            <p>‚Ä¢ <code>[Bridge]</code></p>
            <p>‚Ä¢ <code>[Ending]</code></p>
            <p>‚Ä¢ <code>[Last Line]</code></p>
            <hr style="margin: 12px 0; border-color: #e2e8f0;">
            <p><strong>Preview:</strong> Section headers will show in records but not during live projection.</p>
          </div>
        </div>
      </div>
      <div class="lyrics-editor-footer">
        <button type="button" class="lhc-pill-button" onclick="closeLyricsEditor()">
          <i class="fa-solid fa-xmark mr-1"></i> Cancel
        </button>
        <button type="button" class="roster-action-btn primary" onclick="saveLyricsEditor()">
          <i class="fa-solid fa-check mr-1"></i> Save Lyrics
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: YOUTUBE PREVIEW ==================== -->
  <div id="youtubePreviewModal" class="modal-overlay">
    <div class="modal-content" style="width: min(800px, 95%); padding: 0; overflow: hidden; border-radius: 16px;">
      <div class="flex items-center justify-between gap-4 p-4 border-b border-slate-200">
        <h3 class="font-semibold text-slate-800">
          <i class="fa-brands fa-youtube mr-2 text-red-500"></i> YouTube Preview
        </h3>
        <button id="closeYoutubePreviewBtn" class="lhc-pill-button" title="Close" onclick="closeYoutubePreview()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="aspect-video bg-black">
        <iframe id="youtubePreviewFrame" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: DOCUMENT PREVIEW ==================== -->
  <div id="previewModal" class="modal-overlay">
    <div class="modal-content" style="width: min(900px, 95%); height: 80vh; display: flex; flex-direction: column; padding: 0;">
      <div class="flex items-center justify-between gap-4 p-4 border-b border-slate-200">
        <h3 id="previewModalTitle" class="font-cinzel text-lg font-bold text-slate-800">
          <i class="fa-solid fa-eye mr-2 text-indigo-500"></i> Preview
        </h3>
        <button id="closePreviewBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="flex-1 overflow-hidden">
        <iframe id="previewFrame" class="w-full h-full border-0"></iframe>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: LYRICS PREVIEW (from song card) ==================== -->
  <div id="lyricsPreviewModal" class="modal-overlay">
    <div class="modal-content" style="width: min(750px, 95%); max-height: 85vh; display: flex; flex-direction: column; padding: 0;">
      <div class="p-4 border-b border-slate-200">
        <div class="flex items-center justify-between gap-4">
          <div>
            <h3 id="lyricsPreviewTitle" class="font-cinzel text-xl font-bold text-slate-800"></h3>
            <p id="lyricsPreviewArtist" class="text-sm text-slate-500 mt-1"></p>
          </div>
          <button class="lhc-pill-button" title="Close" onclick="closeLyricsPreviewModal()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="flex items-center justify-between mt-4 flex-wrap gap-2">
          <div class="flex gap-2">
            <button id="lyricsPreviewLyricsBtn" class="lhc-pill-button lhc-pill-button-active text-sm" onclick="switchLyricsPreviewMode('lyrics')">
              <i class="fa-solid fa-file-lines mr-1"></i> Lyrics Only
            </button>
            <button id="lyricsPreviewChordsBtn" class="lhc-pill-button text-sm" onclick="switchLyricsPreviewMode('chords')">
              <i class="fa-solid fa-guitar mr-1"></i> Lyrics + Chords
            </button>
          </div>
          <div class="flex gap-2 items-center">
            <!-- Transpose Dropdown -->
            <div id="transposeContainer" class="hidden items-center gap-2">
              <label class="text-xs text-slate-500">Transpose:</label>
              <select id="transposeSelect" class="form-input text-sm py-1 px-2" style="width: auto;" onchange="applyTranspose()">
                <option value="0">Original</option>
                <option value="1">+1 (Half step up)</option>
                <option value="2">+2</option>
                <option value="3">+3</option>
                <option value="4">+4</option>
                <option value="5">+5</option>
                <option value="6">+6</option>
                <option value="-1">-1 (Half step down)</option>
                <option value="-2">-2</option>
                <option value="-3">-3</option>
                <option value="-4">-4</option>
                <option value="-5">-5</option>
              </select>
            </div>
            <button class="lhc-pill-button text-sm" style="background:#fee2e2;border-color:#fca5a5;color:#dc2626;" onclick="printLyricsPreview()">
              <i class="fa-solid fa-print mr-1"></i> Print / PDF
            </button>
          </div>
        </div>
      </div>
      <div id="lyricsPreviewContent" class="flex-1 overflow-y-auto p-5" style="min-height: 300px;">
        <!-- Lyrics content rendered here -->
      </div>
      <div class="p-3 border-t border-slate-200 text-right">
        <span id="lyricsPreviewLastEdited" class="text-xs text-slate-400"></span>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: DOC PREVIEW ==================== -->
  <div id="docPreviewModal" class="modal-overlay">
    <div class="modal-content" style="width: min(900px, 95%); height: 85vh; display: flex; flex-direction: column; padding: 0;">
      <div class="flex items-center justify-between gap-4 p-4 border-b border-slate-200">
        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-file-lines text-blue-500"></i>
          <span id="docPreviewTitle">Document</span>
        </h3>
        <div class="flex gap-2">
          <button id="docPreviewOpenBtn" class="lhc-pill-button text-sm" style="background:#dbeafe;border-color:#93c5fd;color:#1d4ed8;">
            <i class="fa-solid fa-external-link mr-1"></i> Open in New Tab
          </button>
          <button class="lhc-pill-button" title="Close" onclick="closeDocPreview()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
      <div class="flex-1 overflow-hidden bg-slate-100">
        <iframe id="docPreviewFrame" class="w-full h-full border-0" src=""></iframe>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: YOUTUBE PREVIEW ==================== -->
  <div id="youtubePreviewModal" class="modal-overlay">
    <div class="modal-content" style="width: min(900px, 95%); padding: 0; overflow: hidden; border-radius: 16px;">
      <div class="flex items-center justify-between gap-4 p-4 border-b border-slate-200">
        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
          <i class="fa-brands fa-youtube text-red-500"></i>
          <span id="youtubePreviewTitle">Video</span>
        </h3>
        <div class="flex gap-2">
          <button id="youtubePreviewOpenBtn" class="lhc-pill-button text-sm" style="background:#fee2e2;border-color:#fca5a5;color:#dc2626;">
            <i class="fa-brands fa-youtube mr-1"></i> Open on YouTube
          </button>
          <button class="lhc-pill-button" title="Close" onclick="closeYoutubePreview()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
      <div class="aspect-video bg-black">
        <iframe id="youtubePreviewFrame" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: SHARE ==================== -->
  <div id="shareModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px; padding: 20px;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h3 class="font-cinzel text-lg font-bold text-slate-800">
          <i class="fa-solid fa-share-nodes mr-2 text-green-500"></i> Share
        </h3>
        <button id="closeShareBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button id="shareWhatsApp" class="lhc-pill-button w-full text-sm py-3" style="background: #25D366; color: white; border-color: #25D366;">
          <i class="fa-brands fa-whatsapp mr-2"></i> WhatsApp
        </button>
        <button id="shareCopyLink" class="lhc-pill-button w-full text-sm py-3">
          <i class="fa-solid fa-link mr-2"></i> Copy Link
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: HELP ==================== -->
  <div id="helpModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; padding: 20px;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h3 class="font-cinzel text-xl font-bold text-slate-800">
          <i class="fa-solid fa-circle-question mr-2 text-indigo-500"></i> Help & Guide
        </h3>
        <button id="closeHelpBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="text-sm text-slate-600 space-y-4 max-h-[60vh] overflow-y-auto pr-2">
        <div>
          <h4 class="font-semibold text-slate-800 mb-2"><i class="fa-solid fa-music mr-2 text-indigo-500"></i> Song Finder</h4>
          <ul class="list-disc list-inside space-y-1 ml-4">
            <li>Search songs by typing - matches songs starting with your text</li>
            <li>Use filters (Theme, Key, Style, Tempo, Season) to narrow results</li>
            <li>Click song title to edit details</li>
            <li>Add multiple YouTube links and attachments per song</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-slate-800 mb-2"><i class="fa-solid fa-pen-to-square mr-2 text-purple-500"></i> Lyrics Editor</h4>
          <ul class="list-disc list-inside space-y-1 ml-4">
            <li>Use section buttons to insert Verse, Chorus, Bridge, etc.</li>
            <li>Type chords on the line above lyrics</li>
            <li>Preview "Lyrics Only" or "Lyrics + Chords"</li>
            <li>Section headers show in records but not during projection</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-slate-800 mb-2"><i class="fa-solid fa-table mr-2 text-teal-500"></i> Worship Roster</h4>
          <ul class="list-disc list-inside space-y-1 ml-4">
            <li>Double-click any cell to edit</li>
            <li>Right-click to see previous 5 entries for that cell</li>
            <li>Click WhatsApp icon to share that service's roster</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: CREATE ORDER ==================== -->
  <div id="createOrderModal" class="modal-overlay">
    <div class="modal-content" style="width: min(600px, 95%); padding: 20px;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h3 class="font-cinzel text-xl font-bold text-slate-800">
          <i class="fa-solid fa-calendar-plus mr-2 text-purple-500"></i> Create Worship Order
        </h3>
        <button id="closeCreateOrderBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="form-label" for="orderTitle">Order Title *</label>
          <input id="orderTitle" class="form-input" placeholder="e.g. Sunday Service - January 5, 2026">
        </div>
        <div>
          <label class="form-label" for="orderDate">Service Date</label>
          <input id="orderDate" type="date" class="form-input">
        </div>
        <div>
          <label class="form-label" for="orderTemplate">Template</label>
          <select id="orderTemplate" class="form-input">
            <option value="">Blank Order</option>
            <option value="standard">Standard Sunday Service</option>
            <option value="communion">Communion Service</option>
            <option value="special">Special Service</option>
          </select>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-5 pt-4 border-t border-slate-200">
        <button id="cancelCreateOrderBtn" class="lhc-pill-button">
          <i class="fa-solid fa-xmark mr-1"></i> Cancel
        </button>
        <button id="saveNewOrderBtn" class="roster-action-btn primary">
          <i class="fa-solid fa-plus mr-1"></i> Create Order
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODAL: LYRICS VIEWER (for viewing saved lyrics) ==================== -->
  <div id="lyricsModal" class="modal-overlay">
    <div class="modal-content" style="width: min(900px, 95%); padding: 20px;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <div>
          <h3 id="lyricsModalTitle" class="font-cinzel text-xl font-bold text-slate-800">
            <i class="fa-solid fa-file-lines mr-2 text-indigo-500"></i> Song Lyrics
          </h3>
          <p id="lyricsModalArtist" class="text-sm text-slate-500 mt-1"></p>
        </div>
        <button id="closeLyricsBtn" class="lhc-pill-button" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
        <div class="flex gap-2">
          <button id="lyricsModeOverall" class="lhc-pill-button lhc-pill-button-active text-sm">
            <i class="fa-solid fa-file-lines mr-1"></i> Lyrics Only
          </button>
          <button id="lyricsModeChords" class="lhc-pill-button text-sm">
            <i class="fa-solid fa-guitar mr-1"></i> Lyrics + Chords
          </button>
          <button id="lyricsModePresent" class="lhc-pill-button text-sm">
            <i class="fa-solid fa-presentation-screen mr-1"></i> Present
          </button>
        </div>
        <div class="flex items-center gap-2">
          <button id="lyricsPrevSlide" class="lhc-pill-button text-sm" title="Previous Slide">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <span id="lyricsSlideCounter" class="text-sm text-slate-500 min-w-[60px] text-center">0 / 0</span>
          <button id="lyricsNextSlide" class="lhc-pill-button text-sm" title="Next Slide">
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <div id="lyricsContentArea" class="bg-slate-50 rounded-xl p-5 min-h-[250px] max-h-[55vh] overflow-y-auto">
        <div id="lyricsTextDisplay" class="preview-lyrics"></div>
      </div>

      <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-200">
        <p class="text-xs text-slate-400">
          <i class="fa-solid fa-keyboard mr-1"></i> Use arrow keys to navigate slides
        </p>
        <div class="flex gap-2">
          <button id="lyricsEditBtn" class="lhc-pill-button text-sm" style="background: #fef3c7; color: #92400e; border-color: #fcd34d;">
            <i class="fa-solid fa-pen mr-1"></i> Edit
          </button>
        </div>
      </div>
    </div>
  </div>

<!-- JavaScript for modal features -->
<script>
// Data storage for song modals - make globally accessible
window.songData = {
  new: { youtube: [], attachments: [], lyrics: '' },
  edit: { youtube: [], attachments: [], lyrics: '' }
};
var songData = window.songData; // local reference
var currentLyricsMode = 'new';

// ============ Theme Multi-Select Management ============
function toggleThemeDropdown(mode) {
  var dropdown = document.getElementById(mode + 'SongThemeDropdown');
  if (dropdown) {
    dropdown.classList.toggle('hidden');
  }
}

function updateThemeSelection(mode) {
  var container = document.getElementById(mode + 'SongThemeDropdown');
  var display = document.getElementById(mode + 'SongThemeDisplay');
  var hidden = document.getElementById(mode + 'SongTheme');
  
  if (!container) return;
  
  var checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
  var values = [];
  checkboxes.forEach(function(cb) {
    values.push(cb.value);
  });
  
  if (values.length === 0) {
    display.textContent = 'Select themes...';
  } else if (values.length <= 3) {
    display.textContent = values.join(', ');
  } else {
    display.textContent = values.slice(0, 2).join(', ') + ' +' + (values.length - 2) + ' more';
  }
  
  hidden.value = values.join(', ');
}

function addCustomTheme(mode) {
  var input = document.getElementById(mode + 'ThemeInput');
  var dropdown = document.getElementById(mode + 'SongThemeDropdown');
  var newTheme = input.value.trim();
  
  if (!newTheme) return;
  
  // Check if already exists
  var existing = dropdown.querySelector('input[value="' + newTheme + '"]');
  if (existing) {
    existing.checked = true;
    updateThemeSelection(mode);
    input.value = '';
    return;
  }
  
  // Add new option
  var addNewDiv = dropdown.querySelector('.theme-add-new');
  var newOption = document.createElement('div');
  newOption.className = 'theme-option';
  newOption.innerHTML = '<label><input type="checkbox" value="' + escapeHtmlModal(newTheme) + '" checked onchange="updateThemeSelection(\'' + mode + '\')"> ' + escapeHtmlModal(newTheme) + '</label>';
  dropdown.insertBefore(newOption, addNewDiv);
  
  updateThemeSelection(mode);
  input.value = '';
}

function setThemeSelection(mode, themesStr) {
  var container = document.getElementById(mode + 'SongThemeDropdown');
  if (!container) return;
  
  // Uncheck all first
  container.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
    cb.checked = false;
  });
  
  if (!themesStr) {
    updateThemeSelection(mode);
    return;
  }
  
  var themes = themesStr.split(/[,;]+/).map(function(t) { return t.trim(); });
  themes.forEach(function(theme) {
    var cb = container.querySelector('input[value="' + theme + '"]');
    if (cb) {
      cb.checked = true;
    } else if (theme) {
      // Add as new option
      var addNewDiv = container.querySelector('.theme-add-new');
      var newOption = document.createElement('div');
      newOption.className = 'theme-option';
      newOption.innerHTML = '<label><input type="checkbox" value="' + escapeHtmlModal(theme) + '" checked onchange="updateThemeSelection(\'' + mode + '\')"> ' + escapeHtmlModal(theme) + '</label>';
      container.insertBefore(newOption, addNewDiv);
    }
  });
  
  updateThemeSelection(mode);
}

// Close theme dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.theme-multiselect')) {
    document.querySelectorAll('.theme-dropdown').forEach(function(dd) {
      dd.classList.add('hidden');
    });
  }
});

// ============ Lyrics Preview Functions (Fixed) ============
var currentLyricsPreviewSong = null;
var currentLyricsPreviewMode = 'lyrics';
var currentTransposeValue = 0;

function switchLyricsPreviewMode(mode) {
  currentLyricsPreviewMode = mode;
  
  document.getElementById('lyricsPreviewLyricsBtn').classList.toggle('lhc-pill-button-active', mode === 'lyrics');
  document.getElementById('lyricsPreviewChordsBtn').classList.toggle('lhc-pill-button-active', mode === 'chords');
  
  // Show/hide transpose dropdown
  var transposeContainer = document.getElementById('transposeContainer');
  if (transposeContainer) {
    transposeContainer.style.display = mode === 'chords' ? 'flex' : 'none';
  }
  
  renderLyricsPreviewContent();
}

function renderLyricsPreviewContent() {
  var container = document.getElementById('lyricsPreviewContent');
  if (!container || !currentLyricsPreviewSong) return;
  
  var lyrics = currentLyricsPreviewSong.lyrics || '';
  if (!lyrics.trim()) {
    container.innerHTML = '<div class="p-8 text-center text-slate-400"><i class="fa-solid fa-file-lines text-4xl mb-3 opacity-50"></i><p>No lyrics available for this song.</p></div>';
    return;
  }
  
  var showChords = currentLyricsPreviewMode === 'chords';
  container.innerHTML = formatLyricsWithTranspose(lyrics, showChords, currentTransposeValue);
}

function applyTranspose() {
  var select = document.getElementById('transposeSelect');
  currentTransposeValue = parseInt(select.value) || 0;
  renderLyricsPreviewContent();
}

function formatLyricsWithTranspose(text, showChords, transposeSteps) {
  var lines = text.split('\n');
  var html = '';
  var NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  var NOTE_MAP = {'Db': 'C#', 'Eb': 'D#', 'Fb': 'E', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#', 'Cb': 'B'};
  
  function transposeChord(chord, steps) {
    if (steps === 0) return chord;
    return chord.replace(/([A-G])([#b]?)/, function(match, note, accidental) {
      var normalNote = note + accidental;
      if (NOTE_MAP[normalNote]) normalNote = NOTE_MAP[normalNote];
      var idx = NOTES.indexOf(normalNote.charAt(0) + (normalNote.length > 1 ? '#' : ''));
      if (idx === -1) idx = NOTES.indexOf(normalNote.charAt(0));
      if (idx === -1) return match;
      var newIdx = (idx + steps + 12) % 12;
      return NOTES[newIdx];
    });
  }
  
  var isChordLine = function(line) {
    var trimmed = line.trim();
    if (!trimmed) return false;
    var chordPattern = /^[\sA-G#bmdimaug7sus249\/\(\)\-]+$/i;
    return chordPattern.test(trimmed) && /[A-G]/.test(trimmed);
  };
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    var trimmed = line.trim();
    
    if (trimmed.match(/^\[.+\]$/)) {
      var sectionName = trimmed.slice(1, -1);
      html += '<div class="section-header">' + escapeHtmlModal(sectionName) + '</div>';
    } else if (isChordLine(line)) {
      if (showChords) {
        var transposedLine = line.replace(/[A-G][#b]?m?(aj|in|dim|aug|sus|add)?[0-9]*/g, function(chord) {
          return transposeChord(chord, transposeSteps);
        });
        html += '<div class="chord-line">' + escapeHtmlModal(transposedLine) + '</div>';
      }
    } else if (trimmed) {
      html += '<div class="lyric-line">' + escapeHtmlModal(line) + '</div>';
    } else {
      html += '<div style="height: 12px;"></div>';
    }
  }
  
  return html;
}

// ============ Lyrics Editor Formatting Functions ============
var lyricsHistory = [];
var lyricsHistoryIndex = -1;
var lyricsMaxHistory = 50;

function saveLyricsState() {
  var textarea = document.getElementById('lyricsEditorTextarea');
  if (!textarea) return;
  
  var currentContent = textarea.value;
  
  // If we're not at the end, remove forward history
  if (lyricsHistoryIndex < lyricsHistory.length - 1) {
    lyricsHistory = lyricsHistory.slice(0, lyricsHistoryIndex + 1);
  }
  
  // Don't save if same as last state
  if (lyricsHistory.length > 0 && lyricsHistory[lyricsHistory.length - 1] === currentContent) {
    return;
  }
  
  lyricsHistory.push(currentContent);
  if (lyricsHistory.length > lyricsMaxHistory) {
    lyricsHistory.shift();
  }
  lyricsHistoryIndex = lyricsHistory.length - 1;
}

function lyricsUndo() {
  if (lyricsHistoryIndex > 0) {
    lyricsHistoryIndex--;
    var textarea = document.getElementById('lyricsEditorTextarea');
    if (textarea) {
      textarea.value = lyricsHistory[lyricsHistoryIndex];
      updateLyricsPreview();
    }
  }
}

function lyricsRedo() {
  if (lyricsHistoryIndex < lyricsHistory.length - 1) {
    lyricsHistoryIndex++;
    var textarea = document.getElementById('lyricsEditorTextarea');
    if (textarea) {
      textarea.value = lyricsHistory[lyricsHistoryIndex];
      updateLyricsPreview();
    }
  }
}

function applyLyricsFormat(type, value) {
  var textarea = document.getElementById('lyricsEditorTextarea');
  if (!textarea) return;
  
  if (type === 'fontFamily') {
    textarea.style.fontFamily = value;
  } else if (type === 'fontSize') {
    textarea.style.fontSize = value;
  }
  // Note: Bold, italic, underline don't apply to textarea content directly
  // They would need a contenteditable div for rich text
}

function scanAttachmentsForLyrics() {
  var mode = currentLyricsMode;
  var attachments = songData[mode] ? songData[mode].attachments : [];
  
  if (!attachments || attachments.length === 0) {
    showLyricsScanModal('<div class="p-6 text-center"><i class="fa-solid fa-file-circle-question text-4xl text-slate-300 mb-4"></i><p class="text-slate-600">No attachments found.</p><p class="text-sm text-slate-400 mt-2">Please add a document or image attachment first, then try scanning again.</p></div>');
    return;
  }
  
  // Show selection modal
  showAttachmentSelectorForScan(attachments);
}

function showAttachmentSelectorForScan(attachments) {
  var html = '<div class="p-5">';
  html += '<h4 class="font-semibold text-slate-700 mb-4">Select document to scan:</h4>';
  html += '<div class="space-y-2">';
  attachments.forEach(function(att, idx) {
    var icon = 'fa-file';
    var iconColor = 'text-slate-400';
    if (att.type === 'GDOC') { icon = 'fa-file-word'; iconColor = 'text-blue-500'; }
    else if (att.type === 'PDF') { icon = 'fa-file-pdf'; iconColor = 'text-red-500'; }
    else if (att.type === 'IMG' || att.type === 'IMAGE') { icon = 'fa-file-image'; iconColor = 'text-purple-500'; }
    else if (att.type === 'DRIVE') { icon = 'fa-google-drive'; iconColor = 'text-yellow-500'; }
    
    html += '<button class="scan-doc-option w-full text-left p-4 rounded-xl bg-slate-50 hover:bg-indigo-50 hover:border-indigo-300 border-2 border-transparent transition-all" data-idx="' + idx + '">';
    html += '<div class="flex items-center gap-3">';
    html += '<i class="fa-solid ' + icon + ' text-xl ' + iconColor + '"></i>';
    html += '<div class="flex-1 min-w-0">';
    html += '<div class="font-medium text-slate-700 truncate">' + escapeHtmlModal(att.name || 'Document ' + (idx + 1)) + '</div>';
    html += '<div class="text-xs text-slate-400">' + escapeHtmlModal(att.type || 'File') + '</div>';
    html += '</div>';
    html += '<i class="fa-solid fa-chevron-right text-slate-300"></i>';
    html += '</div>';
    html += '</button>';
  });
  html += '</div>';
  html += '</div>';
  
  showLyricsScanModal(html);
  
  // Bind click events after modal is shown
  setTimeout(function() {
    document.querySelectorAll('.scan-doc-option').forEach(function(btn) {
      btn.onclick = function() {
        var idx = parseInt(btn.getAttribute('data-idx'));
        var att = songData[currentLyricsMode].attachments[idx];
        performLyricsScan(att);
      };
    });
  }, 100);
}

function performLyricsScan(attachment) {
  if (!attachment || !attachment.url) {
    showLyricsScanModal('<div class="p-6 text-center"><i class="fa-solid fa-exclamation-triangle text-4xl text-amber-400 mb-4"></i><p class="text-slate-600">Invalid attachment</p></div>');
    return;
  }
  
  // Show loading state
  showLyricsScanModal('<div class="p-8 text-center"><div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 border-t-indigo-600 mb-4"></div><p class="font-medium text-slate-700">Scanning document...</p><p class="text-sm text-slate-400 mt-2">Extracting lyrics and chords</p></div>');
  
  // Use window.callGAS to ensure we get the global function
  var gasCall = window.callGAS || (typeof google !== 'undefined' && google.script && google.script.run);
  
  if (window.callGAS) {
    window.callGAS('scanDocumentForLyrics', [attachment.url]).then(function(result) {
      handleScanResult(result);
    }).catch(function(err) {
      console.error('Scan error:', err);
      showLyricsScanModal('<div class="p-6 text-center"><i class="fa-solid fa-triangle-exclamation text-4xl text-red-400 mb-4"></i><p class="font-medium text-slate-700">Scan failed</p><p class="text-sm text-slate-400 mt-2">' + escapeHtmlModal(String(err)) + '</p></div>');
    });
  } else if (typeof google !== 'undefined' && google.script && google.script.run) {
    // Direct Google Apps Script call
    google.script.run
      .withSuccessHandler(function(result) {
        handleScanResult(result);
      })
      .withFailureHandler(function(err) {
        console.error('Scan error:', err);
        showLyricsScanModal('<div class="p-6 text-center"><i class="fa-solid fa-triangle-exclamation text-4xl text-red-400 mb-4"></i><p class="font-medium text-slate-700">Scan failed</p><p class="text-sm text-slate-400 mt-2">' + escapeHtmlModal(String(err)) + '</p></div>');
      })
      .scanDocumentForLyrics(attachment.url);
  } else {
    showLyricsScanModal('<div class="p-6 text-center"><i class="fa-solid fa-plug-circle-xmark text-4xl text-red-400 mb-4"></i><p class="font-medium text-slate-700">Not connected</p><p class="text-sm text-slate-400 mt-2">Please make sure you are running this from the deployed web app, not a local file.</p></div>');
  }
}

function handleScanResult(result) {
  if (result && result.lyrics && result.lyrics.trim()) {
    var textarea = document.getElementById('lyricsEditorTextarea');
    if (textarea) {
      saveLyricsState();
      
      // If there's existing content, ask whether to replace or append
      if (textarea.value.trim()) {
        showLyricsScanModal('<div class="p-5"><h4 class="font-semibold text-slate-700 mb-4"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>Lyrics extracted successfully!</h4><p class="text-sm text-slate-500 mb-4">You already have content in the editor. What would you like to do?</p><div class="space-y-2"><button class="scan-action-btn w-full p-3 rounded-lg bg-indigo-500 text-white font-medium hover:bg-indigo-600 transition" data-action="replace"><i class="fa-solid fa-rotate mr-2"></i>Replace existing lyrics</button><button class="scan-action-btn w-full p-3 rounded-lg bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 transition" data-action="append"><i class="fa-solid fa-plus mr-2"></i>Append to existing lyrics</button><button class="scan-action-btn w-full p-3 rounded-lg bg-white border text-slate-500 hover:bg-slate-50 transition" data-action="cancel"><i class="fa-solid fa-xmark mr-2"></i>Cancel</button></div></div>');
        
        // Store the result for action buttons
        window._scanResult = result;
        
        // Bind action buttons
        setTimeout(function() {
          document.querySelectorAll('.scan-action-btn').forEach(function(btn) {
            btn.onclick = function() {
              var action = btn.getAttribute('data-action');
              var textarea = document.getElementById('lyricsEditorTextarea');
              if (action === 'replace') {
                textarea.value = window._scanResult.lyrics;
              } else if (action === 'append') {
                textarea.value = textarea.value + '\n\n' + window._scanResult.lyrics;
              }
              if (action !== 'cancel') {
                updateLyricsPreview();
                saveLyricsState();
              }
              closeScanModal();
              if (action !== 'cancel' && typeof showToast === 'function') {
                showToast('Lyrics extracted successfully!', 'success');
              } else if (action !== 'cancel' && window.showToast) {
                window.showToast('Lyrics extracted successfully!', 'success');
              }
            };
          });
        }, 100);
      } else {
        // No existing content, just set it
        textarea.value = result.lyrics;
        updateLyricsPreview();
        saveLyricsState();
        closeScanModal();
        if (typeof showToast === 'function') {
          showToast('Lyrics extracted successfully!', 'success');
        } else if (window.showToast) {
          window.showToast('Lyrics extracted successfully!', 'success');
        }
      }
    }
  } else {
    var errorMsg = result && result.error ? result.error : 'Could not extract text from this document.';
    showLyricsScanModal('<div class="p-6 text-center"><i class="fa-solid fa-file-circle-xmark text-4xl text-amber-400 mb-4"></i><p class="font-medium text-slate-700">Could not extract lyrics</p><p class="text-sm text-slate-400 mt-2">' + escapeHtmlModal(errorMsg) + '</p><p class="text-xs text-slate-400 mt-3">Try copying and pasting manually from the document.</p></div>');
  }
}

function showLyricsScanModal(content) {
  var modal = document.getElementById('lyricsScanModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'lyricsScanModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'z-index: 100000 !important;';
    modal.innerHTML = '<div class="modal-content" style="width: min(420px, 90%); padding: 0; z-index: 100001; border-radius: 16px; overflow: hidden;"><div class="flex items-center justify-between p-4 border-b border-slate-200 bg-gradient-to-r from-emerald-500 to-teal-500"><h4 class="font-semibold text-white flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Scan Lyrics</h4><button onclick="closeScanModal()" class="text-white/80 hover:text-white transition"><i class="fa-solid fa-xmark text-lg"></i></button></div><div id="lyricsScanContent"></div></div>';
    document.body.appendChild(modal);
  }
  
  document.getElementById('lyricsScanContent').innerHTML = content;
  modal.classList.add('show');
}

function closeScanModal() {
  var modal = document.getElementById('lyricsScanModal');
  if (modal) modal.classList.remove('show');
}

// Make functions globally accessible
window.lyricsUndo = lyricsUndo;
window.lyricsRedo = lyricsRedo;
window.applyLyricsFormat = applyLyricsFormat;
window.scanAttachmentsForLyrics = scanAttachmentsForLyrics;
window.performLyricsScan = performLyricsScan;
window.closeScanModal = closeScanModal;

function closeLyricsPreviewModal() {
  var modal = document.getElementById('lyricsPreviewModal');
  if (modal) modal.classList.remove('show');
  currentTransposeValue = 0;
  var select = document.getElementById('transposeSelect');
  if (select) select.value = '0';
}

function printLyricsPreview() {
  if (!currentLyricsPreviewSong) return;
  
  var showChords = currentLyricsPreviewMode === 'chords';
  var content = formatLyricsWithTranspose(currentLyricsPreviewSong.lyrics || '', showChords, currentTransposeValue);
  
  var printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>' + escapeHtmlModal(currentLyricsPreviewSong.title) + '</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('@page { margin: 1in; size: letter; }');
  printWindow.document.write('@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }');
  printWindow.document.write('body { font-family: Georgia, serif; padding: 0; margin: 0; max-width: 100%; }');
  printWindow.document.write('.song-title { font-size: 28px; font-weight: bold; text-align: center; margin: 0 0 8px 0; }');
  printWindow.document.write('.song-artist { font-size: 14px; text-align: center; color: #666; margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 1px solid #ccc; }');
  printWindow.document.write('.section-header { font-weight: bold; color: #333; margin: 20px 0 10px 0; font-size: 12px; text-transform: uppercase; }');
  printWindow.document.write('.chord-line { color: #c00; font-weight: bold; font-family: Courier New, monospace; white-space: pre; margin-bottom: 0; font-size: 12px; }');
  printWindow.document.write('.lyric-line { font-size: 14px; line-height: 1.6; margin: 0; }');
  printWindow.document.write('</style></head><body>');
  printWindow.document.write('<h1 class="song-title">' + escapeHtmlModal(currentLyricsPreviewSong.title) + '</h1>');
  if (currentLyricsPreviewSong.artist) {
    printWindow.document.write('<p class="song-artist">' + escapeHtmlModal(currentLyricsPreviewSong.artist) + '</p>');
  } else {
    printWindow.document.write('<p class="song-artist">&nbsp;</p>');
  }
  printWindow.document.write(content);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  
  setTimeout(function() {
    printWindow.print();
  }, 300);
}

// Make functions globally accessible
window.switchLyricsPreviewMode = switchLyricsPreviewMode;
window.applyTranspose = applyTranspose;
window.closeLyricsPreviewModal = closeLyricsPreviewModal;
window.printLyricsPreview = printLyricsPreview;
window.toggleThemeDropdown = toggleThemeDropdown;
window.updateThemeSelection = updateThemeSelection;
window.addCustomTheme = addCustomTheme;
window.setThemeSelection = setThemeSelection;

// Set current song for lyrics preview (called from Part 5)
window.setLyricsPreviewSong = function(song) {
  currentLyricsPreviewSong = song;
  currentLyricsPreviewMode = 'lyrics';
  currentTransposeValue = 0;
  
  document.getElementById('lyricsPreviewTitle').textContent = song.title || '';
  document.getElementById('lyricsPreviewArtist').textContent = song.artist || '';
  
  var lastEdited = document.getElementById('lyricsPreviewLastEdited');
  if (lastEdited && song.lastEdited) {
    try {
      var d = new Date(song.lastEdited);
      lastEdited.textContent = 'Last edited: ' + d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    } catch(e) {
      lastEdited.textContent = '';
    }
  } else if (lastEdited) {
    lastEdited.textContent = '';
  }
  
  document.getElementById('lyricsPreviewLyricsBtn').classList.add('lhc-pill-button-active');
  document.getElementById('lyricsPreviewChordsBtn').classList.remove('lhc-pill-button-active');
  document.getElementById('transposeContainer').style.display = 'none';
  document.getElementById('transposeSelect').value = '0';
  
  renderLyricsPreviewContent();
};

// ============ YouTube Link Management ============
function addYoutubeLink(mode) {
  var input = document.getElementById(mode + 'SongYoutubeInput');
  var url = input.value.trim();
  if (!url) return;
  
  // Validate YouTube URL
  if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
    alert('Please enter a valid YouTube URL');
    return;
  }
  
  // Add with placeholder name, then try to fetch actual title
  var videoData = { url: url, title: 'Loading...' };
  songData[mode].youtube.push(url);
  var idx = songData[mode].youtube.length - 1;
  input.value = '';
  renderYoutubeLinks(mode);
  
  // Try to fetch actual video title
  fetchYoutubeTitle(url, function(title) {
    if (title && window.songYoutubeTitles) {
      window.songYoutubeTitles[url] = title;
      renderYoutubeLinks(mode);
    }
  });
}

// Store YouTube titles globally
window.songYoutubeTitles = window.songYoutubeTitles || {};

function fetchYoutubeTitle(url, callback) {
  var videoId = extractYoutubeId(url);
  if (!videoId) {
    callback('YouTube Video');
    return;
  }
  
  // Try oEmbed API (no auth required)
  try {
    var oembedUrl = 'https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=' + videoId + '&format=json';
    fetch(oembedUrl)
      .then(function(response) { return response.json(); })
      .then(function(data) {
        callback(data.title || 'YouTube Video');
      })
      .catch(function() {
        // Fallback to server call
        if (window.callGAS) {
          window.callGAS('getYouTubeVideoTitle', [url]).then(function(result) {
            callback(result && result.title ? result.title : 'YouTube Video');
          }).catch(function() {
            callback('YouTube Video');
          });
        } else {
          callback('YouTube Video');
        }
      });
  } catch (e) {
    callback('YouTube Video');
  }
}

function removeYoutubeLink(mode, index) {
  songData[mode].youtube.splice(index, 1);
  renderYoutubeLinks(mode);
}

function renderYoutubeLinks(mode) {
  var container = document.getElementById(mode + 'SongYoutubeList');
  if (!container) return;
  
  if (songData[mode].youtube.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  var html = '';
  songData[mode].youtube.forEach(function(url, idx) {
    var videoId = extractYoutubeId(url);
    // Use stored title or fallback
    var title = (window.songYoutubeTitles && window.songYoutubeTitles[url]) || 'YouTube Video ' + (idx + 1);
    html += '<div class="link-item">';
    html += '<i class="fa-brands fa-youtube file-icon" style="color:#ef4444;"></i>';
    html += '<div class="link-info"><span class="link-name">' + escapeHtmlModal(title) + '</span></div>';
    html += '<div class="link-actions">';
    html += '<button class="link-btn preview" onclick="previewYoutube(\'' + escapeHtmlModal(url) + '\')"><i class="fa-solid fa-play"></i> Play</button>';
    html += '<button class="link-btn remove" onclick="removeYoutubeLink(\'' + mode + '\', ' + idx + ')"><i class="fa-solid fa-xmark"></i></button>';
    html += '</div></div>';
  });
  container.innerHTML = html;
}

function extractYoutubeId(url) {
  var match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([^?&]+)/);
  return match ? match[1] : '';
}

function previewYoutube(url) {
  var videoId = extractYoutubeId(url);
  if (!videoId) return;
  
  var modal = document.getElementById('youtubePreviewModal');
  var frame = document.getElementById('youtubePreviewFrame');
  frame.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
  modal.classList.add('show');
}

function closeYoutubePreview() {
  var modal = document.getElementById('youtubePreviewModal');
  var frame = document.getElementById('youtubePreviewFrame');
  frame.src = '';
  modal.classList.remove('show');
}

function closeDocPreview() {
  var modal = document.getElementById('docPreviewModal');
  var frame = document.getElementById('docPreviewFrame');
  if (frame) frame.src = '';
  if (modal) modal.classList.remove('show');
}

// Make globally accessible
window.closeDocPreview = closeDocPreview;
window.closeYoutubePreview = closeYoutubePreview;

// ============ Attachment Management ============
// Store file names globally
window.songFileNames = window.songFileNames || {};

function addAttachment(mode) {
  var input = document.getElementById(mode + 'SongDocUrl');
  var url = input.value.trim();
  
  // If empty, try to open Google Drive picker
  if (!url) {
    openGoogleDrivePicker(mode);
    return;
  }
  
  var fileInfo = parseFileUrl(url);
  songData[mode].attachments.push(fileInfo);
  input.value = '';
  renderAttachments(mode);
  
  // Try to fetch actual file name from server
  fetchFileName(url, function(name, type) {
    if (name && window.songFileNames) {
      window.songFileNames[url] = { name: name, type: type };
      renderAttachments(mode);
    }
  });
}

function fetchFileName(url, callback) {
  if (window.callGAS) {
    window.callGAS('getFileInfoFromUrl', [url]).then(function(result) {
      if (result && result.name) {
        callback(result.name, result.type);
      } else {
        callback(null, null);
      }
    }).catch(function() {
      callback(null, null);
    });
  } else if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.name) {
          callback(result.name, result.type);
        } else {
          callback(null, null);
        }
      })
      .withFailureHandler(function() {
        callback(null, null);
      })
      .getFileInfoFromUrl(url);
  } else {
    callback(null, null);
  }
}

function openGoogleDrivePicker(mode) {
  // Show instructions modal for Google Drive picker
  var modal = document.createElement('div');
  modal.className = 'modal-overlay show';
  modal.style.zIndex = '100000';
  modal.innerHTML = '<div class="modal-content" style="width: min(450px, 90%); padding: 0; border-radius: 16px; overflow: hidden;">' +
    '<div class="p-4 border-b border-slate-200 bg-gradient-to-r from-blue-500 to-indigo-500">' +
    '<h4 class="font-semibold text-white flex items-center gap-2"><i class="fa-brands fa-google-drive"></i> Add from Google Drive</h4>' +
    '</div>' +
    '<div class="p-5">' +
    '<p class="text-slate-600 mb-4">To add a file from Google Drive:</p>' +
    '<ol class="list-decimal list-inside space-y-2 text-sm text-slate-600 mb-4">' +
    '<li>Open <a href="https://drive.google.com" target="_blank" class="text-blue-500 underline">Google Drive</a> in a new tab</li>' +
    '<li>Right-click on your file</li>' +
    '<li>Select "Get link" or "Share"</li>' +
    '<li>Copy the link</li>' +
    '<li>Paste it in the URL field</li>' +
    '</ol>' +
    '<div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-700">' +
    '<i class="fa-solid fa-lightbulb mr-1"></i> <strong>Tip:</strong> Make sure the file is shared as "Anyone with the link can view"' +
    '</div>' +
    '</div>' +
    '<div class="p-4 border-t border-slate-200 flex justify-end">' +
    '<button class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-medium hover:bg-indigo-600" onclick="this.closest(\'.modal-overlay\').remove()">Got it</button>' +
    '</div>' +
    '</div>';
  document.body.appendChild(modal);
  modal.onclick = function(e) {
    if (e.target === modal) modal.remove();
  };
}

function removeAttachment(mode, index) {
  songData[mode].attachments.splice(index, 1);
  renderAttachments(mode);
}

function parseFileUrl(url) {
  var info = { url: url, name: 'Document', ext: 'link', icon: 'fa-link' };
  
  // Try to extract file info from URL
  if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
    info.icon = 'fa-google-drive';
    if (url.includes('/document/')) {
      info.name = 'Google Doc';
      info.ext = 'gdoc';
      info.icon = 'fa-file-word';
    } else if (url.includes('/spreadsheets/')) {
      info.name = 'Google Sheet';
      info.ext = 'gsheet';
    } else if (url.includes('/presentation/')) {
      info.name = 'Google Slides';
      info.ext = 'gslides';
    } else if (url.includes('/file/d/')) {
      // Try to guess from URL or use generic
      info.name = 'Google Drive File';
      info.ext = 'file';
    }
  } else {
    // Check file extension from URL
    var extMatch = url.match(/\.([a-zA-Z0-9]+)(?:\?|$)/);
    if (extMatch) {
      var ext = extMatch[1].toLowerCase();
      info.ext = ext;
      if (ext === 'pdf') { info.icon = 'fa-file-pdf'; info.name = 'PDF Document'; }
      else if (ext === 'doc' || ext === 'docx') { info.icon = 'fa-file-word'; info.name = 'Word Document'; }
      else if (ext === 'jpg' || ext === 'jpeg' || ext === 'png' || ext === 'gif') { info.icon = 'fa-file-image'; info.name = 'Image'; }
      else if (ext === 'ppt' || ext === 'pptx') { info.icon = 'fa-file-powerpoint'; info.name = 'Presentation'; }
    }
  }
  
  // Try to get filename from URL
  var pathMatch = url.match(/\/([^\/\?]+)(?:\?|$)/);
  if (pathMatch && pathMatch[1].includes('.')) {
    info.name = decodeURIComponent(pathMatch[1].split('.')[0]);
  }
  
  return info;
}

function renderAttachments(mode) {
  var container = document.getElementById(mode + 'SongAttachments');
  if (!container) return;
  
  if (songData[mode].attachments.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  var html = '';
  songData[mode].attachments.forEach(function(att, idx) {
    // Check if we have a fetched name
    var displayName = att.name;
    var displayType = att.ext;
    if (window.songFileNames && window.songFileNames[att.url]) {
      displayName = window.songFileNames[att.url].name || displayName;
      displayType = window.songFileNames[att.url].type || displayType;
    }
    
    // Get appropriate icon based on type
    var icon = att.icon;
    if (displayType === 'GDOC') icon = 'fa-file-word';
    else if (displayType === 'PDF') icon = 'fa-file-pdf';
    else if (displayType === 'IMAGE') icon = 'fa-file-image';
    else if (displayType === 'GSHEET') icon = 'fa-file-excel';
    else if (displayType === 'GSLIDE') icon = 'fa-file-powerpoint';
    
    // Color based on type
    var iconColor = '#64748b';
    if (displayType === 'GDOC' || displayType === 'gdoc') iconColor = '#3b82f6';
    else if (displayType === 'PDF' || displayType === 'pdf') iconColor = '#ef4444';
    else if (displayType === 'IMAGE' || displayType === 'image') iconColor = '#a855f7';
    else if (displayType === 'GSHEET' || displayType === 'gsheet') iconColor = '#22c55e';
    
    html += '<div class="link-item">';
    html += '<i class="fa-solid ' + icon + ' file-icon" style="color:' + iconColor + ';"></i>';
    html += '<div class="link-info"><span class="link-name">' + escapeHtmlModal(displayName) + '</span><span class="link-ext">' + (displayType || att.ext).toUpperCase() + '</span></div>';
    html += '<div class="link-actions">';
    html += '<button class="link-btn preview" onclick="previewAttachment(\'' + escapeHtmlModal(att.url) + '\')"><i class="fa-solid fa-eye"></i></button>';
    html += '<button class="link-btn remove" onclick="removeAttachment(\'' + mode + '\', ' + idx + ')"><i class="fa-solid fa-xmark"></i></button>';
    html += '</div></div>';
  });
  container.innerHTML = html;
}

function previewAttachment(url) {
  var modal = document.getElementById('previewModal');
  var frame = document.getElementById('previewFrame');
  var title = document.getElementById('previewModalTitle');
  
  if (url.includes('drive.google.com/file/d/')) {
    var fileId = url.match(/\/d\/([^\/\?]+)/);
    if (fileId) {
      frame.src = 'https://drive.google.com/file/d/' + fileId[1] + '/preview';
    }
  } else if (url.includes('docs.google.com')) {
    frame.src = url.replace('/edit', '/preview').replace('/view', '/preview');
  } else {
    frame.src = url;
  }
  
  title.innerHTML = '<i class="fa-solid fa-eye mr-2 text-indigo-500"></i> Document Preview';
  modal.classList.add('show');
}

// ============ Lyrics Editor ============
function openLyricsEditor(mode) {
  currentLyricsMode = mode;
  var modal = document.getElementById('lyricsEditorModal');
  var textarea = document.getElementById('lyricsEditorTextarea');
  textarea.value = songData[mode].lyrics || '';
  modal.classList.add('show');
  textarea.focus();
}

function closeLyricsEditor() {
  var modal = document.getElementById('lyricsEditorModal');
  modal.classList.remove('show');
}

function saveLyricsEditor() {
  var textarea = document.getElementById('lyricsEditorTextarea');
  var lyrics = textarea.value;
  songData[currentLyricsMode].lyrics = lyrics;
  
  // Update hidden field
  var hiddenField = document.getElementById(currentLyricsMode + 'SongLyricsData');
  if (hiddenField) hiddenField.value = lyrics;
  
  // Update summary
  var summary = document.getElementById(currentLyricsMode + 'SongLyricsSummary');
  var info = document.getElementById(currentLyricsMode + 'SongLyricsInfo');
  if (summary && lyrics.trim()) {
    var lines = lyrics.split('\n').filter(function(l) { return l.trim(); }).length;
    var sections = (lyrics.match(/\[.+\]/g) || []).length;
    info.textContent = sections + ' section(s), ' + lines + ' lines';
    summary.classList.remove('hidden');
  } else if (summary) {
    summary.classList.add('hidden');
  }
  
  closeLyricsEditor();
}

function insertSection(sectionName) {
  var textarea = document.getElementById('lyricsEditorTextarea');
  var pos = textarea.selectionStart;
  var text = textarea.value;
  var insertion = '\n[' + sectionName + ']\n';
  textarea.value = text.slice(0, pos) + insertion + text.slice(pos);
  textarea.selectionStart = textarea.selectionEnd = pos + insertion.length;
  textarea.focus();
}

// ============ Preview Functions ============
function showSongPreview(mode, type) {
  var container = document.getElementById(mode + 'SongPreviewContent');
  if (!container) return;
  
  container.classList.remove('hidden');
  
  // Update button states
  container.parentElement.querySelectorAll('.preview-btn').forEach(function(btn) {
    btn.classList.remove('active');
  });
  event.target.closest('.preview-btn').classList.add('active');
  
  if (type === 'lyrics') {
    var lyrics = songData[mode].lyrics || '';
    if (!lyrics.trim()) {
      container.innerHTML = '<div class="p-4 text-center text-slate-400">No lyrics entered yet.</div>';
      return;
    }
    container.innerHTML = '<div class="preview-lyrics">' + formatLyrics(lyrics, false) + '</div>';
  } else if (type === 'chords') {
    var lyrics = songData[mode].lyrics || '';
    if (!lyrics.trim()) {
      container.innerHTML = '<div class="p-4 text-center text-slate-400">No lyrics entered yet.</div>';
      return;
    }
    container.innerHTML = '<div class="preview-lyrics">' + formatLyrics(lyrics, true) + '</div>';
  } else if (type === 'docs') {
    var youtube = songData[mode].youtube;
    var attachments = songData[mode].attachments;
    
    if (!youtube.length && !attachments.length) {
      container.innerHTML = '<div class="p-4 text-center text-slate-400">No attachments or videos added.</div>';
      return;
    }
    
    var html = '<div class="p-3">';
    if (youtube.length) {
      html += '<p class="text-xs font-semibold text-slate-600 mb-2">YouTube Videos:</p>';
      youtube.forEach(function(url, idx) {
        var title = (window.songYoutubeTitles && window.songYoutubeTitles[url]) || 'Video ' + (idx + 1);
        html += '<button class="preview-btn mb-2 w-full justify-start" onclick="previewYoutube(\'' + escapeHtmlModal(url) + '\')">';
        html += '<i class="fa-brands fa-youtube text-red-500"></i> ' + escapeHtmlModal(title);
        html += '</button>';
      });
    }
    if (attachments.length) {
      html += '<p class="text-xs font-semibold text-slate-600 mb-2 mt-3">Documents:</p>';
      attachments.forEach(function(att) {
        var displayName = att.name;
        var displayType = att.ext;
        if (window.songFileNames && window.songFileNames[att.url]) {
          displayName = window.songFileNames[att.url].name || displayName;
          displayType = window.songFileNames[att.url].type || displayType;
        }
        html += '<button class="preview-btn mb-2 w-full justify-start" onclick="previewAttachment(\'' + escapeHtmlModal(att.url) + '\')">';
        html += '<i class="fa-solid ' + att.icon + '"></i> ' + escapeHtmlModal(displayName) + ' (' + (displayType || att.ext).toUpperCase() + ')';
        html += '</button>';
      });
    }
    html += '</div>';
    container.innerHTML = html;
  }
}

function formatLyrics(text, showChords) {
  var lines = text.split('\n');
  var html = '';
  var isChordLine = function(line) {
    // Check if line contains mostly chord patterns (letters + optional # b m dim aug 7 etc)
    var trimmed = line.trim();
    if (!trimmed) return false;
    var chordPattern = /^[\sA-G#bmdimaug7sus249\/\(\)]+$/i;
    return chordPattern.test(trimmed) && /[A-G]/.test(trimmed);
  };
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    var trimmed = line.trim();
    
    // Section header
    if (trimmed.match(/^\[.+\]$/)) {
      var sectionName = trimmed.slice(1, -1);
      html += '<div class="section-header">' + escapeHtmlModal(sectionName) + '</div>';
    }
    // Chord line
    else if (isChordLine(line)) {
      if (showChords) {
        html += '<div class="chord-line">' + escapeHtmlModal(line) + '</div>';
      }
      // Skip chord lines if not showing chords
    }
    // Regular lyric line
    else if (trimmed) {
      html += '<div class="lyric-line">' + escapeHtmlModal(line) + '</div>';
    }
    // Empty line (paragraph break)
    else {
      html += '<div style="height: 8px;"></div>';
    }
  }
  
  return html;
}

// ============ Theme Management ============
function addNewTheme(mode) {
  var newTheme = prompt('Enter new theme name:');
  if (!newTheme || !newTheme.trim()) return;
  
  newTheme = newTheme.trim();
  var select = document.getElementById(mode + 'SongTheme');
  
  for (var i = 0; i < select.options.length; i++) {
    if (select.options[i].value.toLowerCase() === newTheme.toLowerCase()) {
      select.value = select.options[i].value;
      return;
    }
  }
  
  var option = document.createElement('option');
  option.value = newTheme;
  option.textContent = newTheme;
  select.appendChild(option);
  select.value = newTheme;
}

function escapeHtmlModal(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

// Close modals on click outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('lyrics-editor-modal')) {
    closeLyricsEditor();
  }
  if (e.target.id === 'youtubePreviewModal') {
    closeYoutubePreview();
  }
});

// Reset song data when opening add modal
window.resetNewSongData = function() {
  songData.new = { youtube: [], attachments: [], lyrics: '' };
  document.getElementById('newSongYoutubeList').innerHTML = '';
  document.getElementById('newSongAttachments').innerHTML = '';
  document.getElementById('newSongLyricsSummary').classList.add('hidden');
  document.getElementById('newSongLyricsData').value = '';
  document.getElementById('newSongPreviewContent').classList.add('hidden');
};

// Load song data when opening edit modal
window.loadEditSongData = function(song) {
  // Parse YouTube URLs (may be comma separated)
  var youtubeUrls = [];
  if (song.youtube) {
    youtubeUrls = song.youtube.split(/[,\s]+/).filter(function(u) { 
      return u.trim() && (u.includes('youtube') || u.includes('youtu.be')); 
    });
  }
  
  // Parse attachment URLs (may be comma separated)
  var attachments = [];
  if (song.lyricsUrl) {
    var urls = song.lyricsUrl.split(/[,\s]+/).filter(function(u) { return u.trim(); });
    urls.forEach(function(url) {
      attachments.push(parseFileUrl(url));
    });
  }
  
  songData.edit = { 
    youtube: youtubeUrls, 
    attachments: attachments, 
    lyrics: song.lyrics || '' 
  };
  
  renderYoutubeLinks('edit');
  renderAttachments('edit');
  
  // Set theme selection
  if (typeof setThemeSelection === 'function') {
    setThemeSelection('edit', song.theme || '');
  }
  
  var summary = document.getElementById('editSongLyricsSummary');
  var info = document.getElementById('editSongLyricsInfo');
  if (summary && song.lyrics && song.lyrics.trim()) {
    var lines = song.lyrics.split('\n').filter(function(l) { return l.trim(); }).length;
    var sections = (song.lyrics.match(/\[.+\]/g) || []).length;
    info.textContent = sections + ' section(s), ' + lines + ' lines';
    summary.classList.remove('hidden');
  } else if (summary) {
    summary.classList.add('hidden');
  }
  
  document.getElementById('editSongLyricsData').value = song.lyrics || '';
  document.getElementById('editSongPreviewContent').classList.add('hidden');
};
</script>
<!-- ======================= LHC Worship Prep ‚Äî index.html (PART 5/6) ======================= -->
<!-- Part 5: JavaScript - All Core Functions -->

<script>
(function() {
  "use strict";

  // ============================================================
  // 1) GLOBAL STATE
  // ============================================================
  var STATE = {
    songs: [],
    filteredSongs: [],
    songMeta: { themes: [], keys: [], styles: [], tempos: [], seasons: [] },
    filters: { q: '', theme: '', key: '', style: '', tempo: '', season: '', sort: 'title-asc' },
    orders: [],
    currentOrder: null,
    rosterMonth: new Date().getMonth(),
    rosterYear: new Date().getFullYear(),
    rosterEdits: new Map(),
    rosterHasUnsaved: false,
    lyricsCurrentSong: null,
    lyricsMode: 'overall',
    lyricsSlides: [],
    lyricsSlideIndex: 0,
    lyricsEditMode: false,
    currentStatTab: 'frequent'
  };

  // ============================================================
  // 2) DOM HELPERS
  // ============================================================
  function $(id) { return document.getElementById(id); }
  function $$(sel) { return document.querySelectorAll(sel); }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  function debounce(fn, delay) {
    var timer = null;
    return function() {
      var args = arguments, ctx = this;
      clearTimeout(timer);
      timer = setTimeout(function() { fn.apply(ctx, args); }, delay || 250);
    };
  }

  // ============================================================
  // 3) LOADER & TOAST
  // ============================================================
  function showLoader(show) {
    var el = $('loadingIndicator');
    if (el) el.classList.toggle('show', show);
  }

  function showToast(message, type) {
    var el = $('toastNotification');
    if (!el) return;
    el.textContent = message;
    el.className = 'toast-notification show ' + (type || '');
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(function() { el.classList.remove('show'); }, 3500);
  }

  // ============================================================
  // 4) GOOGLE APPS SCRIPT API WRAPPER
  // ============================================================
  function callGAS(functionName, args) {
    return new Promise(function(resolve, reject) {
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        reject(new Error('Google Apps Script API not available'));
        return;
      }
      var runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject);
      if (typeof runner[functionName] !== 'function') {
        reject(new Error('Function not found: ' + functionName));
        return;
      }
      runner[functionName].apply(runner, args || []);
    });
  }

  // ============================================================
  // 5) VIEW ROUTING
  // ============================================================
  function setActiveView(viewId) {
    ['songFinderView', 'worshipRosterView', 'worshipOrderView'].forEach(function(id) {
      var el = $(id);
      if (el) el.style.display = 'none';
    });
    var activeView = $(viewId);
    if (activeView) activeView.style.display = 'block';

    var navMap = { 'songFinderView': 'navSongFinderBtn', 'worshipRosterView': 'navRosterBtn', 'worshipOrderView': 'navOrdersBtn' };
    ['navSongFinderBtn', 'navRosterBtn', 'navOrdersBtn'].forEach(function(btnId) {
      var btn = $(btnId);
      if (btn) btn.classList.toggle('lhc-pill-button-active', btnId === navMap[viewId]);
    });
    
    // Switch sidebar content based on view
    var songStatsSection = $('songStatsSection');
    var rosterUpdatesSection = $('rosterUpdatesSection');
    
    if (viewId === 'worshipRosterView') {
      if (songStatsSection) songStatsSection.style.display = 'none';
      if (rosterUpdatesSection) rosterUpdatesSection.style.display = 'flex';
      loadRosterUpdates();
    } else {
      if (songStatsSection) songStatsSection.style.display = 'flex';
      if (rosterUpdatesSection) rosterUpdatesSection.style.display = 'none';
    }

    if (viewId === 'worshipRosterView' && window.RosterEngine) {
      window.RosterEngine.init();
    }
  }

  // ============================================================
  // 6) MODAL HELPERS
  // ============================================================
  function openModal(modalId) {
    var modal = $(modalId);
    if (modal) modal.classList.add('show');
  }

  function closeModal(modalId) {
    var modal = $(modalId);
    if (modal) modal.classList.remove('show');
  }

  function setupModalClose(modalId, closeBtnId, additionalBtnIds) {
    var modal = $(modalId);
    var closeBtn = $(closeBtnId);
    if (closeBtn) closeBtn.onclick = function() { closeModal(modalId); };
    if (modal) modal.onclick = function(e) { if (e.target === modal) closeModal(modalId); };
    (additionalBtnIds || []).forEach(function(btnId) {
      var btn = $(btnId);
      if (btn) btn.onclick = function() { closeModal(modalId); };
    });
  }

  // ============================================================
  // 7) SONG DATA HELPERS
  // ============================================================
  function normalizeSong(s) {
    if (!s || !s.title) return null;

    // Handle youtube - backend may return array or string
    var youtubeVal = s.youtube || s.youtubeUrl || s.youtube_url || '';
    if (Array.isArray(youtubeVal)) {
      youtubeVal = youtubeVal.join(', ');
    }

    // Handle attachments - backend returns array, convert to comma-separated URLs
    var lyricsUrlVal = '';
    if (Array.isArray(s.attachments) && s.attachments.length > 0) {
      lyricsUrlVal = s.attachments.map(function(a) { return a.url || a; }).join(', ');
    } else {
      lyricsUrlVal = String(s.lyricsUrl || s.lyrics_url || s.doclinks || '').trim();
    }

    return {
      id: s.id || 'song_' + Math.random().toString(36).slice(2),
      title: String(s.title || '').trim(),
      artist: String(s.artist || '').trim(),
      key: String(s.key || '').trim(),
      tempo: String(s.tempo || s.mood || '').trim(),
      theme: String(s.theme || s.themes || '').trim(),
      season: String(s.season || s.seasons || '').trim(),
      style: String(s.style || s.category || '').trim(),
      category: String(s.category || s.style || '').trim(),
      lyrics: String(s.lyrics || '').trim(),
      lyricsUrl: lyricsUrlVal,
      youtube: String(youtubeVal).trim(),
      attachments: s.attachments || [],
      useCount: parseInt(s.useCount) || 0,
      lastUsed: s.lastUsed || '',
      dateAdded: s.dateAdded || '',
      lastEdited: s.lastEdited || ''
    };
  }

  function getUniqueValues(arr, key) {
    var set = {};
    arr.forEach(function(item) {
      if (item && item[key]) {
        var value = String(item[key]).trim();
        // Split by comma, semicolon, or slash to get individual values
        var parts = value.split(/[,;\/]+/);
        parts.forEach(function(part) {
          var trimmed = part.trim();
          if (trimmed) {
            // Capitalize first letter for consistency
            var normalized = trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
            set[normalized] = true;
          }
        });
      }
    });
    return Object.keys(set).sort();
  }

  function populateFilterDropdowns() {
    var songs = STATE.songs;
    STATE.songMeta.themes = getUniqueValues(songs, 'theme');
    STATE.songMeta.keys = getUniqueValues(songs, 'key');
    STATE.songMeta.styles = getUniqueValues(songs, 'style');
    STATE.songMeta.tempos = getUniqueValues(songs, 'tempo');
    STATE.songMeta.seasons = getUniqueValues(songs, 'season');
    fillSelectOptions($('filterTheme'), STATE.songMeta.themes, 'All Themes');
    fillSelectOptions($('filterKey'), STATE.songMeta.keys, 'All Keys');
    fillSelectOptions($('filterStyle'), STATE.songMeta.styles, 'All Styles');
    fillSelectOptions($('filterTempo'), STATE.songMeta.tempos, 'All');
    fillSelectOptions($('filterSeason'), STATE.songMeta.seasons, 'All Seasons');
  }

  function fillSelectOptions(selectEl, options, placeholder) {
    if (!selectEl) return;
    var currentValue = selectEl.value;
    var html = '<option value="">' + escapeHtml(placeholder) + '</option>';
    options.forEach(function(opt) {
      html += '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>';
    });
    selectEl.innerHTML = html;
    selectEl.value = currentValue;
  }

  // ============================================================
  // 8) FILTER & SORT LOGIC
  // ============================================================
  function applyFiltersAndSort() {
    var f = STATE.filters;
    var result = STATE.songs.slice();

    if (f.q) {
      var q = f.q.toLowerCase();
      result = result.filter(function(s) {
        // Match only from the START of the title (first characters)
        var title = (s.title || '').toLowerCase();
        return title.indexOf(q) === 0; // Must start with the search query
      });
    }

    if (f.theme) result = result.filter(function(s) { 
      var themes = String(s.theme || '').toLowerCase().split(/[,;\/]+/).map(function(t) { return t.trim().toLowerCase(); });
      return themes.indexOf(f.theme.toLowerCase()) >= 0 || s.theme === f.theme;
    });
    if (f.key) result = result.filter(function(s) { return s.key === f.key; });
    if (f.style) result = result.filter(function(s) { 
      var styles = String(s.style || '').toLowerCase().split(/[,;\/]+/).map(function(t) { return t.trim().toLowerCase(); });
      return styles.indexOf(f.style.toLowerCase()) >= 0 || s.style === f.style;
    });
    if (f.tempo) result = result.filter(function(s) { 
      var tempos = String(s.tempo || '').toLowerCase().split(/[,;\/]+/).map(function(t) { return t.trim().toLowerCase(); });
      return tempos.indexOf(f.tempo.toLowerCase()) >= 0 || s.tempo === f.tempo;
    });
    if (f.season) result = result.filter(function(s) { 
      var seasons = String(s.season || '').toLowerCase().split(/[,;\/]+/).map(function(t) { return t.trim().toLowerCase(); });
      return seasons.indexOf(f.season.toLowerCase()) >= 0 || s.season === f.season;
    });

    var sortParts = (f.sort || 'title-asc').split('-');
    var sortKey = sortParts[0];
    var sortDir = sortParts[1];
    result.sort(function(a, b) {
      var aVal = String(a[sortKey] || '').toLowerCase();
      var bVal = String(b[sortKey] || '').toLowerCase();
      var cmp = aVal.localeCompare(bVal);
      return sortDir === 'desc' ? -cmp : cmp;
    });

    STATE.filteredSongs = result;
    return result;
  }

  // ============================================================
  // 9) SONG RENDERING - WITH CLICKABLE TITLE & GOOGLE DOC BUTTON
  // ============================================================
  function renderSongs(forceShow) {
    var container = $('songListContainer');
    var emptyState = $('songEmptyState');
    var q = STATE.filters.q;

    if (!q && !forceShow) {
      if (container) container.innerHTML = '';
      if (emptyState) emptyState.style.display = 'block';
      updateResultCounts(0);
      return;
    }

    if (emptyState) emptyState.style.display = 'none';

    var filtered = applyFiltersAndSort();
    updateResultCounts(filtered.length);

    if (!filtered.length) {
      if (container) {
        container.innerHTML = '<div class="text-center py-10 text-slate-500"><i class="fa-solid fa-search text-3xl mb-3 opacity-50"></i><p class="font-semibold">No songs found</p><p class="text-sm">Try different search terms or clear filters.</p></div>';
      }
      return;
    }

    var songsToShow = filtered.slice(0, 50);
    var html = '';
    songsToShow.forEach(function(song) {
      html += renderSongListItem(song);
    });
    if (container) {
      container.innerHTML = html;
      bindSongItemEvents();
    }
  }

  function renderSongListItem(song) {
    var pills = [];
    if (song.key) pills.push('<span class="meta-pill" style="background:#dbeafe;color:#1e40af;border-color:#93c5fd;">üéπ ' + escapeHtml(song.key) + '</span>');
    if (song.style) pills.push('<span class="meta-pill">' + escapeHtml(song.style) + '</span>');
    if (song.tempo) pills.push('<span class="meta-pill">' + escapeHtml(song.tempo) + '</span>');
    if (song.theme) pills.push('<span class="meta-pill" style="background:#e0e7ff;color:#3730a3;border-color:#a5b4fc;">' + escapeHtml(song.theme) + '</span>');
    if (song.season) pills.push('<span class="meta-pill" style="background:#fef3c7;color:#92400e;border-color:#fcd34d;">' + escapeHtml(song.season) + '</span>');

    // Parse multiple URLs
    var youtubeUrls = song.youtube ? song.youtube.split(/[,\s]+/).filter(function(u) { return u.trim() && (u.includes('youtube') || u.includes('youtu.be')); }) : [];
    var docUrls = song.lyricsUrl ? song.lyricsUrl.split(/[,\s]+/).filter(function(u) { return u.trim(); }) : [];

    var h = '<div class="song-list-item" data-song-id="' + escapeHtml(song.id) + '">';
    h += '<div class="flex-1 min-w-0">';
    h += '<div class="font-semibold text-slate-800 truncate song-title-link" data-id="' + escapeHtml(song.id) + '">' + escapeHtml(song.title) + '</div>';
    h += '<div class="text-sm text-slate-500 truncate">' + escapeHtml(song.artist || 'Unknown Artist') + '</div>';
    h += '<div class="flex flex-wrap gap-1 mt-2">' + pills.join('') + '</div>';
    h += '</div>';
    h += '<div class="flex gap-2 shrink-0 items-start">';
    h += '<button class="lhc-pill-button text-xs btn-lyrics-preview" data-id="' + escapeHtml(song.id) + '" title="View Lyrics"><i class="fa-solid fa-file-lines"></i> Lyrics</button>';
    h += '<button class="lhc-pill-button text-xs btn-add-order" data-id="' + escapeHtml(song.id) + '" title="Add to Order"><i class="fa-solid fa-plus"></i> Order</button>';
    
    // GOOGLE DOC BUTTON - if multiple, show count badge
    if (docUrls.length > 0) {
      var docBadge = docUrls.length > 1 ? '<span class="link-count-badge">' + docUrls.length + '</span>' : '';
      h += '<button class="lhc-pill-button text-xs btn-doc-preview" data-id="' + escapeHtml(song.id) + '" data-urls="' + escapeHtml(JSON.stringify(docUrls)) + '" data-title="' + escapeHtml(song.title) + '" title="Preview Document" style="background:#e0f2fe;border-color:#7dd3fc;position:relative;"><i class="fa-solid fa-file-lines text-blue-600"></i>' + docBadge + '</button>';
    }
    
    // YOUTUBE BUTTON - if multiple, show count badge
    if (youtubeUrls.length > 0) {
      var ytBadge = youtubeUrls.length > 1 ? '<span class="link-count-badge">' + youtubeUrls.length + '</span>' : '';
      h += '<button class="lhc-pill-button text-xs btn-youtube-preview" data-id="' + escapeHtml(song.id) + '" data-urls="' + escapeHtml(JSON.stringify(youtubeUrls)) + '" data-title="' + escapeHtml(song.title) + '" title="Preview Video" style="position:relative;"><i class="fa-brands fa-youtube text-red-500"></i>' + ytBadge + '</button>';
    }
    
    h += '</div></div>';
    return h;
  }

  function bindSongItemEvents() {
    // Lyrics preview buttons - opens preview modal
    $$('.btn-lyrics-preview').forEach(function(btn) {
      btn.onclick = function(e) {
        e.stopPropagation();
        var song = STATE.songs.find(function(s) { return s.id === btn.dataset.id; });
        if (song) openLyricsPreviewModal(song);
      };
    });

    // Add to Order buttons
    $$('.btn-add-order').forEach(function(btn) {
      btn.onclick = function(e) {
        e.stopPropagation();
        var song = STATE.songs.find(function(s) { return s.id === btn.dataset.id; });
        if (song) showToast('Added "' + song.title + '" to order', 'success');
      };
    });

    // CLICKABLE TITLE - Edit song
    $$('.song-title-link').forEach(function(el) {
      el.onclick = function(e) {
        e.stopPropagation();
        var song = STATE.songs.find(function(s) { return s.id === el.dataset.id; });
        if (song) openEditSongModal(song);
      };
    });
    
    // Doc preview buttons - handle multiple URLs
    $$('.btn-doc-preview').forEach(function(btn) {
      btn.onclick = function(e) {
        e.stopPropagation();
        var urls = [];
        try { urls = JSON.parse(btn.dataset.urls || '[]'); } catch(ex) { urls = [btn.dataset.url]; }
        var title = btn.dataset.title;
        
        if (urls.length === 1) {
          openDocPreviewModal(urls[0], title);
        } else if (urls.length > 1) {
          showLinkSelectorPopup(e, urls, 'doc', title);
        }
      };
    });
    
    // YouTube preview buttons - handle multiple URLs
    $$('.btn-youtube-preview').forEach(function(btn) {
      btn.onclick = function(e) {
        e.stopPropagation();
        var urls = [];
        try { urls = JSON.parse(btn.dataset.urls || '[]'); } catch(ex) { urls = [btn.dataset.url]; }
        var title = btn.dataset.title;
        
        if (urls.length === 1) {
          openYoutubePreviewModal(urls[0], title);
        } else if (urls.length > 1) {
          showLinkSelectorPopup(e, urls, 'youtube', title);
        }
      };
    });
  }
  
  // Popup for selecting which link to open
  function showLinkSelectorPopup(event, urls, type, title) {
    // Remove existing popup if any
    var existing = document.getElementById('linkSelectorPopup');
    if (existing) existing.remove();
    
    var popup = document.createElement('div');
    popup.id = 'linkSelectorPopup';
    popup.className = 'link-selector-popup';
    popup.style.cssText = 'position:fixed;z-index:10000;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.25);padding:8px 0;min-width:200px;max-width:300px;';
    popup.style.left = Math.min(event.clientX, window.innerWidth - 320) + 'px';
    popup.style.top = Math.min(event.clientY, window.innerHeight - 200) + 'px';
    
    var html = '<div style="padding:8px 16px;font-size:11px;color:#64748b;font-weight:600;border-bottom:1px solid #e2e8f0;">SELECT ' + type.toUpperCase() + '</div>';
    
    urls.forEach(function(url, idx) {
      var icon = type === 'youtube' ? 'fa-brands fa-youtube text-red-500' : 'fa-solid fa-file-lines text-blue-500';
      var label = type === 'youtube' ? 'Video ' + (idx + 1) : 'Document ' + (idx + 1);
      
      // Try to get a better name from URL
      if (url.includes('docs.google.com')) label = 'Google Doc ' + (idx + 1);
      else if (url.includes('drive.google.com')) label = 'Drive File ' + (idx + 1);
      
      html += '<div class="link-selector-item" data-url="' + escapeHtml(url) + '" style="padding:10px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;" onmouseover="this.style.background=\'#f1f5f9\'" onmouseout="this.style.background=\'white\'">';
      html += '<i class="' + icon + '"></i>';
      html += '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + label + '</span>';
      html += '</div>';
    });
    
    popup.innerHTML = html;
    document.body.appendChild(popup);
    
    // Bind clicks
    popup.querySelectorAll('.link-selector-item').forEach(function(item) {
      item.onclick = function() {
        var url = item.dataset.url;
        popup.remove();
        if (type === 'youtube') {
          openYoutubePreviewModal(url, title);
        } else {
          openDocPreviewModal(url, title);
        }
      };
    });
    
    // Close on outside click
    setTimeout(function() {
      document.addEventListener('click', function closePopup(e) {
        if (!popup.contains(e.target)) {
          popup.remove();
          document.removeEventListener('click', closePopup);
        }
      });
    }, 100);
  }

  function updateResultCounts(count) {
    var resultCount = $('resultCount');
    var totalCount = $('totalCount');
    if (resultCount) resultCount.textContent = count;
    if (totalCount) totalCount.textContent = STATE.songs.length;
  }

  // ============================================================
  // 10) SEARCH SUGGESTIONS - PREFIX MATCH ONLY
  // ============================================================
  function renderSearchSuggestions(query) {
    var container = $('searchSuggestions');
    if (!container) return;

    if (!query || query.length < 1) {
      container.classList.remove('show');
      container.innerHTML = '';
      return;
    }

    var q = query.toLowerCase();
    
    // PREFIX MATCH: Only match songs that START with the query
    var matches = STATE.songs.filter(function(s) {
      return s.title.toLowerCase().indexOf(q) === 0;
    }).slice(0, 10);

    if (!matches.length) {
      container.classList.remove('show');
      container.innerHTML = '';
      return;
    }

    var html = '';
    matches.forEach(function(s, idx) {
      html += '<div class="suggestion-item ' + (idx === 0 ? 'active' : '') + '" data-id="' + escapeHtml(s.id) + '">';
      html += '<div class="font-semibold text-sm text-slate-800">' + highlightMatch(s.title, query) + '</div>';
      html += '<div class="text-xs text-slate-500">' + escapeHtml(s.artist || 'Unknown Artist') + (s.key ? ' ‚Ä¢ ' + escapeHtml(s.key) : '') + '</div>';
      html += '</div>';
    });

    container.innerHTML = html;
    container.classList.add('show');

    container.querySelectorAll('.suggestion-item').forEach(function(item) {
      item.onclick = function() {
        var song = STATE.songs.find(function(s) { return s.id === item.dataset.id; });
        if (song) {
          $('searchInput').value = song.title;
          STATE.filters.q = song.title;
          container.classList.remove('show');
          renderSongs(true);
        }
      };
    });
  }

  function highlightMatch(text, query) {
    if (!query) return escapeHtml(text);
    var escaped = escapeHtml(text);
    var q = escapeHtml(query);
    var idx = escaped.toLowerCase().indexOf(q.toLowerCase());
    if (idx === 0) {
      return '<mark style="background:#fef08a;padding:0 2px;border-radius:2px;">' + escaped.slice(0, q.length) + '</mark>' + escaped.slice(q.length);
    }
    return escaped;
  }

  function navSuggestions(dir) {
    var c = $('searchSuggestions');
    if (!c || !c.classList.contains('show')) return;
    var items = c.querySelectorAll('.suggestion-item');
    if (!items.length) return;
    var ai = -1;
    items.forEach(function(it, i) { if (it.classList.contains('active')) ai = i; });
    items.forEach(function(it) { it.classList.remove('active'); });
    var ni = ai + dir;
    if (ni < 0) ni = items.length - 1;
    if (ni >= items.length) ni = 0;
    items[ni].classList.add('active');
    var s = STATE.songs.find(function(x) { return x.id === items[ni].dataset.id; });
    if (s) $('searchInput').value = s.title;
  }

  // ============================================================
  // 11) SONG STATISTICS (SIDEBAR)
  // ============================================================
  function formatDateShort(dateStr) {
    if (!dateStr) return '';
    try {
      var d = new Date(dateStr);
      var m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return m[d.getMonth()] + ' ' + d.getDate();
    } catch (e) {
      return dateStr.slice(0, 10);
    }
  }

  function renderSongStats() {
    var container = $('songStatsContainer');
    if (!container) return;

    var songs = STATE.songs.slice();
    var statSongs = [];

    if (STATE.currentStatTab === 'frequent') {
      statSongs = songs.sort(function(a, b) { return (b.useCount || 0) - (a.useCount || 0); }).slice(0, 10);
    } else if (STATE.currentStatTab === 'recent') {
      statSongs = songs.filter(function(s) { return s.lastUsed; }).sort(function(a, b) { return (b.lastUsed || '').localeCompare(a.lastUsed || ''); }).slice(0, 10);
    } else if (STATE.currentStatTab === 'newest') {
      statSongs = songs.filter(function(s) { return s.dateAdded; }).sort(function(a, b) { return (b.dateAdded || '').localeCompare(a.dateAdded || ''); }).slice(0, 10);
    }

    if (!statSongs.length) {
      container.innerHTML = '<div class="text-xs text-white/60 text-center py-4">No data available yet.</div>';
      return;
    }

    var html = '';
    statSongs.forEach(function(song, idx) {
      var badge = '';
      if (STATE.currentStatTab === 'frequent' && song.useCount) {
        badge = '<span class="text-[0.6rem] bg-amber-400/30 text-amber-200 px-1.5 py-0.5 rounded-full">' + song.useCount + 'x</span>';
      } else if (STATE.currentStatTab === 'recent' && song.lastUsed) {
        badge = '<span class="text-[0.6rem] bg-blue-400/30 text-blue-200 px-1.5 py-0.5 rounded-full">' + formatDateShort(song.lastUsed) + '</span>';
      } else if (STATE.currentStatTab === 'newest' && song.dateAdded) {
        badge = '<span class="text-[0.6rem] bg-green-400/30 text-green-200 px-1.5 py-0.5 rounded-full">' + formatDateShort(song.dateAdded) + '</span>';
      }

      html += '<div class="stat-song-item flex items-center justify-between gap-2 px-2 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 cursor-pointer transition" data-id="' + escapeHtml(song.id) + '">';
      html += '<div class="flex items-center gap-2 min-w-0">';
      html += '<span class="text-[0.65rem] text-white/50 w-4">' + (idx + 1) + '</span>';
      html += '<span class="text-xs text-white truncate">' + escapeHtml(song.title) + '</span>';
      html += '</div>';
      html += badge;
      html += '</div>';
    });

    container.innerHTML = html;

    // Bind clicks to search for that song
    container.querySelectorAll('.stat-song-item').forEach(function(item) {
      item.onclick = function() {
        var song = STATE.songs.find(function(s) { return s.id === item.dataset.id; });
        if (song) {
          $('searchInput').value = song.title;
          STATE.filters.q = song.title;
          setActiveView('songFinderView');
          renderSongs(true);
        }
      };
    });
  }

  function bindStatTabs() {
    $$('.stat-tab-btn').forEach(function(btn) {
      btn.onclick = function() {
        $$('.stat-tab-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        STATE.currentStatTab = btn.dataset.stat;
        renderSongStats();
      };
    });
  }

  // ============================================================
  // 11B) ROSTER UPDATES (Sidebar for Roster view)
  // ============================================================
  function loadRosterUpdates() {
    var container = $('rosterUpdatesContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="text-xs text-white/60 text-center py-4">Loading updates...</div>';
    
    callGAS('getRosterUpdates', []).then(function(updates) {
      renderRosterUpdates(updates || []);
    }).catch(function(err) {
      console.error('Failed to load roster updates:', err);
      container.innerHTML = '<div class="text-xs text-white/60 text-center py-4">Failed to load updates</div>';
    });
  }
  
  // Store grouped roster updates for navigation
  var ROSTER_UPDATES_STATE = {
    grouped: {},      // { "roleId__date": [changes...] }
    currentIdx: {}    // { "roleId__date": currentIndex }
  };

  function renderRosterUpdates(updates) {
    var container = $('rosterUpdatesContainer');
    if (!container) return;

    if (!updates.length) {
      container.innerHTML = '<div class="text-sm text-white/80 text-center py-4">No recent updates</div>';
      return;
    }

    // Group updates by role+date, keep last 5 for each
    var grouped = {};
    updates.forEach(function(update) {
      var key = (update.roleId || 'unknown') + '__' + (update.serviceDate || 'unknown');
      if (!grouped[key]) {
        grouped[key] = [];
      }
      grouped[key].push(update);
    });

    // Sort each group by timestamp (newest first) and limit to 5
    Object.keys(grouped).forEach(function(key) {
      grouped[key].sort(function(a, b) {
        return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
      });
      grouped[key] = grouped[key].slice(0, 5);
    });

    // Store in state
    ROSTER_UPDATES_STATE.grouped = grouped;

    // Get unique entries (most recent change per role+date), limit to 10 entries
    var uniqueKeys = Object.keys(grouped).sort(function(a, b) {
      var aTime = grouped[a][0] ? new Date(grouped[a][0].timestamp || 0) : new Date(0);
      var bTime = grouped[b][0] ? new Date(grouped[b][0].timestamp || 0) : new Date(0);
      return bTime - aTime;
    }).slice(0, 10);

    // Initialize current index for each
    uniqueKeys.forEach(function(key) {
      if (ROSTER_UPDATES_STATE.currentIdx[key] === undefined) {
        ROSTER_UPDATES_STATE.currentIdx[key] = 0;
      }
    });

    var html = '';
    uniqueKeys.forEach(function(key) {
      var history = grouped[key];
      var idx = ROSTER_UPDATES_STATE.currentIdx[key] || 0;
      var update = history[idx];
      var totalCount = history.length;

      html += renderSingleUpdate(key, update, idx, totalCount);
    });

    container.innerHTML = html;
    bindRosterUpdateNavigation();
  }

  function renderSingleUpdate(key, update, currentIdx, totalCount) {
    var roleId = update.roleId || '';
    var serviceDate = update.serviceDate || '';

    // Clean service date - extract just "Jan 11" format if it contains full date string
    function cleanServiceDate(dateStr) {
      if (!dateStr) return '';
      dateStr = String(dateStr).trim();
      // If it looks like "Sun Jan 11 2026 08:00:00..." extract just "Jan 11"
      var match = dateStr.match(/^(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)?\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{1,2})/i);
      if (match) {
        return match[1] + ' ' + match[2];
      }
      // If it's already short like "Jan 11", return as is
      if (dateStr.length <= 10) return dateStr;
      // Otherwise truncate at first space after date-like content
      return dateStr.split(/\s+\d{4}/)[0] || dateStr.substring(0, 10);
    }

    // Format timestamp as "00:00 am/pm, dd/mm/yy"
    function formatDateTime(timestamp) {
      if (!timestamp) return '';
      try {
        var d;
        if (timestamp instanceof Date) {
          d = timestamp;
        } else if (typeof timestamp === 'string') {
          // Handle ISO strings, Date.toString(), or other formats
          d = new Date(timestamp);
        } else if (typeof timestamp === 'number') {
          d = new Date(timestamp);
        } else {
          return '';
        }

        // Check if date is valid
        if (isNaN(d.getTime())) return '';

        var hours = d.getHours();
        var mins = d.getMinutes();
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12;
        var timeStr = (hours < 10 ? '0' : '') + hours + ':' + (mins < 10 ? '0' : '') + mins + ' ' + ampm;
        var day = d.getDate();
        var month = d.getMonth() + 1;
        var year = String(d.getFullYear()).slice(-2);
        var dateStr = (day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + year;
        return timeStr + ', ' + dateStr;
      } catch(e) {
        return '';
      }
    }

    var cleanedServiceDate = cleanServiceDate(serviceDate);
    var dateTimeStr = formatDateTime(update.timestamp);

    var html = '<div class="roster-update-item px-2 py-2 rounded-lg bg-white/15 hover:bg-white/25 transition mb-1.5 border border-white/10" data-key="' + escapeHtml(key) + '">';

    // Header: Role - Date (yellow)
    html += '<div class="text-xs font-bold text-yellow-300 mb-1">';
    html += escapeHtml(update.duty || roleId) + ' - ' + escapeHtml(cleanedServiceDate);
    html += '</div>';

    // Current value (white, bigger)
    html += '<div class="text-base text-white font-bold mb-1">';
    html += escapeHtml(update.newValue || 'TBD');
    html += '</div>';

    // Previous value box with timestamp (teal)
    if (update.oldValue && update.oldValue !== update.newValue) {
      var prevTimeStr = formatDateTime(update.prevTimestamp || update.timestamp);
      html += '<div class="text-xs bg-white/10 rounded px-1.5 py-1 mb-1 text-teal-300">';
      html += '<span class="text-teal-400/70">Was:</span> ';
      html += '<span class="font-medium">' + escapeHtml(update.oldValue) + '</span>';
      if (prevTimeStr) {
        html += ' <span class="text-teal-400/50">- ' + prevTimeStr + '</span>';
      }
      html += '</div>';
    }

    // Navigation row: arrows and current change timestamp
    html += '<div class="flex items-center justify-between">';

    // Navigation buttons
    html += '<div class="flex items-center gap-0.5">';
    var canGoPrev = currentIdx < totalCount - 1;
    var canGoNext = currentIdx > 0;
    html += '<button class="roster-hist-nav px-1.5 py-0.5 rounded bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition text-[0.65rem] ' + (canGoPrev ? '' : 'opacity-30 cursor-not-allowed') + '" data-key="' + escapeHtml(key) + '" data-dir="prev" ' + (canGoPrev ? '' : 'disabled') + '>';
    html += '<i class="fa-solid fa-chevron-left"></i></button>';
    html += '<span class="text-[0.65rem] text-white/70 px-0.5">' + (currentIdx + 1) + '/' + totalCount + '</span>';
    html += '<button class="roster-hist-nav px-1.5 py-0.5 rounded bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition text-[0.65rem] ' + (canGoNext ? '' : 'opacity-30 cursor-not-allowed') + '" data-key="' + escapeHtml(key) + '" data-dir="next" ' + (canGoNext ? '' : 'disabled') + '>';
    html += '<i class="fa-solid fa-chevron-right"></i></button>';
    html += '</div>';

    // Current change timestamp
    html += '<span class="text-[0.65rem] text-white/60">' + dateTimeStr + '</span>';
    html += '</div>';

    html += '</div>';
    return html;
  }

  function bindRosterUpdateNavigation() {
    var container = $('rosterUpdatesContainer');
    if (!container) return;

    container.querySelectorAll('.roster-hist-nav').forEach(function(btn) {
      btn.onclick = function(e) {
        e.stopPropagation();
        if (btn.disabled) return;

        var key = btn.getAttribute('data-key');
        var dir = btn.getAttribute('data-dir');
        var history = ROSTER_UPDATES_STATE.grouped[key];
        if (!history) return;

        var currentIdx = ROSTER_UPDATES_STATE.currentIdx[key] || 0;

        if (dir === 'prev' && currentIdx < history.length - 1) {
          currentIdx++;
        } else if (dir === 'next' && currentIdx > 0) {
          currentIdx--;
        }

        ROSTER_UPDATES_STATE.currentIdx[key] = currentIdx;

        // Re-render just this item
        var itemEl = container.querySelector('[data-key="' + key + '"]');
        if (itemEl) {
          var newHtml = renderSingleUpdate(key, history[currentIdx], currentIdx, history.length);
          var temp = document.createElement('div');
          temp.innerHTML = newHtml;
          itemEl.replaceWith(temp.firstChild);
          bindRosterUpdateNavigation(); // Rebind
        }
      };
    });
  }
  
  // Navigate through roster history for a specific role/date
  function navigateRosterHistory(roleId, serviceDate, direction) {
    // Call server to get full history for this role/date
    callGAS('getRosterHistory', [roleId, serviceDate]).then(function(history) {
      if (!history || !history.length) {
        showToast('No history available for this cell', 'warning');
        return;
      }
      
      // Show history modal
      showRosterHistoryModal(roleId, serviceDate, history);
    }).catch(function(err) {
      console.error('Failed to get history:', err);
      showToast('Failed to load history', 'error');
    });
  }
  
  // Show roster history modal
  function showRosterHistoryModal(roleId, serviceDate, history) {
    var modal = document.getElementById('rosterHistoryModal');
    if (!modal) {
      // Create modal if it doesn't exist
      modal = document.createElement('div');
      modal.id = 'rosterHistoryModal';
      modal.className = 'modal-overlay';
      modal.innerHTML = '<div class="modal-content" style="width: min(400px, 90%); padding: 0;"><div class="p-4 border-b border-slate-200 flex items-center justify-between"><h3 class="font-semibold text-slate-800"><i class="fa-solid fa-clock-rotate-left mr-2 text-indigo-500"></i> Change History</h3><button onclick="closeModal(\'rosterHistoryModal\')" class="lhc-pill-button"><i class="fa-solid fa-xmark"></i></button></div><div id="rosterHistoryContent" class="p-4 max-h-80 overflow-y-auto"></div></div>';
      document.body.appendChild(modal);
    }
    
    // Format role name nicely
    var roleName = roleId.replace(/([a-z])([0-9])/gi, '$1 $2');
    roleName = roleName.charAt(0).toUpperCase() + roleName.slice(1);
    
    var content = document.getElementById('rosterHistoryContent');
    var html = '<p class="text-sm text-slate-500 mb-3"><strong>' + escapeHtml(roleName) + '</strong> - ' + escapeHtml(serviceDate) + '</p>';
    html += '<div class="space-y-2">';
    
    history.forEach(function(item, idx) {
      var dateStr = '';
      if (item.timestamp) {
        try {
          var d = new Date(item.timestamp);
          dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch(e) {}
      }
      var isLatest = idx === 0;
      html += '<div class="flex items-center justify-between p-3 rounded-lg ' + (isLatest ? 'bg-green-50 border-2 border-green-300' : 'bg-slate-50 border border-slate-200') + '">';
      html += '<div>';
      html += '<span class="font-medium text-slate-700">' + escapeHtml(item.value || 'TBD') + '</span>';
      if (isLatest) html += '<span class="ml-2 text-xs bg-green-500 text-white px-1.5 py-0.5 rounded">Current</span>';
      html += '</div>';
      html += '<span class="text-xs text-slate-400">' + dateStr + '</span>';
      html += '</div>';
    });
    
    html += '</div>';
    
    content.innerHTML = html;
    modal.classList.add('show');
  }

  // ============================================================
  // 12) EDIT SONG MODAL
  // ============================================================
  function openEditSongModal(song) {
    $('editSongId').value = song.id;
    $('editSongTitle').value = song.title || '';
    $('editSongArtist').value = song.artist || '';
    $('editSongCategory').value = song.style || song.category || '';
    $('editSongKey').value = song.key || '';
    $('editSongTempo').value = song.tempo || '';
    $('editSongTheme').value = song.theme || '';
    $('editSongSeason').value = song.season || '';
    
    // Load data into new modal structure
    if (typeof window.loadEditSongData === 'function') {
      window.loadEditSongData(song);
    }
    
    openModal('editSongModal');
  }

  function saveEditSong() {
    var songId = $('editSongId').value;
    var title = ($('editSongTitle').value || '').trim();
    if (!title) {
      showToast('Song title is required', 'error');
      return;
    }

    // Get lyrics from hidden field (set by lyrics editor)
    var lyricsData = $('editSongLyricsData') ? $('editSongLyricsData').value : '';
    
    // Get YouTube URLs - combine into single field for now
    var youtubeUrls = window.songData && window.songData.edit ? window.songData.edit.youtube.join(', ') : '';
    
    // Get attachments - combine into single field for now
    var attachmentUrls = '';
    if (window.songData && window.songData.edit && window.songData.edit.attachments.length) {
      attachmentUrls = window.songData.edit.attachments.map(function(a) { return a.url; }).join(', ');
    }

    var songData = {
      id: songId,
      title: title,
      artist: $('editSongArtist').value || '',
      category: $('editSongCategory').value || '',
      key: $('editSongKey').value || '',
      tempo: $('editSongTempo').value || '',
      theme: $('editSongTheme').value || '',
      season: $('editSongSeason').value || '',
      youtube: youtubeUrls,
      lyricsUrl: attachmentUrls,
      lyrics: lyricsData
    };

    showLoader(true);
    callGAS('updateSong', [songData]).then(function(result) {
      showToast('Song updated successfully!', 'success');
      closeModal('editSongModal');
      loadSongs();
    }).catch(function(err) {
      console.error(err);
      showToast('Failed to update song', 'error');
    }).finally(function() {
      showLoader(false);
    });
  }

  function deleteSong() {
    var songId = $('editSongId').value;
    var title = $('editSongTitle').value;
    
    if (!confirm('Are you sure you want to delete "' + title + '"?\n\nThis action cannot be undone.')) {
      return;
    }

    showLoader(true);
    callGAS('deleteSong', [songId]).then(function(result) {
      showToast('Song deleted successfully!', 'success');
      closeModal('editSongModal');
      loadSongs();
    }).catch(function(err) {
      console.error(err);
      showToast('Failed to delete song', 'error');
    }).finally(function() {
      showLoader(false);
    });
  }

  // ============================================================
  // 13) LYRICS PREVIEW MODAL (from song card)
  // ============================================================
  function openLyricsPreviewModal(song) {
    STATE.lyricsCurrentSong = song;
    
    // Use the global function from Part 4
    if (typeof window.setLyricsPreviewSong === 'function') {
      window.setLyricsPreviewSong(song);
    }
    
    openModal('lyricsPreviewModal');
  }
  
  function updateLyricsPreviewDisplay() {
    var song = STATE.lyricsCurrentSong;
    if (!song) return;
    
    var container = $('lyricsPreviewContent');
    if (!container) return;
    
    var lyrics = song.lyrics || '';
    if (!lyrics.trim()) {
      container.innerHTML = '<div class="p-8 text-center text-slate-400"><i class="fa-solid fa-file-lines text-4xl mb-3 opacity-50"></i><p>No lyrics available for this song.</p></div>';
      return;
    }
    
    var showChords = STATE.lyricsMode === 'chords';
    container.innerHTML = formatLyricsForPreview(lyrics, showChords);
  }
  
  function formatLyricsForPreview(text, showChords) {
    var lines = text.split('\n');
    var html = '';
    
    var isChordLine = function(line) {
      var trimmed = line.trim();
      if (!trimmed) return false;
      var chordPattern = /^[\sA-G#bmdimaug7sus249\/\(\)]+$/i;
      return chordPattern.test(trimmed) && /[A-G]/.test(trimmed);
    };
    
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      var trimmed = line.trim();
      
      if (trimmed.match(/^\[.+\]$/)) {
        var sectionName = trimmed.slice(1, -1);
        html += '<div class="section-header">' + escapeHtml(sectionName) + '</div>';
      } else if (isChordLine(line)) {
        if (showChords) {
          html += '<div class="chord-line">' + escapeHtml(line) + '</div>';
        }
      } else if (trimmed) {
        html += '<div class="lyric-line">' + escapeHtml(line) + '</div>';
      } else {
        html += '<div style="height: 10px;"></div>';
      }
    }
    
    return html;
  }
  
  function printLyrics(format) {
    var song = STATE.lyricsCurrentSong;
    if (!song) return;
    
    var showChords = STATE.lyricsMode === 'chords';
    var content = formatLyricsForPreview(song.lyrics || '', showChords);
    
    var printWindow = window.open('', '_blank');
    printWindow.document.write('<!DOCTYPE html><html><head><title>' + escapeHtml(song.title) + ' - Lyrics</title>');
    printWindow.document.write('<style>');
    printWindow.document.write('body { font-family: Georgia, serif; padding: 40px; max-width: 800px; margin: 0 auto; }');
    printWindow.document.write('.song-title { font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 8px; }');
    printWindow.document.write('.song-artist { font-size: 16px; text-align: center; color: #666; margin-bottom: 30px; }');
    printWindow.document.write('.section-header { font-weight: bold; color: #4f46e5; margin: 20px 0 10px 0; font-size: 14px; text-transform: uppercase; }');
    printWindow.document.write('.chord-line { color: #dc2626; font-weight: bold; font-family: Courier New, monospace; margin-bottom: -2px; }');
    printWindow.document.write('.lyric-line { font-size: 16px; line-height: 1.6; }');
    printWindow.document.write('@media print { body { padding: 20px; } }');
    printWindow.document.write('</style></head><body>');
    printWindow.document.write('<div class="song-title">' + escapeHtml(song.title) + '</div>');
    if (song.artist) {
      printWindow.document.write('<div class="song-artist">' + escapeHtml(song.artist) + '</div>');
    }
    printWindow.document.write(content);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    setTimeout(function() {
      printWindow.print();
    }, 500);
  }
  
  // ============================================================
  // 13B) DOC PREVIEW MODAL
  // ============================================================
  function openDocPreviewModal(url, title) {
    var modal = $('docPreviewModal');
    if (!modal) return;
    
    $('docPreviewTitle').textContent = title || 'Document';
    
    var frame = $('docPreviewFrame');
    if (url.includes('drive.google.com/file/d/')) {
      var fileId = url.match(/\/d\/([^\/\?]+)/);
      if (fileId) {
        frame.src = 'https://drive.google.com/file/d/' + fileId[1] + '/preview';
      }
    } else if (url.includes('docs.google.com')) {
      frame.src = url.replace('/edit', '/preview').replace('/view', '/preview');
    } else {
      frame.src = url;
    }
    
    // Store original URL for "Open in New Tab" button
    $('docPreviewOpenBtn').onclick = function() {
      window.open(url, '_blank');
    };
    
    openModal('docPreviewModal');
  }
  
  function closeDocPreview() {
    $('docPreviewFrame').src = '';
    closeModal('docPreviewModal');
  }
  
  // ============================================================
  // 13C) YOUTUBE PREVIEW MODAL
  // ============================================================
  function openYoutubePreviewModal(url, title) {
    var modal = $('youtubePreviewModal');
    if (!modal) return;
    
    $('youtubePreviewTitle').textContent = title || 'Video';
    
    var videoId = extractYoutubeId(url);
    if (videoId) {
      $('youtubePreviewFrame').src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
    }
    
    // Store original URL for "Open on YouTube" button
    $('youtubePreviewOpenBtn').onclick = function() {
      window.open(url, '_blank');
    };
    
    openModal('youtubePreviewModal');
  }
  
  function extractYoutubeId(url) {
    var match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([^?&]+)/);
    return match ? match[1] : '';
  }
  
  function closeYoutubePreview() {
    $('youtubePreviewFrame').src = '';
    closeModal('youtubePreviewModal');
  }

  // ============================================================
  // 14) OLD LYRICS MODAL (kept for compatibility)
  // ============================================================
  function openLyricsModal(song) {
    STATE.lyricsCurrentSong = song;
    STATE.lyricsMode = 'overall';
    STATE.lyricsSlides = (song.lyrics || '').split(/\n\s*\n/).filter(function(s) { return s.trim(); });
    STATE.lyricsSlideIndex = 0;
    STATE.lyricsEditMode = false;

    $('lyricsModalTitle').innerHTML = '<i class="fa-solid fa-file-lines mr-2 text-indigo-500"></i> ' + escapeHtml(song.title);
    $('lyricsModalArtist').textContent = song.artist || '';

    updateLyricsDisplay();
    openModal('lyricsModal');
  }

  function updateLyricsDisplay() {
    var song = STATE.lyricsCurrentSong;
    if (!song) return;

    $('lyricsModeOverall').classList.toggle('lhc-pill-button-active', STATE.lyricsMode === 'overall');
    $('lyricsModePresent').classList.toggle('lhc-pill-button-active', STATE.lyricsMode === 'present');

    var counter = $('lyricsSlideCounter');
    if (STATE.lyricsMode === 'present' && STATE.lyricsSlides.length) {
      counter.textContent = (STATE.lyricsSlideIndex + 1) + ' / ' + STATE.lyricsSlides.length;
    } else {
      counter.textContent = STATE.lyricsSlides.length ? STATE.lyricsSlides.length + ' slides' : '‚Äî';
    }

    var contentArea = $('lyricsContentArea');
    var editArea = $('lyricsEditArea');
    var editBtn = $('lyricsEditBtn');
    var saveBtn = $('lyricsSaveBtn');
    var cancelBtn = $('lyricsCancelEditBtn');

    if (STATE.lyricsEditMode) {
      contentArea.style.display = 'none';
      editArea.classList.remove('hidden');
      $('lyricsEditTextarea').value = song.lyrics || '';
      editBtn.classList.add('hidden');
      saveBtn.classList.remove('hidden');
      cancelBtn.classList.remove('hidden');
    } else {
      contentArea.style.display = 'block';
      editArea.classList.add('hidden');
      editBtn.classList.remove('hidden');
      saveBtn.classList.add('hidden');
      cancelBtn.classList.add('hidden');

      var display = $('lyricsTextDisplay');
      if (STATE.lyricsMode === 'overall') {
        display.innerHTML = song.lyrics 
          ? '<pre class="whitespace-pre-wrap text-sm text-slate-700 font-sans leading-relaxed">' + escapeHtml(song.lyrics) + '</pre>'
          : '<p class="text-slate-400 italic text-center py-8">No lyrics available for this song.</p>';
      } else {
        var slide = STATE.lyricsSlides[STATE.lyricsSlideIndex] || '';
        display.innerHTML = slide
          ? '<div class="text-center text-xl md:text-2xl font-medium text-slate-800 py-8 leading-relaxed">' + escapeHtml(slide).replace(/\n/g, '<br>') + '</div>'
          : '<p class="text-slate-400 italic text-center py-8">No slides available.</p>';
      }
    }
  }

  function lyricsNavigate(direction) {
    if (STATE.lyricsMode !== 'present') return;
    var newIndex = STATE.lyricsSlideIndex + direction;
    if (newIndex >= 0 && newIndex < STATE.lyricsSlides.length) {
      STATE.lyricsSlideIndex = newIndex;
      updateLyricsDisplay();
    }
  }

  function saveLyricsEdit() {
    var song = STATE.lyricsCurrentSong;
    if (!song) return;

    var newLyrics = $('lyricsEditTextarea').value;

    showLoader(true);
    callGAS('updateSongLyrics', [song.id, newLyrics]).then(function() {
      song.lyrics = newLyrics;
      STATE.lyricsSlides = newLyrics.split(/\n\s*\n/).filter(function(s) { return s.trim(); });
      STATE.lyricsSlideIndex = 0;

      var idx = -1;
      STATE.songs.forEach(function(s, i) { if (s.id === song.id) idx = i; });
      if (idx >= 0) STATE.songs[idx].lyrics = newLyrics;

      STATE.lyricsEditMode = false;
      updateLyricsDisplay();
      showToast('Lyrics saved!', 'success');
    }).catch(function(err) {
      console.error(err);
      showToast('Failed to save lyrics', 'error');
    }).finally(function() {
      showLoader(false);
    });
  }

  // ============================================================
  // 14) PREVIEW MODAL
  // ============================================================
  function openPreviewModal(song) {
    $('previewModalTitle').innerHTML = '<i class="fa-solid fa-eye mr-2 text-indigo-500"></i> ' + escapeHtml(song.title);
    
    var iframe = $('previewIframe');
    var url = song.lyricsUrl || song.youtube || '';

    if (url) {
      iframe.src = fixPreviewUrl(url);
    } else {
      iframe.src = 'about:blank';
      showToast('No preview URL available', 'warning');
    }

    openModal('previewModal');
  }

  function fixPreviewUrl(url) {
    var s = String(url || '').trim();
    if (!s) return '';

    // Google Drive file
    var m = s.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/);
    if (m) return 'https://drive.google.com/file/d/' + m[1] + '/preview';

    m = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
    if (m) return 'https://drive.google.com/file/d/' + m[1] + '/preview';

    // YouTube
    m = s.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
    if (m) return 'https://www.youtube.com/embed/' + m[1];

    m = s.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
    if (m) return 'https://www.youtube.com/embed/' + m[1];

    return s;
  }

  // ============================================================
  // 15) ADD NEW SONG
  // ============================================================
  function saveNewSong() {
    var title = ($('newSongTitle').value || '').trim();
    if (!title) {
      showToast('Song title is required', 'error');
      return;
    }

    // Get lyrics from hidden field (set by lyrics editor)
    var lyricsData = $('newSongLyricsData') ? $('newSongLyricsData').value : '';
    
    // Get YouTube URLs - combine into single field for now
    var youtubeUrls = window.songData && window.songData.new ? window.songData.new.youtube.join(', ') : '';
    
    // Get attachments - combine into single field for now
    var attachmentUrls = '';
    if (window.songData && window.songData.new && window.songData.new.attachments.length) {
      attachmentUrls = window.songData.new.attachments.map(function(a) { return a.url; }).join(', ');
    }

    var songData = {
      title: title,
      artist: $('newSongArtist').value || '',
      category: $('newSongCategory').value || '',
      key: $('newSongKey').value || '',
      tempo: $('newSongTempo').value || '',
      theme: $('newSongTheme').value || '',
      season: $('newSongSeason').value || '',
      youtube: youtubeUrls,
      lyricsUrl: attachmentUrls,
      lyrics: lyricsData
    };

    showLoader(true);
    callGAS('createSong', [songData]).then(function(result) {
      showToast('Song added successfully!', 'success');
      closeModal('addSongModal');
      
      // Clear form and reset song data
      ['newSongTitle', 'newSongArtist', 'newSongCategory', 'newSongKey', 'newSongTempo', 
       'newSongTheme', 'newSongSeason']
        .forEach(function(id) { var el = $(id); if (el) el.value = ''; });
      
      if (typeof window.resetNewSongData === 'function') {
        window.resetNewSongData();
      }

      loadSongs();
    }).catch(function(err) {
      console.error(err);
      showToast('Failed to add song', 'error');
    }).finally(function() {
      showLoader(false);
    });
  }

  // ============================================================
  // 16) DATA LOADING
  // ============================================================
  function loadSongs() {
    return callGAS('getSongs', []).then(function(songs) {
      STATE.songs = (songs || []).map(normalizeSong).filter(Boolean);
      populateFilterDropdowns();
      renderSongs(false);
      renderSongStats();
      $('backendStatus').textContent = 'Backend: Connected ‚úì';
      $('backendStatus').style.color = '#86efac';
    }).catch(function(err) {
      console.error('Failed to load songs:', err);
      $('backendStatus').textContent = 'Backend: Error ‚úó';
      $('backendStatus').style.color = '#fca5a5';
      showToast('Failed to load songs', 'error');
    });
  }

  function loadOrders() {
    return callGAS('getOrders', []).then(function(orders) {
      STATE.orders = orders || [];
      renderOrdersList();
    }).catch(function(err) {
      console.error('Failed to load orders:', err);
    });
  }

  function renderOrdersList() {
    // Orders list is now replaced by Song Statistics
    // This function kept for compatibility but does nothing visible
  }

  function loadOrderDetail(orderId) {
    showLoader(true);
    callGAS('loadOrder', [orderId]).then(function(order) {
      STATE.currentOrder = order;
      setActiveView('worshipOrderView');
      renderOrderDetail();
    }).catch(function(err) {
      console.error(err);
      showToast('Failed to load order', 'error');
    }).finally(function() {
      showLoader(false);
    });
  }

  function renderOrderDetail() {
    var order = STATE.currentOrder;
    var container = $('orderSectionsContainer');
    var emptyState = $('orderEmptyState');

    if (!order) {
      if (emptyState) emptyState.style.display = 'block';
      if (container) container.innerHTML = '';
      return;
    }

    if (emptyState) emptyState.style.display = 'none';

    $('orderViewTitle').textContent = order.title || 'Worship Order';
    $('orderViewDate').textContent = order.serviceDate ? 'Service Date: ' + order.serviceDate : '';

    if (container) {
      container.innerHTML = '<div class="p-4 bg-slate-50 rounded-xl text-center text-slate-500"><p>Order loaded. Song arrangement coming in Phase 2.</p></div>';
    }
  }

  function loadAllData() {
    showLoader(true);
    Promise.all([loadSongs(), loadOrders()]).then(function() {
      showToast('Data loaded!', 'success');
    }).catch(function(err) {
      console.error(err);
    }).finally(function() {
      showLoader(false);
    });
  }

  // ============================================================
  // 17) SHARE FUNCTIONALITY
  // ============================================================
  function setupShareModal() {
    var waBtn = $('shareWhatsAppBtn');
    var fbBtn = $('shareFacebookBtn');
    var emBtn = $('shareEmailBtn');
    var cpBtn = $('copyLinkBtn');

    if (waBtn) waBtn.onclick = function() {
      var link = $('shareLinkInput').value || window.location.href;
      window.open('https://wa.me/?text=' + encodeURIComponent('LHC Worship Prep: ' + link), '_blank');
    };

    if (fbBtn) fbBtn.onclick = function() {
      var link = $('shareLinkInput').value || window.location.href;
      window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(link), '_blank');
    };

    if (emBtn) emBtn.onclick = function() {
      var link = $('shareLinkInput').value || window.location.href;
      window.location.href = 'mailto:?subject=' + encodeURIComponent('LHC Worship Prep') + '&body=' + encodeURIComponent(link);
    };

    if (cpBtn) cpBtn.onclick = function() {
      var link = $('shareLinkInput').value || window.location.href;
      navigator.clipboard.writeText(link).then(function() {
        showToast('Link copied!', 'success');
      }).catch(function() {
        showToast('Failed to copy', 'error');
      });
    };
  }

  // ============================================================
  // 18) CORE EVENT BINDINGS
  // ============================================================
  function bindCoreEvents() {
    // Navigation buttons
    var nsfb = $('navSongFinderBtn'); if (nsfb) nsfb.onclick = function() { setActiveView('songFinderView'); };
    var nrb = $('navRosterBtn'); if (nrb) nrb.onclick = function() { setActiveView('worshipRosterView'); };
    var nob = $('navOrdersBtn'); if (nob) nob.onclick = function() { setActiveView('worshipOrderView'); };

    // Refresh button
    var rdb = $('refreshDataBtn'); if (rdb) rdb.onclick = loadAllData;

    // Search input
    var si = $('searchInput');
    if (si) {
      si.oninput = debounce(function(e) {
        STATE.filters.q = e.target.value.trim();
        $('clearSearchBtn').classList.toggle('hidden', !STATE.filters.q);
        renderSearchSuggestions(STATE.filters.q);
        renderSongs(!!STATE.filters.q);
      }, 200);

      si.onkeydown = function(e) {
        if (e.key === 'Enter') { $('searchSuggestions').classList.remove('show'); renderSongs(true); }
        if (e.key === 'Escape') { $('searchSuggestions').classList.remove('show'); }
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { e.preventDefault(); navSuggestions(e.key === 'ArrowDown' ? 1 : -1); }
      };

      si.onfocus = function() { if (STATE.filters.q && STATE.filters.q.length >= 1) renderSearchSuggestions(STATE.filters.q); };
    }

    var cb = $('clearSearchBtn'); if (cb) cb.onclick = function() { $('searchInput').value = ''; STATE.filters.q = ''; $('clearSearchBtn').classList.add('hidden'); $('searchSuggestions').classList.remove('show'); renderSongs(false); };

    document.onclick = function(e) { var sg = $('searchSuggestions'), si = $('searchInput'); if (sg && !sg.contains(e.target) && e.target !== si) sg.classList.remove('show'); };

    ['filterTheme','filterKey','filterStyle','filterTempo','filterSeason','sortBy'].forEach(function(id) {
      var el = $(id); if (el) el.onchange = function(e) { var k = id.replace('filter','').toLowerCase(); if (k === 'sortby') STATE.filters.sort = e.target.value; else STATE.filters[k] = e.target.value; renderSongs(true); };
    });

    var ab = $('openAddSongBtn'); if (ab) ab.onclick = function() { openModal('addSongModal'); };
    var snb = $('saveNewSongBtn'); if (snb) snb.onclick = saveNewSong;
    var seb = $('saveEditSongBtn'); if (seb) seb.onclick = saveEditSong;
    var db = $('deleteSongBtn'); if (db) db.onclick = deleteSong;

    var lo = $('lyricsModeOverall'), lp = $('lyricsModePresent'), lpv = $('lyricsPrevSlide'), lnx = $('lyricsNextSlide'), le = $('lyricsEditBtn'), ls = $('lyricsSaveBtn'), lc = $('lyricsCancelEditBtn');
    if (lo) lo.onclick = function() { STATE.lyricsMode = 'overall'; updateLyricsDisplay(); };
    if (lp) lp.onclick = function() { STATE.lyricsMode = 'present'; updateLyricsDisplay(); };
    if (lpv) lpv.onclick = function() { lyricsNavigate(-1); };
    if (lnx) lnx.onclick = function() { lyricsNavigate(1); };
    if (le) le.onclick = function() { STATE.lyricsEditMode = true; updateLyricsDisplay(); };
    if (ls) ls.onclick = saveLyricsEdit;
    if (lc) lc.onclick = function() { STATE.lyricsEditMode = false; updateLyricsDisplay(); };

    var smb = $('openShareModalBtn'); if (smb) smb.onclick = function() { $('shareLinkInput').value = location.href; openModal('shareModal'); };
    var hb = $('openHelpBtn'); if (hb) hb.onclick = function() { openModal('helpModal'); };
    var cob = $('createOrderBtn'), nofv = $('newOrderFromViewBtn');
    if (cob) cob.onclick = function() { openModal('createOrderModal'); };
    if (nofv) nofv.onclick = function() { openModal('createOrderModal'); };

    document.onkeydown = function(e) {
      if (e.key === 'Escape') ['addSongModal','editSongModal','lyricsModal','previewModal','shareModal','helpModal','createOrderModal'].forEach(closeModal);
      var lm = $('lyricsModal');
      if (lm && lm.classList.contains('show') && STATE.lyricsMode === 'present' && !STATE.lyricsEditMode) {
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); lyricsNavigate(1); }
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); lyricsNavigate(-1); }
      }
    };

    bindStatTabs();
  }

  // ============================================================
  // 19) MODAL SETUP
  // ============================================================
  function setupAllModals() {
    setupModalClose('addSongModal', 'closeAddSongBtn', ['cancelAddSongBtn']);
    setupModalClose('editSongModal', 'closeEditSongBtn', ['cancelEditSongBtn']);
    setupModalClose('lyricsModal', 'closeLyricsBtn');
    setupModalClose('previewModal', 'closePreviewBtn');
    setupModalClose('shareModal', 'closeShareBtn');
    setupModalClose('helpModal', 'closeHelpBtn');
    setupModalClose('createOrderModal', 'closeCreateOrderBtn', ['cancelCreateOrderBtn']);
    setupShareModal();
  }

  // ============================================================
  // 20) INITIALIZATION
  // ============================================================
  function init() {
    console.log('LHC Worship Prep v1.1 initializing...');
    setupAllModals();
    bindCoreEvents();
    setActiveView('songFinderView');
    loadAllData();
    console.log('LHC Worship Prep initialized.');
  }

  document.addEventListener('DOMContentLoaded', init);
  window.LHC_STATE = STATE;
})();
</script>

<!-- ======================= END PART 5/6 ======================= -->
<!-- ======================= LHC Worship Prep ‚Äî index.html (PART 6/6) ======================= -->
<!-- Part 6: IMPROVED RosterEngine v1.7 -->

<style>
  .roster-table { font-size: 11px !important; }
  .roster-table th, .roster-table td { padding: 8px 6px !important; }
  .roster-table th:first-child { min-width: 160px !important; padding-left: 12px !important; }
  .roster-table td:first-child { padding-left: 12px !important; font-size: 10px !important; }
  .roster-date-chip { padding: 4px 10px !important; font-size: 9px !important; margin-bottom: 4px !important; }
  .roster-share-btn { padding: 3px 8px !important; font-size: 9px !important; }
  .altar-color-dot { width: 14px !important; height: 14px !important; margin-right: 5px !important; }
  .roster-section-header td { padding: 10px !important; font-size: 12px !important; }
  .roster-inline-editor { font-size: 11px !important; padding: 4px 6px !important; }
  .roster-special-day { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important; }
  .roster-special-day .roster-date-chip { background: rgba(180, 83, 9, 0.3) !important; color: #92400e !important; }
  .roster-filter-btn { padding: 6px 12px; font-size: 11px; font-weight: 600; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #475569; cursor: pointer; transition: all 0.2s ease; font-family: "Poppins", sans-serif; }
  .roster-filter-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
  .roster-filter-btn.active { background: linear-gradient(135deg, var(--roster-teal-dark), var(--roster-teal)); color: white; border-color: transparent; }
  .roster-month-select, .roster-year-select { padding: 6px 28px 6px 10px; font-size: 14px; font-weight: 600; font-family: "Poppins", sans-serif; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 6px center; background-size: 14px; }
  .roster-month-select:hover, .roster-year-select:hover { border-color: var(--roster-teal); }
  .roster-month-select:focus, .roster-year-select:focus { outline: none; border-color: var(--roster-teal); box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15); }
  .roster-context-menu { position: fixed; z-index: 10001; background: white; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 8px 0; min-width: 220px; display: none; font-family: "Poppins", sans-serif; }
  .roster-context-menu.show { display: block; }
  .roster-context-menu-item { padding: 8px 16px; font-size: 12px; color: #374151; cursor: pointer; transition: background 0.15s; }
  .roster-context-menu-item:hover { background: #f1f5f9; }
  .roster-context-menu-divider { height: 1px; background: #e2e8f0; margin: 4px 0; }
  .roster-context-menu-info { padding: 8px 16px; font-size: 10px; color: #94a3b8; border-top: 1px solid #e2e8f0; margin-top: 4px; }
  /* History items in context menu */
  .history-list { max-height: 150px; overflow-y: auto; }
  .history-item { padding: 8px 16px; font-size: 11px; color: #475569; cursor: pointer; transition: background 0.15s; display: flex; justify-content: space-between; align-items: center; }
  .history-item:hover { background: #ecfdf5; color: #059669; }
  .history-item .history-date { font-size: 9px; color: #94a3b8; margin-left: 8px; }
  /* Clickable date links */
  .roster-date-link { cursor: pointer !important; transition: all 0.2s !important; }
  .roster-date-link:hover { background: rgba(255,255,255,0.3) !important; transform: scale(1.05) !important; box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important; }
  /* Roster cell highlight glow */
  .roster-highlight-glow {
    animation: glowPulse 0.5s ease-in-out infinite alternate !important;
    box-shadow: 0 0 20px 5px rgba(34, 197, 94, 0.6), inset 0 0 10px rgba(34, 197, 94, 0.3) !important;
    background: rgba(34, 197, 94, 0.2) !important;
  }
  @keyframes glowPulse {
    from { box-shadow: 0 0 15px 3px rgba(34, 197, 94, 0.5), inset 0 0 8px rgba(34, 197, 94, 0.2); }
    to { box-shadow: 0 0 25px 8px rgba(34, 197, 94, 0.7), inset 0 0 12px rgba(34, 197, 94, 0.4); }
  }
  /* Roster update sidebar highlight */
  .roster-update-highlight {
    animation: sidebarGlow 0.5s ease-in-out infinite alternate !important;
    background: rgba(251, 191, 36, 0.4) !important;
    border: 2px solid rgba(251, 191, 36, 0.8) !important;
  }
  @keyframes sidebarGlow {
    from { box-shadow: 0 0 10px 2px rgba(251, 191, 36, 0.5); }
    to { box-shadow: 0 0 20px 5px rgba(251, 191, 36, 0.8); }
  }

  /* ==================== PRINT STYLES - ROSTER TABLE ONLY ==================== */
  @media print {
    /* Hide everything except roster content */
    body * {
      visibility: hidden;
    }

    /* Show only the roster table container */
    #rosterTableContainer,
    #rosterTableContainer * {
      visibility: visible;
    }

    /* Position the roster table at top of page */
    #rosterTableContainer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: 20px;
    }

    /* Hide navigation, buttons, sidebar, header */
    .sidebar,
    #sidebar,
    .tab-content-area > div:not(#rosterSection),
    .roster-nav-btn,
    .roster-action-btn,
    .roster-filter-btn,
    #rosterSaveBtn,
    #rosterDownloadCSVBtn,
    #rosterDownloadPDFBtn,
    .roster-controls,
    .roster-legend,
    .roster-header,
    #rosterUnsavedIndicator,
    #rosterSyncStatus,
    .roster-share-btn,
    button,
    .tab-bar,
    nav,
    header,
    footer,
    .modal-overlay {
      display: none !important;
    }

    /* Style the table for printing */
    .roster-table {
      width: 100% !important;
      font-size: 10px !important;
      border-collapse: collapse !important;
    }

    .roster-table th,
    .roster-table td {
      border: 1px solid #333 !important;
      padding: 6px 8px !important;
      background: white !important;
      color: black !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .roster-table th {
      background: #e5e7eb !important;
      font-weight: bold !important;
    }

    .roster-section-header td {
      background: #d1d5db !important;
      font-weight: bold !important;
    }

    /* Add page title for print */
    #rosterTableContainer::before {
      content: "LHC Worship Duty Roster";
      display: block;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      visibility: visible;
    }
  }
</style>

<div id="rosterContextMenu" class="roster-context-menu">
  <div class="roster-context-menu-item" id="ctxEditCell"><i class="fa-solid fa-pen mr-2"></i> Edit Cell</div>
  <div class="roster-context-menu-item" id="ctxClearCell"><i class="fa-solid fa-eraser mr-2"></i> Clear Cell</div>
  <div class="roster-context-menu-item" id="ctxSeeChangeLog"><i class="fa-solid fa-clock-rotate-left mr-2"></i> See Change Log</div>
  <div class="roster-context-menu-divider"></div>
  <div class="roster-context-menu-info" id="ctxLastEdited"><i class="fa-solid fa-clock mr-1"></i> Last edited: Never</div>
  <div id="ctxHistorySection" class="hidden">
    <div class="roster-context-menu-divider"></div>
    <div style="padding: 6px 16px; font-size: 10px; color: #64748b; font-weight: 600;">PREVIOUS ENTRIES</div>
    <div id="ctxHistoryList" class="history-list"></div>
  </div>
</div>

<script>
(function() {
  "use strict";
  var STATE = window.LHC_STATE || { rosterMonth: new Date().getMonth(), rosterYear: new Date().getFullYear(), rosterEdits: new Map(), rosterHasUnsaved: false, rosterFilter: 'all', rosterCellTimestamps: new Map() };
  if (!STATE.rosterCellTimestamps) STATE.rosterCellTimestamps = new Map();
  if (!STATE.rosterFilter) STATE.rosterFilter = 'all';

  // Name options for roster dropdowns - stored in localStorage
  var ROSTER_NAME_OPTIONS = (function() {
    var stored = localStorage.getItem('lhc_roster_names');
    if (stored) {
      try { return JSON.parse(stored); } catch(e) { console.warn('Failed to parse stored names:', e); }
    }
    // Default names for each role category
    return {
      preacher: ['Pastor Smith', 'Pastor Johnson', 'Deacon Brown'],
      liturgist: ['Elder Williams', 'Elder Davis', 'Deacon Miller'],
      usher: ['John Doe', 'Jane Smith', 'Bob Wilson', 'Mary Johnson'],
      reader: ['Sarah Connor', 'James White', 'Lisa Green', 'Mark Taylor'],
      communion: ['Ruth Adams', 'Peter Clark', 'Anna Lee', 'David Kim'],
      altar: ['Martha Jones', 'Elizabeth Brown', 'Grace Chen'],
      musician: ['Michael Scott', 'Angela Martin', 'Kevin Malone', 'Andy Bernard'],
      singer: ['Phyllis Vance', 'Stanley Hudson', 'Kelly Kapoor', 'Ryan Howard'],
      tech: ['Jim Halpert', 'Dwight Schrute', 'Oscar Martinez'],
      general: ['Member 1', 'Member 2', 'Member 3']
    };
  })();

  function saveRosterNameOptions() {
    localStorage.setItem('lhc_roster_names', JSON.stringify(ROSTER_NAME_OPTIONS));
  }

  function getRoleCategory(roleId) {
    if (roleId === 'preacher') return 'preacher';
    if (roleId === 'liturgist') return 'liturgist';
    if (roleId.startsWith('usher')) return 'usher';
    if (roleId.startsWith('reader')) return 'reader';
    if (roleId.startsWith('communion')) return 'communion';
    if (roleId.startsWith('altar')) return 'altar';
    if (['pianist', 'guitarist', 'bassist', 'drummer'].includes(roleId)) return 'musician';
    if (roleId.startsWith('singer')) return 'singer';
    if (['lcd', 'streaming', 'pa'].includes(roleId)) return 'tech';
    return 'general';
  }

  function addNameToRole(category, name) {
    if (!ROSTER_NAME_OPTIONS[category]) ROSTER_NAME_OPTIONS[category] = [];
    if (!ROSTER_NAME_OPTIONS[category].includes(name)) {
      ROSTER_NAME_OPTIONS[category].push(name);
      ROSTER_NAME_OPTIONS[category].sort();
      saveRosterNameOptions();
    }
  }

  var RosterEngine = {
    MONTHS: ['January','February','March','April','May','June','July','August','September','October','November','December'],
    MONTHS_SHORT: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
    SEASONS: {0:'Epiphany Season',1:'Epiphany Season',2:'Lenten Season',3:'Easter Season',4:'Easter Season',5:'Ordinary Time',6:'Ordinary Time',7:'Ordinary Time',8:'Ordinary Time',9:'Reformation / End Times',10:'End Times / Christ the King',11:'Advent Season'},
    COLORS: {Green:'#22c55e',Purple:'#a855f7',White:'#f8fafc',Red:'#ef4444',Gold:'#eab308',Blue:'#3b82f6',Rose:'#f472b6'},
    COLOR_NAMES: ['Green','Purple','White','Red','Gold','Blue','Rose'],
    DEFAULT_COLORS: {0:'Green',1:'Green',2:'Purple',3:'White',4:'White',5:'Green',6:'Green',7:'Green',8:'Green',9:'Red',10:'Green',11:'Purple'},
    
    ROLES: [
      {type:'liturgical',id:'liturgical',label:'üìÖ Liturgical Day',group:'all'},
      {type:'role',id:'preacher',label:'‚õ™ Preacher',group:'all'},
      {type:'role',id:'liturgist',label:'üïäÔ∏è Liturgist',group:'worship'},
      {type:'header',id:'h_enablers',label:'‚õ™ WORSHIP ENABLERS',cls:'',group:'all'},
      {type:'role',id:'usher1',label:'üö™ Usher 1',group:'all'},
      {type:'role',id:'usher2',label:'üö™ Usher 2',group:'all'},
      {type:'role',id:'reader1',label:'üìñ Reader 1',group:'all'},
      {type:'role',id:'reader2',label:'üìñ Reader 2',group:'all'},
      {type:'header',id:'h_scripture',label:'üìñ SCRIPTURE READINGS',cls:'scripture-section',group:'all'},
      {type:'scripture',id:'reading1',label:'üìú 1st Reading',group:'all'},
      {type:'scripture',id:'psalm',label:'üéµ Psalm',group:'all'},
      {type:'scripture',id:'reading2',label:'üìú 2nd Reading',group:'all'},
      {type:'scripture',id:'gospel',label:'‚úùÔ∏è Gospel',group:'all'},
      {type:'header',id:'h_communion',label:'üçû HOLY COMMUNION',cls:'communion-section',group:'all'},
      {type:'role',id:'communion1',label:'üçû Communion 1',group:'all'},
      {type:'role',id:'communion2',label:'üçû Communion 2',group:'all'},
      {type:'role',id:'altar1',label:'üïØÔ∏è Altar Guild 1',group:'all'},
      {type:'role',id:'altar2',label:'üïØÔ∏è Altar Guild 2',group:'all'},
      {type:'header',id:'h_music',label:'üéµ MUSIC MINISTRY',cls:'music-section',group:'worship'},
      {type:'role',id:'pianist',label:'üéπ Pianist',group:'worship'},
      {type:'role',id:'guitarist',label:'üé∏ Guitarist',group:'worship'},
      {type:'role',id:'bassist',label:'üé∏ Bassist',group:'worship'},
      {type:'role',id:'drummer',label:'ü•Å Drummer',group:'worship'},
      {type:'role',id:'singer1',label:'üé§ Singer 1',group:'worship'},
      {type:'role',id:'singer2',label:'üé§ Singer 2',group:'worship'},
      {type:'role',id:'singer3',label:'üé§ Singer 3',group:'worship'},
      {type:'role',id:'singer4',label:'üé§ Singer 4',group:'worship'},
      {type:'header',id:'h_tech',label:'üé¨ TECH TEAM',cls:'tech-section',group:'worship'},
      {type:'role',id:'lcd',label:'üíª LCD Operator',group:'worship'},
      {type:'role',id:'streaming',label:'üìπ Live Streaming',group:'all'},
      {type:'role',id:'pa',label:'üîä PA System',group:'all'}
    ],

    getSpecialDays: function(year, month) {
      var specialDays = [];
      var self = this;
      var easter = this.calculateEaster(year);
      
      // Ash Wednesday (46 days before Easter)
      var ashWed = new Date(easter); ashWed.setDate(ashWed.getDate() - 46);
      if (ashWed.getMonth() === month) {
        specialDays.push({date:ashWed, name:'Ash Wednesday', displayName:'ASH WED (' + self.MONTHS_SHORT[ashWed.getMonth()] + ' ' + ashWed.getDate() + ')', color:'Purple', type:'special'});
      }
      
      // Maundy Thursday (3 days before Easter)
      var maundyThu = new Date(easter); maundyThu.setDate(maundyThu.getDate() - 3);
      if (maundyThu.getMonth() === month) {
        specialDays.push({date:maundyThu, name:'Maundy Thursday', displayName:'MAUNDY THU (' + self.MONTHS_SHORT[maundyThu.getMonth()] + ' ' + maundyThu.getDate() + ')', color:'White', type:'special'});
      }
      
      // Good Friday (2 days before Easter)
      var goodFri = new Date(easter); goodFri.setDate(goodFri.getDate() - 2);
      if (goodFri.getMonth() === month) {
        specialDays.push({date:goodFri, name:'Good Friday', displayName:'GOOD FRI (' + self.MONTHS_SHORT[goodFri.getMonth()] + ' ' + goodFri.getDate() + ')', color:'Red', type:'special'});
      }
      
      // Easter Sunday
      if (easter.getMonth() === month) {
        specialDays.push({date:easter, name:'Easter Sunday', displayName:'EASTER (' + self.MONTHS_SHORT[easter.getMonth()] + ' ' + easter.getDate() + ')', color:'White', type:'special'});
      }
      
      // Christmas Eve (Dec 24)
      if (month === 11) {
        specialDays.push({date:new Date(year,11,24), name:'Christmas Eve', displayName:'CHRISTMAS EVE (Dec 24)', color:'White', type:'special'});
      }
      
      // Christmas Day (Dec 25)
      if (month === 11) {
        specialDays.push({date:new Date(year,11,25), name:'Christmas Day', displayName:'CHRISTMAS DAY (Dec 25)', color:'White', type:'special'});
      }
      
      return specialDays;
    },

    calculateEaster: function(year) {
      var a = year % 19;
      var b = Math.floor(year / 100);
      var c = year % 100;
      var d = Math.floor(b / 4);
      var e = b % 4;
      var f = Math.floor((b + 8) / 25);
      var g = Math.floor((b - f + 1) / 3);
      var h = (19 * a + b - d - g + 15) % 30;
      var i = Math.floor(c / 4);
      var k = c % 4;
      var l = (32 + 2 * e + 2 * i - h - k) % 7;
      var m = Math.floor((a + 11 * h + 22 * l) / 451);
      var month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
      var day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(year, month, day);
    },

    getServiceDays: function(year, month) {
      var days = [];
      var self = this;
      var date = new Date(year, month, 1);
      while (date.getDay() !== 0) date.setDate(date.getDate() + 1);
      
      // Get all Sundays in this month
      while (date.getMonth() === month) {
        days.push({date:new Date(date), dateStr:this.MONTHS_SHORT[month]+' '+date.getDate(), name:null, displayName:this.MONTHS_SHORT[month].toUpperCase()+' '+date.getDate(), color:this.DEFAULT_COLORS[month]||'Green', type:'sunday'});
        date.setDate(date.getDate() + 7);
      }
      
      // For December, check if Dec 31 is a Sunday and we haven't included it
      if (month === 11) {
        var dec31 = new Date(year, 11, 31);
        if (dec31.getDay() === 0) {
          var hasIt = days.some(function(d) { return d.date.getDate() === 31; });
          if (!hasIt) {
            days.push({date:dec31, dateStr:'Dec 31', name:null, displayName:'DEC 31', color:this.DEFAULT_COLORS[11]||'Purple', type:'sunday'});
          }
        }
      }
      
      var specialDays = this.getSpecialDays(year, month);
      specialDays.forEach(function(special) {
        var existingIdx = -1;
        days.forEach(function(d, idx) { if (d.date.getDate() === special.date.getDate()) existingIdx = idx; });
        if (existingIdx >= 0) {
          days[existingIdx].name = special.name;
          days[existingIdx].displayName = special.displayName;
          days[existingIdx].color = special.color;
          days[existingIdx].type = 'special';
        } else {
          days.push({date:special.date, dateStr:self.MONTHS_SHORT[month]+' '+special.date.getDate(), name:special.name, displayName:special.displayName, color:special.color, type:'special'});
        }
      });
      days.sort(function(a, b) { return a.date - b.date; });
      return days;
    },

    init: function() {
      var self = this;
      this.renderFilterButtons();
      this.renderMonthSelector();
      this.loadRosterData().then(function() {
        self.render();
        self.bindEvents();
        self.setupContextMenu();
      }).catch(function(err) {
        console.error('Failed to load roster data:', err);
        self.render();
        self.bindEvents();
        self.setupContextMenu();
      });
    },

    loadRosterData: function() {
      var self = this;
      console.log('Loading roster data for month=' + STATE.rosterMonth + ', year=' + STATE.rosterYear);
      return this.callGAS('getRosterData', [STATE.rosterMonth, STATE.rosterYear]).then(function(entries) {
        console.log('Received entries:', entries);
        if (!entries || !entries.length) { console.log('No entries found'); return; }
        entries.forEach(function(entry) {
          if (!entry.roleId || !entry.date) return;
          var key = entry.roleId + '__' + entry.date.replace(/\s/g, '_');
          console.log('Setting key:', key, '= value:', entry.value);
          var value = entry.value;
          try { var parsed = JSON.parse(value); if (parsed && typeof parsed === 'object') value = parsed; } catch(e) {}
          STATE.rosterEdits.set(key, value);
          if (entry.timestamp) STATE.rosterCellTimestamps.set(key, entry.timestamp);
        });
        console.log('Loaded ' + entries.length + ' roster entries, STATE.rosterEdits has ' + STATE.rosterEdits.size + ' entries');
      }).catch(function(err) { console.error('Error loading roster data:', err); });
    },

    renderMonthSelector: function() {
      var self = this;
      var monthTitle = document.getElementById('rosterMonthTitle');
      if (!monthTitle) return;
      var currentYear = new Date().getFullYear();
      var html = '<select id="rosterMonthDropdown" class="roster-month-select">';
      this.MONTHS.forEach(function(m, idx) {
        html += '<option value="' + idx + '"' + (idx === STATE.rosterMonth ? ' selected' : '') + '>' + m + '</option>';
      });
      html += '</select> <select id="rosterYearDropdown" class="roster-year-select">';
      for (var y = currentYear - 1; y <= currentYear + 2; y++) {
        html += '<option value="' + y + '"' + (y === STATE.rosterYear ? ' selected' : '') + '>' + y + '</option>';
      }
      html += '</select>';
      monthTitle.innerHTML = html;
      document.getElementById('rosterMonthDropdown').onchange = function() { STATE.rosterMonth = parseInt(this.value); self.onMonthYearChange(); };
      document.getElementById('rosterYearDropdown').onchange = function() { STATE.rosterYear = parseInt(this.value); self.onMonthYearChange(); };
    },

    onMonthYearChange: function() {
      var self = this;
      var seasonTitle = document.getElementById('rosterSeasonTitle');
      if (seasonTitle) seasonTitle.textContent = this.SEASONS[STATE.rosterMonth] || '';
      STATE.rosterEdits.clear();
      STATE.rosterCellTimestamps.clear();
      this.showLoader(true);
      this.loadRosterData().then(function() { self.render(); }).catch(function(err) { console.error('Failed:', err); self.render(); }).finally(function() { self.showLoader(false); });
    },

    renderFilterButtons: function() {
      var container = document.getElementById('rosterFilterContainer');
      if (!container) return;
      container.innerHTML = '<button class="roster-filter-btn ' + (STATE.rosterFilter === 'all' ? 'active' : '') + '" data-filter="all">All Roles</button><button class="roster-filter-btn ' + (STATE.rosterFilter === 'worship' ? 'active' : '') + '" data-filter="worship">Worship Team</button>';
      var self = this;
      container.querySelectorAll('.roster-filter-btn').forEach(function(btn) {
        btn.onclick = function() {
          container.querySelectorAll('.roster-filter-btn').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          STATE.rosterFilter = btn.dataset.filter;
          self.render();
        };
      });
    },

    getFilteredRoles: function() {
      if (STATE.rosterFilter === 'all') return this.ROLES;
      return this.ROLES.filter(function(role) { return role.group === 'worship' || role.id === 'h_music' || role.id === 'h_tech'; });
    },

    render: function() {
      var self = this;
      var serviceDays = this.getServiceDays(STATE.rosterYear, STATE.rosterMonth);
      var roles = this.getFilteredRoles();
      var seasonTitle = document.getElementById('rosterSeasonTitle');
      var syncStatus = document.getElementById('rosterSyncStatus');
      if (seasonTitle) seasonTitle.textContent = this.SEASONS[STATE.rosterMonth] || '';
      if (syncStatus) syncStatus.textContent = 'Last synced: ' + new Date().toLocaleTimeString();

      var thead = document.getElementById('rosterThead');
      if (thead) {
        var headerHtml = '<th>üè† DUTIES</th>';
        serviceDays.forEach(function(day) {
          var specialClass = day.type === 'special' ? 'roster-special-day' : '';
          var fullDate = day.dateStr + ' ' + STATE.rosterYear;
          headerHtml += '<th class="roster-date-header ' + specialClass + '">';
          headerHtml += '<div class="roster-date-chip roster-date-link" data-date="' + self.escapeHtml(fullDate) + '" data-name="' + self.escapeHtml(day.name || day.dateStr) + '" title="Click to open/create Worship Order">' + day.displayName + '</div>';
          headerHtml += '<button class="roster-share-btn" data-date="' + self.escapeHtml(day.dateStr) + '" data-name="' + self.escapeHtml(day.name || day.dateStr) + '" title="Share via WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>';
          headerHtml += '</th>';
        });
        thead.innerHTML = headerHtml;
      }

      var tbody = document.getElementById('rosterTbody');
      if (!tbody) return;
      var bodyHtml = '';
      roles.forEach(function(role) {
        if (role.type === 'header') {
          bodyHtml += '<tr class="roster-section-header ' + (role.cls || '') + '"><td colspan="' + (serviceDays.length + 1) + '" class="roster-section-cell">' + self.escapeHtml(role.label) + '</td></tr>';
        } else {
          var rowClass = role.type === 'liturgical' ? 'roster-liturgical-row' : (role.type === 'scripture' ? 'roster-scripture-row' : '');
          bodyHtml += '<tr class="' + rowClass + '"><td>' + self.escapeHtml(role.label) + '</td>';
          serviceDays.forEach(function(day, idx) {
            var cellKey = role.id + '__' + day.dateStr.replace(/\s/g, '_');
            var savedValue = STATE.rosterEdits.get(cellKey);
            var timestamp = STATE.rosterCellTimestamps.get(cellKey) || '';
            if (role.type === 'liturgical') {
              var color = (savedValue && savedValue.color) ? savedValue.color : day.color;
              var dayText = (savedValue && savedValue.day) ? savedValue.day : (day.name || self.getDefaultDayText(STATE.rosterMonth, idx));
              var colorHex = self.COLORS[color] || self.COLORS.Green;
              var borderStyle = color === 'White' ? 'border: 1px solid #cbd5e1;' : '';
              bodyHtml += '<td data-key="' + self.escapeHtml(cellKey) + '" data-role="' + role.id + '" data-date="' + self.escapeHtml(day.dateStr) + '" data-color="' + color + '" data-timestamp="' + self.escapeHtml(timestamp) + '" class="' + (savedValue ? 'roster-cell-edited' : '') + '"><span class="altar-color-dot" style="background:' + colorHex + ';' + borderStyle + '" title="Click to change color"></span><span class="liturgical-text">' + self.escapeHtml(dayText) + '</span></td>';
            } else {
              var value = savedValue || 'TBD';
              bodyHtml += '<td data-key="' + self.escapeHtml(cellKey) + '" data-role="' + role.id + '" data-date="' + self.escapeHtml(day.dateStr) + '" data-timestamp="' + self.escapeHtml(timestamp) + '" class="' + (savedValue ? 'roster-cell-edited' : '') + '">' + self.escapeHtml(value) + '</td>';
            }
          });
          bodyHtml += '</tr>';
        }
      });
      tbody.innerHTML = bodyHtml;
      this.bindCellEvents();
    },

    getDefaultDayText: function(month, idx) {
      var ordinals = ['1st','2nd','3rd','4th','5th','6th'];
      return (ordinals[idx] || ((idx+1)+'th')) + ' Sunday - ' + (this.SEASONS[month] || 'Ordinary Time');
    },

    bindEvents: function() {
      var self = this;
      var prevBtn = document.getElementById('rosterPrevMonthBtn');
      var nextBtn = document.getElementById('rosterNextMonthBtn');
      var saveBtn = document.getElementById('rosterSaveBtn');
      var csvBtn = document.getElementById('rosterDownloadCSVBtn');
      var pdfBtn = document.getElementById('rosterDownloadPDFBtn');
      if (prevBtn) prevBtn.onclick = function() { self.changeMonth(-1); };
      if (nextBtn) nextBtn.onclick = function() { self.changeMonth(1); };
      if (saveBtn) saveBtn.onclick = function() { self.saveChanges(); };
      if (csvBtn) csvBtn.onclick = function() { self.downloadCSV(); };
      if (pdfBtn) pdfBtn.onclick = function() { self.downloadPDF(); };
    },

    bindCellEvents: function() {
      var self = this;
      var tbody = document.getElementById('rosterTbody');
      if (!tbody) return;
      tbody.querySelectorAll('td[data-key]').forEach(function(td) {
        td.ondblclick = function() { self.editCell(td); };
        td.oncontextmenu = function(e) { e.preventDefault(); self.showContextMenu(e, td); };
      });
      tbody.querySelectorAll('.altar-color-dot').forEach(function(dot) {
        dot.onclick = function(e) { e.stopPropagation(); var td = dot.closest('td'); if (td) self.cycleColor(td); };
      });
      var thead = document.getElementById('rosterThead');
      if (thead) {
        thead.querySelectorAll('.roster-share-btn').forEach(function(btn) {
          btn.onclick = function(e) { e.stopPropagation(); self.shareWeekly(btn.getAttribute('data-date'), btn.getAttribute('data-name')); };
        });
        // Bind date link clicks to open/create worship orders
        thead.querySelectorAll('.roster-date-link').forEach(function(link) {
          link.onclick = function(e) {
            e.stopPropagation();
            var dateStr = link.getAttribute('data-date');
            var dateName = link.getAttribute('data-name');
            self.openOrCreateOrder(dateStr, dateName);
          };
        });
      }
    },

    openOrCreateOrder: function(dateStr, dateName) {
      // Switch to Orders view and either open existing or create new
      if (typeof setActiveView === 'function') {
        setActiveView('worshipOrderView');
      }
      
      // Try to find existing order or create new one
      var orderTitle = dateName + ' - ' + dateStr;
      
      // Set the create order modal fields
      var orderTitleInput = document.getElementById('orderTitle');
      var orderDateInput = document.getElementById('orderDate');
      
      if (orderTitleInput) {
        orderTitleInput.value = orderTitle;
      }
      
      // Parse date and set date input
      if (orderDateInput && dateStr) {
        try {
          var parts = dateStr.match(/([A-Za-z]+)\s*(\d+)\s*(\d{4})?/);
          if (parts) {
            var months = {'jan':0,'feb':1,'mar':2,'apr':3,'may':4,'jun':5,'jul':6,'aug':7,'sep':8,'oct':9,'nov':10,'dec':11};
            var month = months[parts[1].toLowerCase().substring(0,3)];
            var day = parseInt(parts[2]);
            var year = parts[3] ? parseInt(parts[3]) : STATE.rosterYear;
            if (!isNaN(month) && !isNaN(day)) {
              var isoDate = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
              orderDateInput.value = isoDate;
            }
          }
        } catch(e) {
          console.log('Could not parse date:', dateStr);
        }
      }
      
      // Open the create order modal
      var modal = document.getElementById('createOrderModal');
      if (modal) {
        modal.classList.add('show');
      }
      
      this.showToast('Creating order for ' + dateName, 'success');
    },

    setupContextMenu: function() {
      var self = this;
      var menu = document.getElementById('rosterContextMenu');
      document.addEventListener('click', function() { if (menu) menu.classList.remove('show'); });
      var editBtn = document.getElementById('ctxEditCell');
      var clearBtn = document.getElementById('ctxClearCell');
      var changeLogBtn = document.getElementById('ctxSeeChangeLog');
      if (editBtn) editBtn.onclick = function() { if (self._contextCell) self.editCell(self._contextCell); menu.classList.remove('show'); };
      if (clearBtn) clearBtn.onclick = function() { if (self._contextCell) self.clearCell(self._contextCell); menu.classList.remove('show'); };
      if (changeLogBtn) changeLogBtn.onclick = function() { 
        if (self._contextCell) {
          var roleId = self._contextCell.getAttribute('data-role');
          var dateKey = self._contextCell.getAttribute('data-key');
          self.highlightChangeLogInSidebar(roleId, dateKey);
        }
        menu.classList.remove('show'); 
      };
    },
    
    highlightChangeLogInSidebar: function(roleId, dateKey) {
      // Find matching item in roster updates sidebar
      var container = document.getElementById('rosterUpdatesContainer');
      if (!container) return;
      
      // Remove previous highlights
      container.querySelectorAll('.roster-update-highlight').forEach(function(el) {
        el.classList.remove('roster-update-highlight');
      });
      
      // Extract date from dateKey (format: roleId__Jan_4)
      var dateParts = dateKey ? dateKey.split('__') : [];
      var dateFromKey = dateParts.length > 1 ? dateParts[1].replace(/_/g, ' ') : '';
      
      // Find item with matching role AND date
      var items = container.querySelectorAll('.roster-update-item');
      var found = false;
      items.forEach(function(item) {
        var itemRole = item.getAttribute('data-role');
        var itemDate = item.getAttribute('data-date');
        
        // Match both role and date
        var roleMatches = itemRole && roleId && itemRole.toLowerCase() === roleId.toLowerCase();
        var dateMatches = itemDate && dateFromKey && itemDate.toLowerCase().replace(/\s/g, '') === dateFromKey.toLowerCase().replace(/\s/g, '');
        
        if (roleMatches && dateMatches) {
          item.classList.add('roster-update-highlight');
          item.scrollIntoView({ behavior: 'smooth', block: 'center' });
          found = true;
          
          // Remove highlight after 3 seconds
          setTimeout(function() {
            item.classList.remove('roster-update-highlight');
          }, 3000);
        }
      });
      
      if (!found) {
        this.showToast('No change log found for this cell in recent updates', 'warning');
      }
    },

    showContextMenu: function(e, td) {
      var self = this;
      var menu = document.getElementById('rosterContextMenu');
      if (!menu) return;
      this._contextCell = td;
      var x = e.clientX, y = e.clientY;
      if (x + 200 > window.innerWidth) x = window.innerWidth - 210;
      if (y + 220 > window.innerHeight) y = window.innerHeight - 230;
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      var timestamp = td.getAttribute('data-timestamp');
      var lastEditedEl = document.getElementById('ctxLastEdited');
      if (lastEditedEl) {
        if (timestamp) {
          var d = new Date(timestamp);
          lastEditedEl.innerHTML = '<i class="fa-solid fa-clock mr-1"></i> Last edited: ' + d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
        } else {
          lastEditedEl.innerHTML = '<i class="fa-solid fa-clock mr-1"></i> Last edited: Never';
        }
      }
      
      // Fetch and show history
      var historySection = document.getElementById('ctxHistorySection');
      var historyList = document.getElementById('ctxHistoryList');
      if (historySection && historyList) {
        historySection.classList.add('hidden');
        var roleId = td.getAttribute('data-role');
        var dateStr = td.getAttribute('data-date');
        if (roleId && dateStr) {
          this.callGAS('getRosterHistory', [roleId, dateStr]).then(function(entries) {
            if (entries && entries.length > 0) {
              historySection.classList.remove('hidden');
              var html = '';
              entries.forEach(function(entry) {
                var dateDisplay = '';
                if (entry.timestamp) {
                  try { var d = new Date(entry.timestamp); dateDisplay = d.toLocaleDateString(); } catch(e) {}
                }
                html += '<div class="history-item" data-value="' + self.escapeHtml(entry.value) + '">' + self.escapeHtml(entry.value || 'Empty');
                if (dateDisplay) html += '<span class="history-date">' + dateDisplay + '</span>';
                html += '</div>';
              });
              historyList.innerHTML = html;
              historyList.querySelectorAll('.history-item').forEach(function(item) {
                item.onclick = function() {
                  var val = item.getAttribute('data-value');
                  if (val && self._contextCell) {
                    self._contextCell.textContent = val;
                    var key = self._contextCell.getAttribute('data-key');
                    STATE.rosterEdits.set(key, val);
                    STATE.rosterCellTimestamps.set(key, new Date().toISOString());
                    self._contextCell.setAttribute('data-timestamp', new Date().toISOString());
                    self._contextCell.classList.add('roster-cell-edited');
                    self.markUnsaved();
                    menu.classList.remove('show');
                  }
                };
              });
            }
          }).catch(function(err) { console.error('History error:', err); });
        }
      }
      
      menu.classList.add('show');
    },

    clearCell: function(td) {
      var key = td.getAttribute('data-key');
      var isLiturgical = td.closest('tr') && td.closest('tr').classList.contains('roster-liturgical-row');
      STATE.rosterEdits.delete(key);
      STATE.rosterCellTimestamps.delete(key);
      td.removeAttribute('data-timestamp');
      td.classList.remove('roster-cell-edited');
      if (isLiturgical) {
        var color = this.DEFAULT_COLORS[STATE.rosterMonth] || 'Green';
        td.setAttribute('data-color', color);
        var colorHex = this.COLORS[color];
        td.innerHTML = '<span class="altar-color-dot" style="background:' + colorHex + ';" title="Click to change color"></span><span class="liturgical-text">' + this.getDefaultDayText(STATE.rosterMonth, 0) + '</span>';
      } else {
        td.textContent = 'TBD';
      }
      this.markUnsaved();
      this.bindCellEvents();
    },

    changeMonth: function(direction) {
      STATE.rosterMonth += direction;
      if (STATE.rosterMonth > 11) { STATE.rosterMonth = 0; STATE.rosterYear++; }
      else if (STATE.rosterMonth < 0) { STATE.rosterMonth = 11; STATE.rosterYear--; }
      var monthDD = document.getElementById('rosterMonthDropdown');
      var yearDD = document.getElementById('rosterYearDropdown');
      if (monthDD) monthDD.value = STATE.rosterMonth;
      if (yearDD) yearDD.value = STATE.rosterYear;
      this.onMonthYearChange();
    },

    editCell: function(td) {
      var self = this;
      if (td.querySelector('input') || td.querySelector('select')) return;
      var row = td.closest('tr');
      var isLiturgical = row && row.classList.contains('roster-liturgical-row');
      var isScripture = row && row.classList.contains('roster-scripture-row');
      var key = td.getAttribute('data-key');
      var roleId = key ? key.split('__')[0] : '';
      var currentValue = '';

      if (isLiturgical) {
        var textSpan = td.querySelector('.liturgical-text');
        currentValue = textSpan ? textSpan.textContent : '';
      } else {
        currentValue = td.textContent.trim();
        if (currentValue === 'TBD') currentValue = '';
      }
      var originalHtml = td.innerHTML;

      // Use text input for liturgical and scripture rows
      if (isLiturgical || isScripture) {
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'roster-inline-editor';
        input.value = currentValue;
        if (isLiturgical) {
          var dot = td.querySelector('.altar-color-dot');
          td.innerHTML = '';
          if (dot) td.appendChild(dot.cloneNode(true));
          td.appendChild(input);
        } else {
          td.innerHTML = '';
          td.appendChild(input);
        }
        input.focus();
        input.select();
        var saveInput = function() {
          var newValue = input.value.trim();
          var timestamp = new Date().toISOString();
          if (isLiturgical) {
            var color = td.getAttribute('data-color') || 'Green';
            STATE.rosterEdits.set(key, { day: newValue || self.getDefaultDayText(STATE.rosterMonth, 0), color: color });
            var colorHex = self.COLORS[color] || self.COLORS.Green;
            var borderStyle = color === 'White' ? 'border: 1px solid #cbd5e1;' : '';
            td.innerHTML = '<span class="altar-color-dot" style="background:' + colorHex + ';' + borderStyle + '" title="Click to change color"></span><span class="liturgical-text">' + self.escapeHtml(newValue || self.getDefaultDayText(STATE.rosterMonth, 0)) + '</span>';
          } else {
            STATE.rosterEdits.set(key, newValue || 'TBD');
            td.textContent = newValue || 'TBD';
          }
          STATE.rosterCellTimestamps.set(key, timestamp);
          td.setAttribute('data-timestamp', timestamp);
          td.classList.add('roster-cell-edited');
          self.markUnsaved();
          self.bindCellEvents();
        };
        var cancelInput = function() { td.innerHTML = originalHtml; self.bindCellEvents(); };
        input.onkeydown = function(e) { if (e.key === 'Enter') { e.preventDefault(); saveInput(); } if (e.key === 'Escape') { e.preventDefault(); cancelInput(); } };
        input.onblur = function() { setTimeout(saveInput, 100); };
        return;
      }

      // Use dropdown for role cells
      var category = getRoleCategory(roleId);
      var names = ROSTER_NAME_OPTIONS[category] || ROSTER_NAME_OPTIONS.general || [];

      var container = document.createElement('div');
      container.className = 'roster-dropdown-container';
      container.style.cssText = 'position:relative;width:100%;';

      var select = document.createElement('select');
      select.className = 'roster-inline-select';
      select.style.cssText = 'width:100%;padding:4px 6px;border:2px solid #4a6da7;border-radius:6px;font-size:13px;background:#fff;cursor:pointer;';

      // Add empty/TBD option
      var emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '-- Select --';
      select.appendChild(emptyOpt);

      // Add name options
      names.forEach(function(name) {
        var opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === currentValue) opt.selected = true;
        select.appendChild(opt);
      });

      // If current value exists but not in list, add it
      if (currentValue && !names.includes(currentValue)) {
        var currentOpt = document.createElement('option');
        currentOpt.value = currentValue;
        currentOpt.textContent = currentValue;
        currentOpt.selected = true;
        select.appendChild(currentOpt);
      }

      // Add "Add new name" option
      var addNewOpt = document.createElement('option');
      addNewOpt.value = '__ADD_NEW__';
      addNewOpt.textContent = '+ Add new name...';
      addNewOpt.style.cssText = 'font-style:italic;color:#4a6da7;';
      select.appendChild(addNewOpt);

      td.innerHTML = '';
      container.appendChild(select);
      td.appendChild(container);
      select.focus();

      var saveSelect = function(newValue) {
        var timestamp = new Date().toISOString();
        STATE.rosterEdits.set(key, newValue || 'TBD');
        td.textContent = newValue || 'TBD';
        STATE.rosterCellTimestamps.set(key, timestamp);
        td.setAttribute('data-timestamp', timestamp);
        td.classList.add('roster-cell-edited');
        self.markUnsaved();
        self.bindCellEvents();
      };

      var cancelSelect = function() { td.innerHTML = originalHtml; self.bindCellEvents(); };

      var showAddNewInput = function() {
        container.innerHTML = '';
        var inputWrapper = document.createElement('div');
        inputWrapper.style.cssText = 'display:flex;gap:4px;';

        var newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.placeholder = 'Enter new name';
        newInput.className = 'roster-inline-editor';
        newInput.style.cssText = 'flex:1;padding:4px 6px;border:2px solid #4a6da7;border-radius:6px;font-size:13px;';

        var addBtn = document.createElement('button');
        addBtn.textContent = '+';
        addBtn.style.cssText = 'padding:4px 8px;background:#4a6da7;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;';

        var cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'x';
        cancelBtn.style.cssText = 'padding:4px 8px;background:#e5e7eb;color:#333;border:none;border-radius:6px;cursor:pointer;';

        inputWrapper.appendChild(newInput);
        inputWrapper.appendChild(addBtn);
        inputWrapper.appendChild(cancelBtn);
        container.appendChild(inputWrapper);
        newInput.focus();

        var confirmAdd = function() {
          var newName = newInput.value.trim();
          if (newName) {
            addNameToRole(category, newName);
            saveSelect(newName);
          } else {
            cancelSelect();
          }
        };

        addBtn.onclick = function(e) { e.stopPropagation(); confirmAdd(); };
        cancelBtn.onclick = function(e) { e.stopPropagation(); cancelSelect(); };
        newInput.onkeydown = function(e) {
          if (e.key === 'Enter') { e.preventDefault(); confirmAdd(); }
          if (e.key === 'Escape') { e.preventDefault(); cancelSelect(); }
        };
      };

      select.onchange = function() {
        var val = select.value;
        if (val === '__ADD_NEW__') {
          showAddNewInput();
        } else {
          saveSelect(val);
        }
      };

      select.onkeydown = function(e) {
        if (e.key === 'Escape') { e.preventDefault(); cancelSelect(); }
      };

      select.onblur = function(e) {
        // Don't close if clicking on add new input
        setTimeout(function() {
          if (!container.querySelector('input')) {
            var val = select.value;
            if (val !== '__ADD_NEW__') {
              saveSelect(val);
            }
          }
        }, 150);
      };
    },

    cycleColor: function(td) {
      var currentColor = td.getAttribute('data-color') || 'Green';
      var nextIndex = (this.COLOR_NAMES.indexOf(currentColor) + 1) % this.COLOR_NAMES.length;
      var nextColor = this.COLOR_NAMES[nextIndex];
      td.setAttribute('data-color', nextColor);
      var dot = td.querySelector('.altar-color-dot');
      if (dot) {
        dot.style.background = this.COLORS[nextColor];
        dot.style.border = nextColor === 'White' ? '1px solid #cbd5e1' : '';
      }
      var key = td.getAttribute('data-key');
      var textSpan = td.querySelector('.liturgical-text');
      var dayText = textSpan ? textSpan.textContent : '';
      var timestamp = new Date().toISOString();
      STATE.rosterEdits.set(key, { day: dayText, color: nextColor });
      STATE.rosterCellTimestamps.set(key, timestamp);
      td.setAttribute('data-timestamp', timestamp);
      td.classList.add('roster-cell-edited');
      this.markUnsaved();
    },

    markUnsaved: function() {
      STATE.rosterHasUnsaved = true;
      var indicator = document.getElementById('rosterUnsavedIndicator');
      if (indicator) indicator.classList.remove('hidden');
    },

    clearUnsaved: function() {
      STATE.rosterHasUnsaved = false;
      var indicator = document.getElementById('rosterUnsavedIndicator');
      if (indicator) indicator.classList.add('hidden');
    },

    saveChanges: function() {
      var self = this;
      if (!STATE.rosterEdits.size) { this.showToast('No changes to save', 'warning'); return; }
      var edits = [];
      STATE.rosterEdits.forEach(function(value, key) {
        var parts = key.split('__');
        edits.push({ roleId: parts[0], date: parts[1].replace(/_/g, ' '), value: typeof value === 'object' ? JSON.stringify(value) : value, month: STATE.rosterMonth, year: STATE.rosterYear, timestamp: STATE.rosterCellTimestamps.get(key) || '' });
      });
      this.showLoader(true);
      this.callGAS('saveRosterEdits', [edits]).then(function() {
        self.showToast('Changes saved successfully!', 'success');
        self.clearUnsaved();
        var syncStatus = document.getElementById('rosterSyncStatus');
        if (syncStatus) syncStatus.textContent = 'Last synced: ' + new Date().toLocaleTimeString();
      }).catch(function(err) { console.error('Save error:', err); self.showToast('Failed to save changes', 'error'); }).finally(function() { self.showLoader(false); });
    },

    downloadCSV: function() {
      var self = this;
      var serviceDays = this.getServiceDays(STATE.rosterYear, STATE.rosterMonth);
      var headers = serviceDays.map(function(d) { return d.name || d.dateStr; });
      var csv = 'Worship Duty,' + headers.join(',') + '\n';
      this.ROLES.filter(function(r) { return r.type !== 'header'; }).forEach(function(role) {
        var rowData = [role.label];
        serviceDays.forEach(function(day, idx) {
          var key = role.id + '__' + day.dateStr.replace(/\s/g, '_');
          var saved = STATE.rosterEdits.get(key);
          var value = 'TBD';
          if (role.type === 'liturgical') value = (saved && saved.day) ? saved.day : (day.name || self.getDefaultDayText(STATE.rosterMonth, idx));
          else value = saved || 'TBD';
          rowData.push('"' + String(value).replace(/"/g, '""') + '"');
        });
        csv += rowData.join(',') + '\n';
      });
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'LHC_Roster_' + this.MONTHS[STATE.rosterMonth] + '_' + STATE.rosterYear + '.csv';
      link.click();
      this.showToast('CSV downloaded!', 'success');
    },

    downloadPDF: function() { window.print(); this.showToast('Print dialog opened', 'success'); },

    shareWeekly: function(dateStr, dateName) {
      var self = this;
      var serviceDays = this.getServiceDays(STATE.rosterYear, STATE.rosterMonth);
      var dayInfo = serviceDays.find(function(d) { return d.dateStr === dateStr; });
      var displayName = dateName || (dayInfo && dayInfo.name) || dateStr;
      var fullDate = dayInfo ? dayInfo.date : new Date();
      var dayOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][fullDate.getDay()];
      var formattedDate = dayOfWeek + ', ' + this.MONTHS[fullDate.getMonth()] + ' ' + fullDate.getDate() + ', ' + fullDate.getFullYear();
      
      var lines = [
        'üèõ *LUTHER HOUSE CHAPEL* *Worship Enablers*',
        'üìÖ ' + formattedDate,
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ'
      ];
      
      // Helper to get value for a role
      var getValue = function(roleId) {
        var key = roleId + '__' + dateStr.replace(/\s/g, '_');
        return STATE.rosterEdits.get(key) || '';
      };
      
      // Helper to add role line with padding
      var addRole = function(label, roleId) {
        var value = getValue(roleId);
        if (value && value !== 'TBD') {
          // Pad label to align values
          var paddedLabel = label + ':';
          while (paddedLabel.length < 22) paddedLabel += ' ';
          lines.push('‚Ä¢ *' + label + ':*' + '              '.substring(0, 22 - label.length) + value);
        }
      };
      
      // Preacher & Liturgist
      addRole('Preacher', 'preacher');
      addRole('Liturgist', 'liturgist');
      
      // Ushers (if any filled)
      var hasUshers = getValue('usher1') || getValue('usher2');
      if (hasUshers) {
        lines.push('');
        addRole('Usher 1', 'usher1');
        addRole('Usher 2', 'usher2');
      }
      
      // Readers
      var hasReaders = getValue('reader1') || getValue('reader2');
      if (hasReaders) {
        lines.push('');
        addRole('Reader 1', 'reader1');
        addRole('Reader 2', 'reader2');
      }
      
      // Scripture Readings
      var hasScripture = getValue('reading1') || getValue('psalm') || getValue('reading2') || getValue('gospel');
      if (hasScripture) {
        lines.push('');
        addRole('1st Reading', 'reading1');
        addRole('Psalm', 'psalm');
        addRole('2nd Reading', 'reading2');
        addRole('Gospel', 'gospel');
      }
      
      // Communion & Altar
      var hasCommunion = getValue('communion1') || getValue('communion2') || getValue('altar1') || getValue('altar2');
      if (hasCommunion) {
        lines.push('');
        addRole('Communion 1', 'communion1');
        addRole('Communion 2', 'communion2');
        addRole('Altar Guild 1', 'altar1');
        addRole('Altar Guild 2', 'altar2');
      }
      
      // Music Ministry
      var hasMusic = getValue('pianist') || getValue('guitarist') || getValue('bassist') || getValue('drummer') || getValue('singer1') || getValue('singer2') || getValue('singer3') || getValue('singer4');
      if (hasMusic) {
        lines.push('');
        addRole('Pianist', 'pianist');
        addRole('Guitarist', 'guitarist');
        addRole('Bassist', 'bassist');
        addRole('Drummer', 'drummer');
        addRole('Singer 1', 'singer1');
        addRole('Singer 2', 'singer2');
        addRole('Singer 3', 'singer3');
        addRole('Singer 4', 'singer4');
      }
      
      // Tech Team
      var hasTech = getValue('lcd') || getValue('streaming') || getValue('pa');
      if (hasTech) {
        lines.push('');
        addRole('LCD Operator', 'lcd');
        addRole('Live Streaming', 'streaming');
        addRole('PA System', 'pa');
      }
      
      lines.push('');
      lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      lines.push('_Sent from LHC Worship Prep_');
      
      var waUrl = 'https://wa.me/?text=' + encodeURIComponent(lines.join('\n'));
      window.open(waUrl, '_blank');
    },

    escapeHtml: function(str) { if (str == null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); },
    showToast: function(message, type) { var el = document.getElementById('toastNotification'); if (!el) return; el.textContent = message; el.className = 'toast-notification show ' + (type || ''); clearTimeout(this._toastTimer); this._toastTimer = setTimeout(function() { el.classList.remove('show'); }, 3500); },
    showLoader: function(show) { var el = document.getElementById('loadingIndicator'); if (el) el.classList.toggle('show', show); },
    callGAS: function(functionName, args) { return new Promise(function(resolve, reject) { if (typeof google === 'undefined' || !google.script || !google.script.run) { reject(new Error('GAS not available')); return; } var runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject); if (typeof runner[functionName] !== 'function') { reject(new Error('Function not found: ' + functionName)); return; } runner[functionName].apply(runner, args || []); }); }
  };

  window.RosterEngine = RosterEngine;
})();
</script>

</body>
</html>